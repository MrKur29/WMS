<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>WMS Kurnia's Food - Supabase</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Supabase JS v2 -->
  <script src="https://unpkg.com/@sb/sb-js@2"></script>
  <!-- QR Scanner (kamera HP) -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
      color: #111827;
    }
    body {
      margin: 0;
      padding: 0;
      background: #f3f4f6;
    }
    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
      box-sizing: border-box;
    }
    h1, h2, h3 {
      margin-top: 0;
    }

    /* LOGIN PAGE */
    #login-page {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      box-sizing: border-box;
    }
    .login-card {
      background: #ffffff;
      border-radius: 8px;
      padding: 20px 16px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      width: 100%;
      max-width: 380px;
      box-sizing: border-box;
    }
    .login-card h2 {
      margin: 0 0 4px;
      font-size: 18px;
    }
    .login-sub {
      margin: 0 0 12px;
      font-size: 12px;
      color: #6b7280;
    }
    label {
      display: block;
      margin-top: 12px;
      margin-bottom: 4px;
      font-size: 0.9rem;
      color: #374151;
    }
    input[type="email"],
    input[type="password"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 0.95rem;
      box-sizing: border-box;
    }
    input:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37,99,235,0.15);
    }
    button {
      cursor: pointer;
      border-radius: 8px;
      border: none;
      padding: 10px 16px;
      font-size: 0.95rem;
    }
    .btn-primary {
      background: #2563eb;
      color: white;
    }
    .btn-primary:hover {
      background: #1d4ed8;
    }
    .btn-ghost {
      background: transparent;
      color: #e5e7eb;
      border: 1px solid transparent;
    }
    .btn-ghost:hover {
      background: #374151;
      border-color: #4b5563;
    }
    .btn-secondary {
      background: #c1272d;
      color: #fff;
    }
    .btn-secondary:hover {
      background: #a11f24;
    }
    .btn-block {
      width: 100%;
      margin-top: 12px;
    }
    .btn-sm {
      padding: 6px 10px;
      font-size: 0.8rem;
    }
    .btn-small {
      padding: 4px 8px;
      font-size: 12px;
    }
    .login-error {
      margin-top: 8px;
      font-size: 12px;
      color: #b91c1c;
    }

    /* APP LAYOUT */
    #app-page {
      display: none;
      min-height: 100vh;
    }
    .app-shell {
      display: grid;
      grid-template-columns: 220px 1fr;
      grid-template-rows: auto 1fr;
      grid-template-areas:
        "header header"
        "sidebar main";
      gap: 12px;
    }
    .app-header {
      grid-area: header;
      background: #111827;
      color: white;
      border-radius: 0 0 12px 12px;
      padding: 10px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      box-sizing: border-box;
    }
    .brand {
      font-weight: 600;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .brand span.logo-dot {
      width: 20px;
      height: 20px;
      border-radius: 999px;
      background: #ef4444;
      display: inline-block;
    }
    .user-info {
      font-size: 0.8rem;
      color: #e5e7eb;
      text-align: right;
    }

    .app-sidebar {
      grid-area: sidebar;
      background: #ffffff;
      border-radius: 12px;
      padding: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.04);
      display: flex;
      flex-direction: column;
      gap: 6px;
      box-sizing: border-box;
    }
    .menu-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: #4b5563;
      margin-bottom: 6px;
      margin-top: 4px;
    }
    .menu-btn {
      width: 100%;
      text-align: left;
      padding: 9px 10px;
      background: transparent;
      border-radius: 8px;
      border: none;
      font-size: 0.9rem;
      color: #374151;
    }
    .menu-btn:hover {
      background: #e5e7eb;
    }
    .menu-btn.active {
      background: #2563eb;
      color: white;
    }

    .app-main {
      grid-area: main;
      background: #ffffff;
      border-radius: 12px;
      padding: 14px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.04);
      min-height: 400px;
      box-sizing: border-box;
    }
    .badge-role {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #e5e7eb;
      color: #374151;
      margin-left: 4px;
    }
    .text-muted {
      color: #6b7280;
      font-size: 0.9rem;
    }

    .mobile-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    #btn-toggle-sidebar {
      display: none;
      border-radius: 999px;
      background: #1f2937;
      color: #e5e7eb;
      border: 1px solid #374151;
      padding: 6px 10px;
      font-size: 0.9rem;
    }
    #btn-toggle-sidebar:hover {
      background: #374151;
    }

    @media (max-width: 768px) {
      .page {
        padding: 8px;
      }
      .app-shell {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto 1fr;
        grid-template-areas:
          "header"
          "sidebar"
          "main";
      }
      .app-header {
        border-radius: 0 0 10px 10px;
        padding: 8px 10px;
      }
      .brand {
        font-size: 0.9rem;
      }
      #btn-toggle-sidebar {
        display: inline-flex;
      }
      .app-sidebar {
        margin-top: -4px;
      }
      .mobile-sidebar-collapsed .app-sidebar {
        display: none;
      }
    }

    /* FORM STYLES */
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 4px;
      box-sizing: border-box;
    }
    .section-title {
      font-weight: 600;
      margin-top: 16px;
      margin-bottom: 8px;
      color: #0b1f3b;
      border-left: 4px solid #c1272d;
      padding-left: 8px;
    }
    .field-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 8px;
    }
    .field {
      flex: 1 1 200px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    input[type="date"],
    input[type="text"],
    input[type="number"],
    select,
    textarea {
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #ccd2e2;
      font-size: 13px;
      box-sizing: border-box;
    }
    input[readonly] {
      background: #f0f2f7;
    }
    textarea {
      min-height: 60px;
      resize: vertical;
    }
    .small-note {
      font-size: 11px;
      color: #777;
    }
    .rak-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      margin-bottom: 8px;
    }
    .rak-table th,
    .rak-table td {
      border: 1px solid #dde3f0;
      padding: 4px;
      font-size: 13px;
      text-align: left;
    }
    .rak-table th {
      background: #f0f2f7;
    }
    .totals-box {
      background: #f9fafc;
      border-radius: 4px;
      padding: 8px;
      font-size: 13px;
      margin-top: 4px;
    }
    .totals-box strong {
      color: #c1272d;
    }
    .divider {
      margin: 16px 0;
      border-top: 1px dashed #dde3f0;
    }
    .status {
      margin-top: 8px;
      font-size: 13px;
    }
    .status.error {
      color: #c1272d;
    }
    .status.success {
      color: #0a7a2f;
    }
    .confirm-box {
      background: #fdf8ec;
      border-radius: 4px;
      padding: 10px;
      font-size: 13px;
      border: 1px solid #f5d38a;
      margin-top: 8px;
      white-space: pre-line;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 12px;
      color: #6b7280;
      gap: 8px;
      flex-wrap: wrap;
    }
  
    /* Batch ABF rackâ†’machine mapping */
    #tb-rak-mapping .rack-grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;}
    #tb-rak-mapping .rack-card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:10px;display:flex;align-items:center;justify-content:space-between;gap:10px;}
    #tb-rak-mapping .rack-card .rack-label{font-weight:700;font-size:13px;margin:0;color:#0f172a;}
    #tb-rak-mapping .rack-card select{width:120px;}
    @media (max-width: 640px){
      #tb-rak-mapping .rack-grid{grid-template-columns:repeat(2,minmax(0,1fr));}
      #tb-rak-mapping .rack-card{flex-direction:column;align-items:stretch;}
      #tb-rak-mapping .rack-card select{width:100%;}
    }
</style>
</head>
<body>

<!-- ========== LOGIN PAGE ========== -->
<div id="login-page">
  <div class="login-card">
    <h2>Login WMS</h2>
    <p class="login-sub">Masuk dengan email &amp; password Supabase.</p>

    <label for="loginEmail">Email</label>
    <input id="loginEmail" type="email" placeholder="you@example.com" />

    <label for="loginPassword">Password</label>
    <input id="loginPassword" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />

    <button id="loginBtn" class="btn-primary btn-block">Login</button>

    <div id="loginError" class="login-error"></div>
  </div>
</div>

<!-- ========== APP PAGE ========== -->
<div id="app-page">
  <div class="page">
    <div class="app-shell mobile-sidebar-collapsed" id="app-shell">
      <!-- HEADER -->
      <header class="app-header">
        <div class="mobile-left">
          <button id="btn-toggle-sidebar" class="btn-ghost btn-sm">â˜° Menu</button>
          <div class="brand">
            <span class="logo-dot"></span>
            <span>WMS &mdash; Kurnia's Food</span>
          </div>
        </div>
        <div>
          <div class="user-info" id="user-info"></div>
          <div style="text-align:right; margin-top:4px;">
            <button id="logout-btn" class="btn-ghost btn-sm">Logout</button>
          </div>
        </div>
      </header>

      <!-- SIDEBAR -->
      <aside class="app-sidebar">
        <div class="menu-title">Menu Transaksi</div>
        <button class="menu-btn" data-page="form-tambah-batch">Batch ABF</button>
        <button class="menu-btn" data-page="form-tambah-karung">Panen ABF</button>
        <button class="menu-btn" data-page="form-buat-karung-draft">Buat Karung Baru</button>
        <button class="menu-btn menu-supervisor-admin" data-page="form-revisi-karung" style="display:none;">Revisi Karung (ABF)</button>
        <button class="menu-btn" data-page="form-receipt-slip">Receipt Slip</button>
        <button class="menu-btn" data-page="form-pindah-lokasi">Form Pindah Pallet</button>
        <button class="menu-btn" data-page="form-input-pallet">Form Input Karung ke Pallet</button>
        
        <button class="menu-btn" data-page="form-gabung-karung">Form Gabung Karung</button>
        <button class="menu-btn" data-page="form-picking-slip">Picking Slip</button>

        <button class="menu-btn" data-page="riwayat-picking-slip">Riwayat Picking Slip</button>

        <div class="menu-title" style="margin-top:10px;">Menu Laporan</div>
        <button class="menu-btn" data-page="form-cek-karung">Cek Info Karung</button>
        <button class="menu-btn" data-page="laporan-stok">Laporan Stok Karung</button>
        <button class="menu-btn" data-page="laporan-stok-semua">Laporan Stok Semua Barang</button>
	      <button class="menu-btn" data-page="laporan-batch">Laporan Batch Pembekuan</button>
        <button class="menu-btn" data-page="laporan-mutasi">Laporan Mutasi / Log Karung</button>
      </aside>

      <!-- MAIN CONTENT -->
      <main class="app-main">
        <div id="content">
          <!-- DASHBOARD -->
          <div id="page-dashboard">
            <h2>Dashboard WMS</h2>
            <p class="text-muted">
              Selamat datang di sistem Warehouse Management (Supabase).<br/>
              Pilih menu di sebelah kiri atau tekan tombol <strong>â˜° Menu</strong> di header (jika di HP).
            </p>
          </div>

          <!-- FORM TAMBAH BATCH ABF -->
          <div id="page-form-tambah-batch" style="display:none;">
            <div class="container">
              <div class="top-bar">
                <div><strong>Form Tambah Batch Pembekuan (ABF)</strong></div>
                <div><span id="tb-userInfo"></span></div>
              </div>

              <div class="small-note">
                Batch ID otomatis mengikuti format: <b>BF-YYMMDD[shift]</b><br>
                Contoh: BF-2507021 untuk tanggal 2025-07-02 shift 1.
              </div>

              <div class="section-title">1. Data Batch</div>
              <div class="field-row">
                <div class="field">
                  <label for="tb-tgl-abf">Tanggal ABF</label>
                  <input type="date" id="tb-tgl-abf">
                </div>
                <div class="field">
                  <label for="tb-shift">Shift</label>
                  <select id="tb-shift">
                    <option value="">-- Pilih shift --</option>
                    <option value="1">Shift 1</option>
                    <option value="2">Shift 2</option>
                    <option value="3">Shift 3</option>
                  </select>
                </div>
              </div>

              <div class="section-title">2. Generate Batch ID</div>
              <button type="button" class="btn btn-secondary btn-small" id="tb-generate-btn">
                Generate Batch ID
              </button>

              <div class="field" style="margin-top:10px;">
                <label for="tb-batch-id">Batch ID</label>
                <input type="text" id="tb-batch-id" readonly>
              
              </div>

              <div class="section-title">3. Mapping Rak ke Mesin ABF</div>
              <div class="small-note" style="margin-bottom:10px;">
                Pilih mesin untuk setiap rak yang digunakan pada batch ini. Rak yang tidak dipakai biarkan kosong.
              </div>
              <div id="tb-rak-mapping"></div>

<div class="divider"></div>

              <button type="button" class="btn btn-primary" id="tb-submit-btn">
                Simpan Batch
              </button>

              <div id="tb-status" class="status"></div>
            </div>
          </div>


          <!-- FORM TAMBAH KARUNG -->
          <div id="page-form-tambah-karung" style="display:none;">
            <div class="container">
              <div class="top-bar">
                <div><strong>Form Tambah Karung dari Proses ABF</strong></div>
                <div><span id="tk-userInfo"></span></div>
              </div>
              <div class="small-note">
                Alur: 1) Pilih tgl ABF â†’ 2) Pilih batch (auto shift) â†’ 3) Pilih item â†’
                4) Tgl produksi â†’ 5) Input rak + ekor/kg â†’ 6) Submit (tampilkan konfirmasi) â†’
                7) Submit & New Data atau Clear Data.
              </div>

              <div class="section-title">1. Informasi ABF</div>
              <div class="field-row">
                <div class="field">
                  <label for="tglAbf">Tanggal ABF</label>
                  <input type="date" id="tglAbf" />
                </div>
                <div class="field">
                  <label for="batchSelect">Batch Pembekuan</label>
                  <select id="batchSelect">
                    <option value="">-- Pilih batch --</option>
                  </select>
                  <div class="small-note">Daftar batch terfilter berdasarkan tanggal ABF.</div>
                </div>
                <div class="field">
                  <label for="shiftAbf">Shift ABF</label>
                  <input type="text" id="shiftAbf" readonly />
                </div>
              </div>

              <div class="section-title">2. Item & Tanggal Produksi</div>
              <div class="field-row">
                <div class="field">
                  <label for="itemSearch">Item</label>
                  <input type="text" id="itemSearch" placeholder="Ketik nama item..." />
                  <select id="itemSelect" size="5"></select>
                  <input type="hidden" id="selectedItemId" />
                  <div class="small-note">
                    Dropdown menampilkan <strong>item_name</strong>, yang disimpan adalah <strong>item_id</strong>.
                  </div>
                </div>
                <div class="field">
                  <label for="tglProduksi">Tanggal Produksi (Potong)</label>
                  <input type="date" id="tglProduksi" />
                </div>
              </div>

              <div class="section-title">3. Rak ABF & Detail Ekor / Kg</div>
              <div class="small-note">
                Anda bisa menambah lebih dari 1 rak. Total ekor & kg per karung akan dihitung otomatis.
              </div>
              <table class="rak-table" id="rakTable">
                <thead>
                  <tr>
                    <th>Rak ABF</th>
                    <th>Ekor</th>
                    <th>Kg</th>
                    <th>Aksi</th>
                  </tr>
                </thead>
                <tbody id="rakTbody"></tbody>
              </table>
              <button type="button" class="btn btn-ghost btn-small" id="btnTambahRak">
                + Tambah Rak
              </button>
              <div class="totals-box">
                Total per karung: <strong><span id="totalEkor">0</span> ekor</strong> /
                <strong><span id="totalKg">0.00</span> kg</strong>
              </div>

              <div class="section-title">4. Operator & Catatan</div>
              <div class="field-row">
                <div class="field">
                  <label for="operatorName">Operator (otomatis dari login)</label>
                  <input type="text" id="operatorName" readonly />
                </div>
                <div class="field">
                  <label for="catatan">Catatan (opsional)</label>
                  <textarea id="catatan" placeholder="Opsional, misal: hasil ABF shift 1"></textarea>
                </div>
              </div>

              <div class="divider"></div>
              <div class="section-title">5. Submit & Konfirmasi</div>
              <button type="button" class="btn btn-primary" id="btnPreview">
                Submit (Tampilkan Konfirmasi)
              </button>
              <div id="confirmBox" class="confirm-box" style="display:none;"></div>
              <div style="margin-top:8px; display:flex; gap:8px; flex-wrap: wrap;">
                <button type="button" class="btn btn-secondary" id="btnSubmitNew" disabled>
                  Submit &amp; New Data
                </button>
                <button type="button" class="btn btn-ghost" id="btnClear">
                  Clear Data
                </button>
              </div>
              <div id="statusMessage" class="status"></div>
            </div>
          </div>

          <!-- FORM PINDAH LOKASI KARUNG -->
          
          <!-- ===== FORM BUAT KARUNG ID (DRAFT) ===== -->
          <div id="page-form-buat-karung-draft" style="display:none;">
            <div class="container">
              <div class="top-bar">
                <div><strong>Form Buat Karung ID (Draft)</strong></div>
                <div><span id="bd-userInfo"></span></div>
              </div>
              <div class="small-note">
                Gunakan form ini hanya untuk membuat <strong>karung_id</strong> bagi barang masuk yang belum memiliki label.
                Status karung akan dibuat sebagai <strong>draft</strong> dan <strong>belum dianggap diterima</strong> sampai diproses melalui Receipt Slip.
                Proses dilakukan <strong>satu per satu</strong> dan akan langsung membuka jendela print label.
              </div>

              <div class="section-title">1. Informasi Karung</div>

              <div class="field">
                <label for="bd-item">Item</label>
                <select id="bd-item"></select>
              </div>

              <div class="field-row">
                <div class="field">
                  <label for="bd-tgl-produksi">Tgl Produksi</label>
                  <input type="date" id="bd-tgl-produksi">
                </div>
                <div class="field">
                  <label for="bd-ekor">Ekor</label>
                  <input type="number" id="bd-ekor" inputmode="numeric" min="0" step="1" placeholder="0">
                </div>
                <div class="field">
                  <label for="bd-kg">Kg</label>
                  <input type="number" id="bd-kg" inputmode="decimal" min="0" step="0.01" placeholder="0.00">
                </div>
              </div>

              <!-- Admin-only: opsi langsung dianggap saldo awal (tanpa Receipt Slip manual) -->
              <div class="field" id="bd-saldo-awal-wrap" style="display:none; margin-top:6px;">
                <label style="display:flex; gap:10px; align-items:center; cursor:pointer;">
                  <input type="checkbox" id="bd-saldo-awal" />
                  <span><strong>Saldo awal</strong> (khusus admin)</span>
                </label>
                <div class="small-note">Jika dicentang, sistem akan otomatis mem-posting Receipt Slip sumber <b>saldo awal</b> untuk karung ini.</div>
              </div>
<div class="actions">
                <button id="bd-generate" class="primary">Generate & Print (1 Karung)</button>
                <button id="bd-clear">Clear</button>
              </div>

              <div id="bd-status" class="status"></div>

              <div class="small-note">
                Catatan: Jika printer tidak muncul, pastikan browser mengizinkan pop-up untuk halaman ini.
              </div>
            </div>
          </div>


<div id="page-form-revisi-karung" style="display:none;">
            <div class="container">
              <div class="top-bar">
                <div><strong>Form Revisi Data Karung (ABF)</strong></div>
                <div><span id="rv-userInfo"></span></div>
              </div>

              <div class="small-note">
                Khusus <strong>Supervisor</strong> &amp; <strong>Admin</strong>. 
                Masukkan <code>karung_id</code> untuk menampilkan data saat ini, lalu isi data revisi dan submit.
              </div>

              <div class="section-title">1. Cari Karung</div>
              <div class="field-row">
                <div class="field">
                  <label for="rv-karung-id">Karung ID</label>
                  <input type="text" id="rv-karung-id" placeholder="Scan/ketik karung_id lalu Enter" />
                  <div class="small-note">Jika pakai barcode scanner model keyboard, biasanya otomatis kirim Enter.</div>
                </div>
                <div class="field" style="flex:0 0 180px;">
                  <label>&nbsp;</label>
                  <button type="button" class="btn btn-secondary btn-small" id="rv-btn-load">Load</button>
                </div>
                <div class="field" style="flex:0 0 180px;">
                  <label>&nbsp;</label>
                  <button type="button" class="btn btn-ghost btn-small" id="rv-btn-clear">Clear</button>
                </div>
              </div>

              <div id="rv-status" class="status"></div>

              <div class="divider"></div>

              <div class="section-title">2. Data Saat Ini</div>
              <div id="rv-current-box" class="totals-box" style="display:none;"></div>

              <div class="divider"></div>

              <div class="section-title">3. Data Revisi</div>
              <div class="field">
                <label for="rv-item">Item</label>
                <select id="rv-item"></select>
                <div class="small-note">Dropdown menampilkan <strong>item_name</strong>, yang disimpan adalah <strong>item_id</strong>.</div>
              </div>

              <div class="field-row">
                <div class="field">
                  <label for="rv-tgl-produksi">Tgl Produksi</label>
                  <input type="date" id="rv-tgl-produksi" />
                </div>
                <div class="field">
                  <label for="rv-ekor">Ekor</label>
                  <input type="number" id="rv-ekor" inputmode="numeric" min="0" step="1" placeholder="0" />
                </div>
                <div class="field">
                  <label for="rv-kg">Kg</label>
                  <input type="number" id="rv-kg" inputmode="decimal" min="0" step="0.01" placeholder="0.00" />
                </div>
              </div>

              <div class="field-row">
                <div class="field">
                  <label for="rv-batch">Batch Pembekuan</label>
                  <input type="text" id="rv-batch" placeholder="BF-YYMMDDx" />
                </div>
                <div class="field">
                  <label for="rv-pallet">Pallet</label>
                  <input type="text" id="rv-pallet" placeholder="PLT-..." />
                </div>
              </div>

              <div class="field">
                <label for="rv-ket">Alasan Revisi (wajib)</label>
                <input type="text" id="rv-ket" placeholder="Wajib diisi. Contoh: salah input item / koreksi hasil timbang" />
              </div>

              <div class="divider"></div>

              <div class="section-title">4. Submit</div>
              <button type="button" class="btn btn-primary" id="rv-btn-submit">Submit Revisi</button>
            </div>
          </div>

<div id="page-form-receipt-slip" style="display:none;">
  <div class="container">
    <div class="top-bar">
      <div><strong>Receipt Slip</strong> <span id="rs-badge" class="badge-role" style="margin-left:8px;">DRAFT</span></div>
      <div><span id="rs-userInfo"></span></div>
    </div>

    <div class="small-note">
      Receipt Slip digunakan untuk menerima kembali <strong>karung yang sudah ada</strong> (status <code>habis</code> atau <code>draft</code>).
      Jika status karung <code>tersedia</code> atau <code>terbuka</code>, sistem akan menolak dengan pesan: <strong>"karung ini masih ada di gudang"</strong>.
      Setelah posting, <strong>pallet_id tetap NULL</strong> dan harus dipindahkan melalui <em>Form Pindah Pallet</em>.
    </div>

    <div class="section-title">1. Header Receipt</div>
    <div class="field-row">
      <div class="field">
        <label for="rs-no">No Receipt</label>
        <input type="text" id="rs-no" disabled placeholder="RS-YYYYMMDDXXXX" />
      </div>
      <div class="field">
        <label for="rs-tgl">Tanggal Terima</label>
        <input type="date" id="rs-tgl" />
      </div>
    </div>

    <div class="field-row">
      <div class="field">
        <label for="rs-sumber">Sumber</label>
        <select id="rs-sumber">
          <option value="">-- Pilih sumber --</option>
          <option value="dari_lokasi_lain">Dari Gudang Lain</option>
          <option value="retur">Retur</option>
          <option value="chiller">Dari Chiller</option>
          <option value="awal">Saldo Awal</option>
        </select>
      </div>

      <div class="field" id="rs-row-gudang" style="display:none;">
        <label for="rs-gudang-asal">Gudang Asal</label>
        <select id="rs-gudang-asal">
          <option value="">-- Pilih gudang asal --</option>
        </select>
        <div class="small-note">Sumber gudang diambil dari enum <code>sumber_masuk_enum</code>.</div>
      </div>

      <div class="field" id="rs-row-pelanggan" style="display:none;">
        <label for="rs-pelanggan">Nama Pelanggan</label>
        <input type="text" id="rs-pelanggan" placeholder="Nama customer (wajib untuk retur)" />
      </div>
    </div>

    <div class="field">
      <label for="rs-catatan">Catatan (opsional)</label>
      <textarea id="rs-catatan" placeholder="Catatan tambahan..."></textarea>
    </div>

    <div class="divider"></div>

    <div class="section-title">2. Tambah Karung</div>

    <div class="field-row">
      <div class="field">
        <label for="rs-karung-input">ID Karung</label>
        <input type="text" id="rs-karung-input" placeholder="Scan / ketik karung_id lalu Enter" />
        <div class="small-note">Mode scan massal: scan berulang akan langsung auto-add.</div>
      </div>

      <div class="field">
        <label>&nbsp;</label>
        <button class="btn" id="rs-open-scanner">Scan QR</button>
        <button class="btn-ghost" id="rs-close-scanner" style="display:none;">Tutup Scanner</button>
      </div>

      <div class="field">
        <label>Opsi</label>
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          <label style="display:flex; gap:8px; align-items:center; font-size:0.9rem;">
            <input type="checkbox" id="rs-scan-massal" checked /> Scan massal
          </label>
          <label style="display:flex; gap:8px; align-items:center; font-size:0.9rem;">
            <input type="checkbox" id="rs-beep" checked /> Beep
          </label>
        </div>
      </div>
    </div>

    <div id="rs-scanner-wrap" style="display:none; margin-top:10px;">
      <div id="rs-qr-reader" style="width:100%; max-width:360px;"></div>
    </div>

    <div id="rs-status" class="status"></div>

    <div class="divider"></div>

    <div class="section-title">3. Daftar Karung</div>
    <div style="overflow:auto;">
      <table class="table" id="rs-table">
        <thead>
          <tr>
            <th style="width:48px;">No</th>
            <th style="min-width:180px;">Karung ID</th>
            <th style="min-width:160px;">Item</th>
            <th style="width:90px;">Ekor</th>
            <th style="width:110px;">Kg</th>
            <th style="min-width:120px;">Tgl Produksi</th>
            <th style="width:80px;">Aksi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="field-row" style="margin-top:10px;">
      <div class="field">
        <div class="small-note"><strong>Ringkasan:</strong> <span id="rs-summary">0 karung, 0 ekor, 0 kg</span></div>
      </div>
      <div class="field" style="text-align:right;">
        <button class="btn-ghost" id="rs-new">Receipt Baru</button>
        <button class="btn-ghost" id="rs-save">Simpan Draft</button>
        <button class="btn" id="rs-post-print">Post & Print</button>
      </div>
    </div>

    <div class="small-note" style="margin-top:8px;">
      Print menggunakan format <strong>Continuous Form A5 Landscape</strong> (21.5 cm Ã— 16 cm) dengan rincian 3 kolom.
    </div>
  </div>
</div>


<div id="page-form-pindah-lokasi" style="display:none;">
            <div class="container">
              <div class="top-bar">
                <div><strong>Form Pindah Lokasi Karung (Pallet)</strong></div>
                <div><span id="pl-userInfo"></span></div>
              </div>

              <div class="small-note">
                Scan QR / barcode karung dengan kamera HP atau ketik manual ID karung,
                lalu pilih pallet baru. Sistem akan menampilkan pallet lama sebagai kontrol.
              </div>

              <div class="section-title">1. Cari Karung</div>
              <div class="field-row">
                <div class="field">
                  <label for="pl-scan-input">Scan / Input Karung ID</label>
                  <input type="text" id="pl-scan-input" placeholder="Scan atau ketik ID karung lalu tekan Enter / Cari" />
                  <div class="small-note">
                    Scanner model keyboard tinggal arahkan ke kotak ini, lalu tekan Enter.
                  </div>
                </div>
                <div class="field" style="flex:0 0 140px;">
                  <label>&nbsp;</label>
                  <button type="button" class="btn btn-primary btn-small" id="pl-btn-search">
                    Cari Karung
                  </button>
                </div>
              </div>

              <!-- Tombol & area kamera HP -->
              <div class="field-row">
                <div class="field">
                  <label>Scan QR pakai kamera HP</label>
                  <div style="display:flex; gap:8px; flex-wrap:wrap;">
                    <button type="button" class="btn btn-secondary btn-small" id="pl-btn-start-camera">
                      ðŸ“· Mulai Scan QR
                    </button>
                    <button type="button" class="btn btn-ghost btn-small" id="pl-btn-stop-camera">
                      âœ– Stop Kamera
                    </button>
                  </div>
                  <div class="small-note">
                    Setelah tekan "Mulai Scan QR", browser akan minta izin kamera.
                    Arahkan kamera ke QR karung.
                  </div>
                </div>
              </div>

              <div id="pl-qr-region" style="
                width: 260px;
                max-width: 100%;
                margin: 8px 0;
                border: 1px solid #e5e7eb;
                border-radius: 8px;
                overflow: hidden;
                display: none;
              "></div>

              <div id="pl-search-results" class="small-note" style="margin-bottom:8px;"></div>

              <div class="section-title">2. Detail Karung</div>
              <div class="field-row">
                <div class="field">
                  <label>Karung ID</label>
                  <input type="text" id="pl-karung-id" readonly />
                </div>
                <div class="field">
                  <label>Item</label>
                  <input type="text" id="pl-item-name" readonly />
                </div>
              </div>
              <div class="field-row">
                <div class="field">
                  <label>Pallet / Lokasi Lama</label>
                  <input type="text" id="pl-pallet-lama" readonly />
                </div>
                <div class="field">
                  <label>Status Karung</label>
                  <input type="text" id="pl-status-karung" readonly />
                </div>
              </div>
              <div class="field-row">
                <div class="field">
                  <label>Sisa Stok</label>
                  <input type="text" id="pl-stok-sisa" readonly />
                  <div class="small-note">Hanya informasi kontrol (ekor & kg sisa).</div>
                </div>
              </div>

              <div class="section-title">3. Pilih Pallet Baru</div>
              <div class="field-row">
                <div class="field">
                  <label for="pl-pallet-baru">Pallet Baru</label>
                  <select id="pl-pallet-baru">
                    <option value="">-- Pilih pallet baru --</option>
                  </select>
                  <div class="small-note">
                    Diambil dari <code>master_pallet</code>.
                  </div>
                </div>
              </div>

              <div class="section-title">4. Operator & Catatan</div>
              <div class="field-row">
                <div class="field">
                  <label for="pl-operator">Operator</label>
                  <input type="text" id="pl-operator" readonly />
                </div>
                <div class="field">
                  <label for="pl-catatan">Catatan (opsional)</label>
                  <textarea id="pl-catatan" placeholder="Misal: pindah dari Chiller A ke Chiller B"></textarea>
                </div>
              </div>

              <div class="divider"></div>
              <div class="section-title">5. Submit Pindah Pallet</div>
              <button type="button" class="btn btn-secondary" id="pl-btn-submit">
                Simpan Pindah Pallet
              </button>

              <div id="pl-status-message" class="status"></div>

            </div>
</div>

<div id="page-form-input-pallet" style="display:none;">
  <div class="container">
    <div class="top-bar">
      <div><strong>Form Input Karung ke Pallet</strong></div>
      <div><span id="ip-userInfo"></span></div>
    </div>

    <div class="small-note">
      Alur: 1) Pilih pallet tujuan â†’ 2) Scan/ketik karung (bisa banyak) â†’ 3) Cek ringkasan (awal + tambah = akhir) â†’ 4) Submit untuk memindahkan semua karung ke pallet tersebut.
    </div>

    <div class="section-title">1. Pilih Pallet Tujuan</div>
    <div class="field-row">
      <div class="field">
        <label for="ip-pallet">Pallet Tujuan</label>
        <select id="ip-pallet">
          <option value="">-- Pilih pallet --</option>
        </select>
        <div class="small-note">Daftar diambil dari <code>master_pallet</code>.</div>
      </div>
      <div class="field">
        <label>Jumlah Karung</label>
        <div class="field-row" style="gap:10px;">
          <div class="field" style="margin:0;">
            <label style="font-size:12px; color:#64748b;">Awal</label>
            <input type="text" id="ip-count-awal" readonly value="0" />
          </div>
          <div class="field" style="margin:0;">
            <label style="font-size:12px; color:#64748b;">Tambah</label>
            <input type="text" id="ip-count-tambah" readonly value="0" />
          </div>
          <div class="field" style="margin:0;">
            <label style="font-size:12px; color:#64748b;">Akhir</label>
            <input type="text" id="ip-count-akhir" readonly value="0" />
          </div>
        </div>
        <div class="small-note">Ringkasan dihitung sebelum submit.</div>
      </div>
    </div>

    <div class="divider"></div>

    <div class="section-title">2. Tambah Karung</div>
    <div class="field-row">
      <div class="field">
        <label for="ip-karung-input">Scan / Input Karung ID</label>
        <input type="text" id="ip-karung-input" placeholder="Scan atau ketik karung_id lalu Enter" disabled />
        <div class="small-note">
          Tips: jika scanner model keyboard, biasanya otomatis mengirim Enter.
        </div>
      </div>
      <div class="field" style="flex:0 0 160px;">
        <label>&nbsp;</label>
        <button type="button" class="btn btn-primary btn-small" id="ip-btn-add" disabled>Tambah</button>
      </div>
    </div>

    <div class="field-row">
      <div class="field">
        <label>Scan QR via kamera (opsional)</label>
        <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
          <button type="button" class="btn btn-secondary btn-small" id="ip-open-scanner" disabled>ðŸ“· Mulai Scan</button>
          <button type="button" class="btn btn-ghost btn-small" id="ip-close-scanner" style="display:none;">âœ– Stop Kamera</button>
          <label class="small-note" style="display:flex; align-items:center; gap:6px; margin-left:6px;">
            <input type="checkbox" id="ip-scan-massal" checked disabled /> Scan Massal
          </label>
        </div>
        <div class="small-note">Jika Scan Massal ON, setiap QR terbaca akan otomatis ditambahkan ke daftar.</div>
        <div id="ip-scanner-wrap" style="display:none; margin-top:8px;">
          <div id="ip-qr-reader" style="width:260px; max-width:100%; border:1px solid #e5e7eb; border-radius:10px; overflow:hidden;"></div>
        </div>
      </div>
    </div>

    <div id="ip-status" class="status"></div>

    <div class="divider"></div>

    <div class="section-title">3. Daftar Karung</div>
    <div style="overflow:auto;">
      <table class="table" id="ip-table">
        <thead>
          <tr>
            <th style="width:48px;">No</th>
            <th style="min-width:180px;">Karung ID</th>
            <th style="min-width:180px;">Item</th>
            <th style="width:90px;">Ekor</th>
            <th style="width:110px;">Kg</th>
            <th style="min-width:140px;">Pallet Lama</th>
            <th style="width:80px;">Aksi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="field-row" style="margin-top:10px;">
      <div class="field" style="flex:1;">
        <label for="ip-catatan">Catatan (opsional)</label>
        <textarea id="ip-catatan" placeholder="Misal: input barang untuk konsolidasi pallet"></textarea>
      </div>
    </div>

    <div class="divider"></div>

    <div class="section-title">4. Submit</div>
    <button type="button" class="btn btn-secondary" id="ip-submit" disabled>Simpan ke Pallet</button>
  </div>
</div>
<div id="page-form-cek-karung" style="display:none;">
  <div class="container">
    <div class="top-bar">
      <div><strong>Form Cek Isi Karung</strong></div>
      <div><span id="ck-userInfo"></span></div>
    </div>

    <div class="small-note">
      Scan/ketik <b>Karung ID</b> untuk melihat item, stok terakhir, status, informasi ABF (batch/mesin/rak), asal gabungan, dan histori pengambilan sebagian.
    </div>

    <div class="section-title">1. Scan / Input Karung</div>
    <div class="field-row">
      <div class="field">
        <label for="ck-input">Karung ID</label>
        <input type="text" id="ck-input" placeholder="Scan atau ketik karung_id lalu Enter" />
        <div class="small-note">Tips: jika pakai barcode scanner model keyboard, arahkan ke kolom ini.</div>
      </div>
      <div class="field" style="flex:0 0 160px;">
        <label>&nbsp;</label>
        <button class="btn btn-secondary btn-small" id="ck-btn-search">Cari</button>
      </div>
    </div>

    <div class="field-row">
      <div class="field">
        <label>Scan QR via kamera (opsional)</label>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button type="button" class="btn btn-ghost btn-small" id="ck-btn-start">Mulai Scan</button>
          <button type="button" class="btn btn-ghost btn-small" id="ck-btn-stop">Stop</button>
        </div>
        <div id="ck-qr-region" style="display:none; width: 260px; max-width: 100%; margin-top:8px; border:1px solid #e5e7eb; border-radius:10px; overflow:hidden;"></div>
      </div>
    </div>

    <div id="ck-status" class="status"></div>

    <div class="divider"></div>

    <div class="section-title">2. Ringkasan Karung</div>
    <div class="field-row">
      <div class="field">
        <label>Karung ID</label>
        <input type="text" id="ck-karung-id" readonly />
      </div>
      <div class="field">
        <label>Item</label>
        <input type="text" id="ck-item" readonly />
      </div>
    </div>

    <div class="field-row">
      <div class="field">
        <label>Tgl Produksi</label>
        <input type="text" id="ck-tgl" readonly />
      </div>
      <div class="field">
        <label>Status Karung</label>
        <input type="text" id="ck-status-karung" readonly />
      </div>
    </div>

    <div class="field-row">
      <div class="field">
        <label>Stok Terakhir</label>
        <input type="text" id="ck-sisa" readonly />
      </div>
      <div class="field">
        <label>Pallet</label>
        <input type="text" id="ck-pallet" readonly />
      </div>
    </div>

    <div class="field-row">
      <div class="field">
        <label>Batch ABF</label>
        <input type="text" id="ck-batch" readonly />
      </div>
      <div class="field" style="flex:0 0 220px;">
        <label>&nbsp;</label>
        <button class="btn btn-secondary btn-small" id="ck-btn-print">Print Ulang Label</button>
      </div>
    </div>

    <div class="divider"></div>

    <div class="section-title">3. Detail ABF (Rak & Mesin)</div>
    <table class="rak-table" id="ck-abf-table" style="display:none;">
      <thead>
        <tr>
          <th>Rak ABF</th>
          <th>Mesin ABF</th>
          <th>Ekor</th>
          <th>Kg</th>
        </tr>
      </thead>
      <tbody id="ck-abf-tbody"></tbody>
    </table>
    <div class="small-note" id="ck-abf-empty" style="display:none;">Tidak ada data rak ABF untuk karung ini.</div>

    <div class="divider"></div>

    <div class="section-title">4. Asal Gabungan</div>
    <div class="small-note" id="ck-merge-note" style="display:none;"></div>
    <table class="rak-table" id="ck-src-table" style="display:none;">
      <thead>
        <tr>
          <th>Karung Asal</th>
          <th>Item</th>
          <th>Tgl Produksi</th>
          <th>Status</th>
          <th>Sisa (Ekor/Kg)</th>
          <th>Pindah (Ekor/Kg)</th>
        </tr>
      </thead>
      <tbody id="ck-src-tbody"></tbody>
    </table>
    <div class="small-note" id="ck-src-empty" style="display:none;">Karung ini bukan hasil gabungan (atau data gabungan belum tersedia).</div>

    <div class="divider"></div>

    <div class="section-title">5. Riwayat Perubahan</div>
    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px;">
      <button class="btn btn-ghost btn-small" id="ck-filter-all">Semua</button>
      <button class="btn btn-ghost btn-small" id="ck-filter-out">Hanya Pengambilan (minus)</button>
    </div>

    <table class="rak-table" id="ck-hist-table" style="display:none;">
      <thead>
        <tr>
          <th>Waktu</th>
          <th>Jenis</th>
          <th>Perubahan</th>
          <th>Sisa Setelah</th>
          <th>Keterangan</th>
          <th>Operator</th>
        </tr>
      </thead>
      <tbody id="ck-hist-tbody"></tbody>
    </table>
    <div class="small-note" id="ck-hist-empty" style="display:none;">Tidak ada riwayat untuk karung ini.</div>
  </div>
</div>

<div id="page-form-gabung-karung" style="display:none;">
      <div class="container">
        <div class="top-bar">
          <div><strong>Form Gabung Karung</strong></div>
          <div><span id="gb-userInfo"></span></div>
        </div>

        <div class="small-note">
          Scan/ketik beberapa karung asal. Sistem akan membuat karung tujuan baru otomatis.
        </div>

        <div class="section-title">Info Gabungan</div>
        <div class="field-row">
          <div class="field">
            <label>Tgl Produksi (opsional)</label>
            <input type="date" id="gb-tgl-produksi" />
          </div>
          <div class="field">
            <label>Batch ABF (opsional)</label>
            <input type="text" id="gb-batch" placeholder="BF-YYMMDDx" />
          </div>
        </div>

        <div class="field-row">
          <div class="field">
            <label>Pallet Tujuan (opsional)</label>
            <input type="text" id="gb-pallet" placeholder="PLT-..." />
          </div>
          <div class="field">
            <label>Keterangan (opsional)</label>
            <input type="text" id="gb-keterangan" placeholder="Mis: konsolidasi pallet" />
          </div>
        </div>

        <div class="section-title">Scan Karung Asal</div>
        <div class="field-row">
          <div class="field">
            <label>Karung ID</label>
            <input type="text" id="gb-scan-input" placeholder="Scan/ketik karung_id lalu Enter" />
            <div class="small-note">Jika pakai barcode scanner model keyboard, biasanya otomatis kirim Enter.</div>
          </div>
          <div class="field" style="flex:0 0 160px;">
            <label>&nbsp;</label>
            <button class="btn btn-secondary btn-small" id="gb-btn-add">Tambah</button>
          </div>
        </div>

        <div id="gb-status" class="status"></div>

        <table class="rak-table" style="margin-top:10px;">
          <thead>
            <tr>
              <th>Karung Asal</th>
              <th>Item</th>
              <th>Sisa (Ekor/Kg)</th>
              <th>Pindah Ekor</th>
              <th>Pindah Kg</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="gb-tbody"></tbody>
        </table>

        <div class="divider"></div>

        <div class="field-row">
          <div class="field">
            <label>Total Pindah</label>
            <input type="text" id="gb-total" readonly />
          </div>
          <div class="field" style="flex:0 0 220px;">
            <label>&nbsp;</label>
            <button class="btn btn-primary" id="gb-btn-submit">Proses Gabung</button>
          </div>
        </div>

        <div class="small-note" id="gb-result"></div>
      </div>
    </div>



          <!-- FORM PICKING SLIP (placeholder) -->
          <!-- FORM PICKING SLIP -->
          <div id="page-form-picking-slip" style="display:none;">
            <div class="container">
              <div class="top-bar">
                <div><strong>Form Picking Slip</strong></div>
                <div><span id="ps-userInfo"></span></div>
              </div>

              <div class="small-note">
                Alur: 1) Isi header picking slip â†’ 2) Tambah karung ke daftar â†’
                3) Cek total ekor/kg â†’ 4) Submit (otomatis update stok & log_karung).
              </div>

              <!-- 1. HEADER PICKING SLIP -->
              <div class="section-title">1. Informasi Picking Slip</div>
              <div class="field-row">
                <div class="field">
                  <label for="ps-tgl-picking">Tanggal Picking</label>
                  <input type="date" id="ps-tgl-picking" />
                  <div class="small-note">Default: hari ini.</div>
                </div>
                <div class="field">
                  <label for="ps-tujuan">Tujuan</label>
                  <select id="ps-tujuan">
                    <option value="">-- Pilih tujuan --</option>
                    <option value="jual">Jual</option>
                    <option value="reprocess">Reprocess</option>
                    <option value="pindah_lokasi">Pindah Lokasi</option>
                  </select>
                  <div class="small-note">
                    Menentukan jenis_perubahan di <code>log_karung</code>.
                  </div>
                </div>
              </div>

              <div class="field-row" id="ps-row-jual" style="display:none;">
                <div class="field">
                  <label for="ps-nama-customer">Nama Customer</label>
                  <input type="text" id="ps-nama-customer" placeholder="Nama customer / outlet" />
                </div>
                <div class="field">
                  <label for="ps-no-so">Nomor SO (opsional)</label>
                  <input type="text" id="ps-no-so" placeholder="SO-..." />
                </div>
              </div>

              <div class="field-row" id="ps-row-gudang-tujuan" style="display:none;">
                <div class="field">
                  <label for="ps-gudang-tujuan">Gudang Tujuan</label>
                  <select id="ps-gudang-tujuan">
                    <option value="">-- Pilih gudang tujuan --</option>
                  </select>
                  <div class="small-note">
                    Diambil dari tabel <code>master_gudang</code>, hanya aktif=true.
                  </div>
                </div>
              </div>

              <div class="field-row">
                <div class="field">
                  <label for="ps-catatan">Catatan (opsional)</label>
                  <textarea id="ps-catatan" placeholder="Misal: Kirim ke RM Sederhana jam 16:00"></textarea>
                </div>
              </div>

              <div class="divider"></div>

              <!-- 2. TAMBAH KARUNG -->
              <div class="section-title">2. Tambah Karung yang Diambil</div>
              <div class="field-row">
                <div class="field">
                  <label for="ps-karung-search">ID Karung</label>
                  <input
                    type="text"
                    id="ps-karung-search"
                    placeholder="Scan / ketik ID karung"
                  />
                  <div class="small-note">
                    Saat ini menggunakan input manual atau scanner yang mengetik teks.
                    Default qty diambil = stok sisa (ekor &amp; kg).
                  </div>
                </div>
                <div class="field" style="flex:0 0 180px;">
                  <label>&nbsp;</label>
                  <button type="button" id="ps-btn-search" class="btn btn-secondary btn-small">
                    Tambah dari Stok
                  </button>
                </div>
              </div>

              <!-- Scan options -->
              <div class="field-row" style="align-items:center; gap:14px; margin-top:6px;">
                <label style="display:flex; align-items:center; gap:8px; cursor:pointer; user-select:none;">
                  <input type="checkbox" id="ps-scan-mode" checked />
                  <span>Mode Scan Massal</span>
                </label>

                <label style="display:flex; align-items:center; gap:8px; cursor:pointer; user-select:none;">
                  <input type="checkbox" id="ps-beep-success" checked />
                  <span>Beep OK</span>
                </label>

                <label style="display:flex; align-items:center; gap:8px; cursor:pointer; user-select:none;">
                  <input type="checkbox" id="ps-beep-error" checked />
                  <span>Beep Error</span>
                </label>

                <div class="small-note" style="margin-left:auto;">
                  Jika Mode Scan Massal ON, scan akan auto-add tanpa klik tombol.
                </div>
              </div>
              <div id="ps-search-status" class="status"></div>

              <!-- 3. TABEL DETAIL KARUNG -->
              <div class="section-title">3. Detail Karung</div>
              <div class="small-note">
                Nilai awal "Diambil" otomatis mengikuti stok sisa. Bisa dikurangi jika hanya ambil sebagian.
              </div>

              <table class="rak-table" id="ps-detail-table" style="margin-top:8px; display:none;">
                <thead>
                  <tr>
                    <th>Karung</th>
                    <th>Item</th>
                    <th>Stok Sisa</th>
                    <th>Diambil (ekor)</th>
                    <th>Diambil (kg)</th>
                    <th>Preview Sisa</th>
                    <th>Aksi</th>
                  </tr>
                </thead>
                <tbody id="ps-detail-tbody"></tbody>
              </table>

              <div id="ps-summary" class="totals-box" style="display:none; margin-top:8px;"></div>

              <div class="divider"></div>

              <!-- 4. SUBMIT -->
              <div class="section-title">4. Submit Picking Slip</div>
              <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:4px;">
                <button type="button" class="btn btn-primary" id="ps-btn-submit">
                  Submit Picking Slip
                </button>
                <button type="button" class="btn btn-ghost" id="ps-btn-clear">
                  Clear Form
                </button>
              </div>
              <div id="ps-status-message" class="status"></div>
            </div>
          </div>


          <!-- LAPORAN STOK PER ITEM & PALLET -->
          
          <!-- RIWAYAT PICKING SLIP -->
          <div id="page-riwayat-picking-slip" style="display:none;">
            <div class="container">
              <div class="top-bar">
                <div><strong>Riwayat Picking Slip</strong></div>
                <div><span id="rps-userInfo"></span></div>
              </div>

              <div class="small-note">
                Cari picking slip yang sudah dibuat, lalu pilih aksi: <strong>Print Ulang</strong> (semua role).
                <br/>Catatan: Jika ada kebutuhan pembatalan transaksi, gunakan mekanisme Receipt Slip Retur (bukan delete).
              </div>

              <div class="field-row" style="margin-top:10px;">
                <div class="field">
                  <label for="rps-keyword">Nomor / Keyword</label>
                  <input type="text" id="rps-keyword" placeholder="Contoh: PS-20260108-001 atau nama customer" />
                </div>
                <div class="field" style="flex:0 0 180px;">
                  <label for="rps-date-from">Dari Tanggal</label>
                  <input type="date" id="rps-date-from" />
                </div>
                <div class="field" style="flex:0 0 180px;">
                  <label for="rps-date-to">Sampai Tanggal</label>
                  <input type="date" id="rps-date-to" />
                </div>
                <div class="field" style="flex:0 0 160px;">
                  <label>&nbsp;</label>
                  <button class="btn btn-primary" id="rps-btn-search">Cari</button>
                </div>
              </div>

              <div id="rps-status" class="status"></div>

              <table class="rak-table" id="rps-table" style="display:none; margin-top:10px;">
                <thead>
                  <tr>
                    <th>Tanggal</th>
                    <th>No Picking Slip</th>
                    <th>Tujuan</th>
                    <th>Customer</th>
                    <th>Karung</th>
                    <th>Ekor</th>
                    <th>Kg</th>
                    <th style="width:140px;">Aksi</th>
                  </tr>
                </thead>
                <tbody id="rps-tbody"></tbody>
              </table>

              <div id="rps-pagination" style="display:none; margin-top:10px; display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                <button type="button" class="btn btn-ghost btn-small" id="rps-btn-prev" disabled>Prev</button>
                <div class="small-note" style="margin:0;">
                  <span id="rps-page-info">Page 1</span>
                  <span id="rps-count-info" style="margin-left:8px;"></span>
                </div>
                <button type="button" class="btn btn-ghost btn-small" id="rps-btn-next" disabled>Next</button>
              </div>

            </div>
          </div>

<div id="page-laporan-stok" style="display:none;">
            <div class="container">
              <div class="top-bar">
                <div><strong>Laporan Stok per Item &amp; Pallet</strong></div>
                <div><span id="ls-userInfo"></span></div>
              </div>

              <div class="section-title">1. Pilih Item</div>
              <div class="field-row">
                <div class="field">
                  <label for="ls-itemSelect">Item</label>
                  <select id="ls-itemSelect">
                    <option value="">-- Pilih item --</option>
                  </select>
                  <div class="small-note">
                    Daftar diambil dari tabel <code>items</code>. Laporan hanya untuk 1 item per kali tampilan.
                  </div>
                </div>
                <div class="field" style="flex:0 0 160px;">
                  <label>&nbsp;</label>
                  <button type="button" class="btn btn-primary btn-small" id="ls-btn-tampilkan">
                    Tampilkan Laporan
                  </button>
                </div>
              </div>

              <div class="section-title">2. Hasil Laporan</div>
              <div id="ls-status-message" class="status"></div>

              <div id="ls-summary" class="totals-box" style="display:none; margin-top:8px;"></div>

              <table class="rak-table" id="ls-table" style="margin-top:8px; display:none;">
                <thead>
                  <tr>
                    <th>Pallet</th>
		                <th>Tgl Prod. Tertua</th>
                    <th>Jumlah Karung</th>
                    <th>Total Ekor</th>
                    <th>Total Kg</th>
                  </tr>
                </thead>
                <tbody id="ls-tbody"></tbody>
              </table>
          <div id="ls-detail-container" style="display:none; margin-top:12px;">
            <div class="section-title" style="margin-top:0;">Detail Karung per Pallet</div>
          <p style="font-size:13px; margin-bottom:4px;">
            Pallet: <strong><span id="ls-detail-pallet"></span></strong>
          </p>
  <table class="rak-table" id="ls-detail-table">
    <thead>
      <tr>
        <th>Karung ID</th>
        <th>Tgl Produksi</th>
        <th>Ekor</th>
        <th>Kg</th>
      </tr>
    </thead>
    <tbody id="ls-detail-tbody"></tbody>
  </table>
</div>
            </div>
          </div>

<div id="page-laporan-stok-semua" style="display:none;">
  <div class="container">
    <div class="top-bar">
      <div><strong>Laporan Stok Semua Barang (Status Terbuka &amp; Tersedia)</strong></div>
      <div><span id="lss-userInfo"></span></div>
    </div>

    <div class="section-title">1. Filter</div>
    <div class="field-row">
      <div class="field">
        <label for="lss-keyword">Cari Item (nama)</label>
        <input type="text" id="lss-keyword" placeholder="Ketik untuk filter..." />
        <div class="small-note">
          Sumber data: RPC <code>fn_laporan_stok_semua_barang()</code>. Status yang dihitung hanya <code>tersedia</code> &amp; <code>terbuka</code>.
        </div>
      </div>
      <div class="field" style="flex:0 0 180px;">
        <label>&nbsp;</label>
        <button type="button" class="btn btn-primary btn-small" id="lss-btn-refresh">Refresh</button>
      </div>
    </div>

    <div class="section-title">2. Hasil</div>
    <div id="lss-status" class="status"></div>

    <div id="lss-summary" class="totals-box" style="display:none; margin-top:8px;"></div>

    <table class="rak-table" id="lss-table" style="display:none; margin-top:8px;">
      <thead>
        <tr>
          <th>Item</th>
          <th>Jumlah Karung</th>
          <th>Total Ekor</th>
          <th>Total Kg</th>
        </tr>
      </thead>
      <tbody id="lss-tbody"></tbody>
    </table>
    <div id="lss-detail" style="display:none; margin-top:12px;">
      <div class="section-title" style="margin-top:0; display:flex; align-items:center; justify-content:space-between;">
        <span>2. Rincian Karung (Tersedia / Terbuka)</span>
        <button class="btn-secondary" type="button" id="lss-detail-close">Tutup</button>
      </div>

      <p style="font-size:13px; margin:0 0 6px 0;">
        Item: <strong><span id="lss-detail-item"></span></strong>
      </p>

      <table class="rak-table" id="lss-detail-table">
        <thead>
          <tr>
            <th>Karung ID</th>
            <th>Pallet</th>
            <th>Tgl Produksi</th>
            <th>Status</th>
            <th>Ekor</th>
            <th>Kg</th>
          </tr>
        </thead>
        <tbody id="lss-detail-tbody"></tbody>
      </table>

      <div style="display:flex; align-items:center; gap:8px; margin-top:8px;">
        <button class="btn-secondary" type="button" id="lss-prev">Prev</button>
        <button class="btn-secondary" type="button" id="lss-next">Next</button>
        <span class="small-note" id="lss-pageinfo" style="margin-left:6px;"></span>
      </div>
    </div>

  </div>
</div>

	  <!-- LAPORAN BATCH ABF -->
<div id="page-laporan-batch" style="display:none;">
  <div class="container">
    <div class="top-bar">
      <div><strong>Laporan Batch Pembekuan (ABF)</strong></div>
      <div><span id="lb-userInfo"></span></div>
    </div>

    <div class="section-title">1. Filter Batch</div>
    <div class="field-row">
      <div class="field">
        <label for="lb-tgl-abf">Tanggal ABF</label>
        <input type="date" id="lb-tgl-abf" />
        <div class="small-note">Pilih tanggal proses ABF.</div>
      </div>
      <div class="field">
        <label for="lb-batch-select">Batch Pembekuan</label>
        <select id="lb-batch-select">
          <option value="">-- Pilih batch --</option>
        </select>
        <div class="small-note">Daftar batch ditarik dari master_batch_abf untuk tanggal tersebut.</div>
      </div>
      <div class="field">
        <label for="lb-rak-select">Rak ABF (untuk laporan per rak)</label>
        <select id="lb-rak-select">
          <option value="ALL">Semua Rak</option>
        </select>
        <div class="small-note">Pilih "Semua Rak" untuk melihat semua rak.</div>
      </div>
      <div class="field" style="flex:0 0 160px;">
        <label>&nbsp;</label>
        <button type="button" class="btn btn-primary btn-small" id="lb-btn-tampilkan">
          Tampilkan Laporan
        </button>
      </div>
    </div>

    <div id="lb-status-batch" class="status"></div>

    <div class="section-title">2. Laporan Per Rak</div>
    <div id="lb-summary-rak" class="totals-box" style="display:none;"></div>
    <table class="rak-table" id="lb-table-rak" style="margin-top:8px; display:none;">
      <thead>
        <tr>
          <th>Rak ABF</th>
          <th>Item</th>
          <th>Total Ekor</th>
          <th>Total Kg</th>
        </tr>
      </thead>
      <tbody id="lb-tbody-rak"></tbody>
    </table>

    <div class="section-title">3. Laporan Per Item (Total Semua Rak)</div>
    <div id="lb-summary-item" class="totals-box" style="display:none;"></div>
    <table class="rak-table" id="lb-table-item" style="margin-top:8px; display:none;">
      <thead>
        <tr>
          <th>Item</th>
          <th>Total Ekor</th>
          <th>Total Kg</th>
        </tr>
      </thead>
      <tbody id="lb-tbody-item"></tbody>
    </table>
  <div class="section-title">4. Rincian per Karung</div>
    <div id="lb-summary-detail" class="totals-box" style="display:none;"></div>
    <table class="rak-table" id="lb-table-detail" style="margin-top:8px; display:none;">
      <thead>
        <tr>
          <th>Rak ABF</th>
          <th>Karung ID</th>
          <th>Item</th>
          <th>Ekor</th>
          <th>Kg</th>
          <th>Tgl Produksi</th>
        </tr>
      </thead>
      <tbody id="lb-tbody-detail"></tbody>
    </table>

	  

          </div>
</div>

    <!-- LAPORAN MUTASI PER ITEM (Saldo Awal + Mutasi + Saldo Akhir) -->
          <div id="page-laporan-mutasi" style="display:none;">
            <div class="container">
              <div class="top-bar">
                <div><strong>Laporan Mutasi per Item</strong></div>
                <div><span id="lm-userInfo"></span></div>
              </div>

              <div class="section-title">1. Filter Tanggal</div>
              <div class="field-row">
                <div class="field">
                  <label for="lm-date-from">Tanggal Dari</label>
                  <input type="date" id="lm-date-from" />
                </div>
                <div class="field">
                  <label for="lm-date-to">Tanggal Sampai</label>
                  <input type="date" id="lm-date-to" />
                </div>
                <div class="field" style="flex:0 0 200px;">
                  <label>&nbsp;</label>
                  <button type="button" class="btn btn-primary btn-small" id="lm-btn-tampilkan">
                    Tampilkan Laporan
                  </button>
                </div>
              </div>
              <div class="small-note">
                Konsep: per <code>item</code> menampilkan <strong>Saldo Awal</strong>, mutasi berdasarkan <strong>jenis_perubahan</strong> (fixed), dan <strong>Saldo Akhir</strong>.
                Nilai yang ditampilkan: <strong>ekor</strong> &amp; <strong>kg</strong> (2 desimal).
              </div>

              <div class="section-title">2. Hasil Laporan</div>
              <div id="lm-status" class="status"></div>
              <div id="lm-summary" class="totals-box" style="display:none; margin-top:8px;"></div>

              <div style="margin-top:8px; overflow:auto; border:1px solid #e5e7eb; border-radius:10px;">
                <table class="rak-table" id="lm-table" style="margin:0; display:none; min-width:1400px;">
                  <thead>
                    <tr>
                      <th>Item</th>
                      <th>Saldo Awal (Ekor)</th>
                      <th>Saldo Awal (Kg)</th>

                      <th>awal (Ekor)</th>
                      <th>awal (Kg)</th>
                      <th>abf (Ekor)</th>
                      <th>abf (Kg)</th>
                      <th>dari_lokasi_lain (Ekor)</th>
                      <th>dari_lokasi_lain (Kg)</th>
                      <th>chiller (Ekor)</th>
                      <th>chiller (Kg)</th>
                      <th>retur (Ekor)</th>
                      <th>retur (Kg)</th>
                      <th>jual (Ekor)</th>
                      <th>jual (Kg)</th>
                      <th>pindah_lokasi (Ekor)</th>
                      <th>pindah_lokasi (Kg)</th>
                      <th>reprocess (Ekor)</th>
                      <th>reprocess (Kg)</th>
                      <th>selisih (Ekor)</th>
                      <th>selisih (Kg)</th>
                      <th>rusak (Ekor)</th>
                      <th>rusak (Kg)</th>
                      <th>digabung (Ekor)</th>
                      <th>digabung (Kg)</th>
                      <th>gabungan (Ekor)</th>
                      <th>gabungan (Kg)</th>

                      <th>Saldo Akhir (Ekor)</th>
                      <th>Saldo Akhir (Kg)</th>
                    </tr>
                  </thead>
                  <tbody id="lm-tbody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  // ====== SUPABASE CLIENT ======  
  const SUPABASE_URL = 'https://zdkcuprmdtxahrxhgucy.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpka2N1cHJtZHR4YWhyeGhndWN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyMjYxMjQsImV4cCI6MjA3OTgwMjEyNH0.z_OA2XvyY2VqOpBwHLmpQ1rE5PD3y8eGP_GGbEZpl3E';
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ====== UTILS ======
  function escapeHtml(str) {
    return String(str ?? '')
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#039;');
  }

  function debounce(fn, wait=400) {
    let t = null;
    return (...args) => {
      if (t) clearTimeout(t);
      t = setTimeout(() => fn(...args), wait);
    };
  }


  // ====== Normalisasi hasil scan barcode/QR untuk ambil hanya karung_id ======
  // Support payload format: "KRG-...|AU 1.0|2025-12-08|30|30.10" â†’ "KRG-..."
  function normalizeKarungId(input) {
    const s = String(input ?? '').trim();
    if (!s) return '';
    const i = s.indexOf('|');
    return (i >= 0 ? s.slice(0, i) : s).trim();
  }


  function beep(freq=880, durationMs=80) {
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.frequency.value = freq;
      o.type = 'sine';
      o.connect(g);
      g.connect(ctx.destination);
      g.gain.setValueAtTime(0.0001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.15, ctx.currentTime + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + durationMs/1000);
      o.start();
      o.stop(ctx.currentTime + durationMs/1000 + 0.02);
      o.onended = () => ctx.close().catch(()=>{});
    } catch {}
  }


  // ====== DOM LOGIN & APP ======
  const loginPage   = document.getElementById('login-page');
  const appPage     = document.getElementById('app-page');
  const loginEmail  = document.getElementById('loginEmail');
  const loginPass   = document.getElementById('loginPassword');
  const loginBtn    = document.getElementById('loginBtn');
  const loginError  = document.getElementById('loginError');
  const logoutBtn   = document.getElementById('logout-btn');
  const userInfoEl  = document.getElementById('user-info');
  const appShellEl  = document.getElementById('app-shell');
  const toggleSidebarBtn = document.getElementById('btn-toggle-sidebar');

  const pageDashboard         = document.getElementById('page-dashboard');
  const pageFormTambahKarung  = document.getElementById('page-form-tambah-karung');
  const pageFormBuatKarungDraft = document.getElementById('page-form-buat-karung-draft');
  const pageFormReceiptSlip   = document.getElementById('page-form-receipt-slip');
  const pageFormPindahLokasi  = document.getElementById('page-form-pindah-lokasi');
  const pageFormInputPallet  = document.getElementById('page-form-input-pallet');
  const pageFormCekKarung     = document.getElementById('page-form-cek-karung');
  const pageFormGabungKarung  = document.getElementById('page-form-gabung-karung');
  const pageFormRevisiKarung  = document.getElementById('page-form-revisi-karung');
  const pageFormPickingSlip   = document.getElementById('page-form-picking-slip');
  const pageRiwayatPickingSlip = document.getElementById('page-riwayat-picking-slip');
  const pageLaporanBatch      = document.getElementById('page-laporan-batch');
  const pageLaporanStok       = document.getElementById('page-laporan-stok');
  const pageLaporanStokSemua  = document.getElementById('page-laporan-stok-semua');
  const pageLaporanMutasi     = document.getElementById('page-laporan-mutasi');
  const pageFormTambahBatch = document.getElementById('page-form-tambah-batch');



  const menuButtons = document.querySelectorAll('.menu-btn');

  let currentUser = null;
  let currentProfile = null;
  let operatorDisplayName = '';
  let tambahKarungInitialized = false;
  let pindahLokasiInitialized = false;
  let inputPalletInitialized = false;
  let cekKarungInitialized = false;
  let gabungKarungInitialized = false;
  let pickingSlipInitialized = false;
let riwayatPickingSlipInitialized = false;

// ===== Riwayat Picking Slip (Print Ulang saja) â€” Global Safe Implementation =====
// Catatan: implementasi ini sengaja berdiri sendiri agar tidak bergantung pada block-scope lain.
// Aksi: cari header picking_slip + hitung total dari picking_slip_detail, lalu Print Ulang via openPickingSlipWindow().

async function initRiwayatPickingSlipOnce() {
  if (riwayatPickingSlipInitialized) return;
  riwayatPickingSlipInitialized = true;

  const rpsUserInfoEl = document.getElementById('rps-userInfo');
  const rpsKeywordEl  = document.getElementById('rps-keyword');
  const rpsDateFromEl = document.getElementById('rps-date-from');
  const rpsDateToEl   = document.getElementById('rps-date-to');
  const rpsBtnSearch  = document.getElementById('rps-btn-search');
  const rpsStatusEl   = document.getElementById('rps-status');
  const rpsTableEl    = document.getElementById('rps-table');
  const rpsTbodyEl    = document.getElementById('rps-tbody');

  const setStatus = (msg, type) => {
    if (!rpsStatusEl) return;
    rpsStatusEl.textContent = msg || '';
    rpsStatusEl.className = 'status' + (type ? (' ' + type) : '');
  };

  const toISODateLocal = (d) => {
    const tz = d.getTimezoneOffset() * 60000;
    return new Date(d.getTime() - tz).toISOString().slice(0,10);
  };

  // tampilkan user info
  if (rpsUserInfoEl && operatorDisplayName) {
    const r = currentProfile && currentProfile.role ? currentProfile.role : 'operator';
    rpsUserInfoEl.textContent = operatorDisplayName + (r ? ` (${r})` : '');
  }

  // default tanggal: 7 hari terakhir
  const now = new Date();
  if (rpsDateToEl && !rpsDateToEl.value) rpsDateToEl.value = toISODateLocal(now);
  if (rpsDateFromEl && !rpsDateFromEl.value) {
    const d = new Date(now.getTime() - 6*24*60*60*1000);
    rpsDateFromEl.value = toISODateLocal(d);
  }

  const fetchTotalsBySlipIds = async (ids) => {
    if (!ids || ids.length === 0) return {};
    // Ambil detail untuk slip yang tampil (maks 50)
    const { data, error } = await sb
      .from('picking_slip_detail')
      .select('picking_slip_id, karung_id, qty_ekor_keluar, qty_kg_keluar')
      .in('picking_slip_id', ids);
    if (error) throw error;

    const map = {};
    (data || []).forEach(r => {
      const id = r.picking_slip_id;
      if (!map[id]) map[id] = { karung: 0, ekor: 0, kg: 0 };
      map[id].karung += 1;
      map[id].ekor += Number(r.qty_ekor_keluar || 0);
      map[id].kg   += Number(r.qty_kg_keluar || 0);
    });
    return map;
  };

  const fetchItemNameMap = async (itemIds) => {
    const uniq = Array.from(new Set((itemIds || []).filter(Boolean)));
    if (uniq.length === 0) return {};
    const { data, error } = await sb
      .from('items')
      .select('item_id, item_name')
      .in('item_id', uniq);
    if (error) throw error;
    const m = {};
    (data || []).forEach(x => { m[x.item_id] = x.item_name; });
    return m;
  };

  const printSlipById = async (slipId) => {
    setStatus('Memuat data picking slip...', '');
    const { data: hdr, error: e1 } = await sb
      .from('picking_slip')
      .select('*')
      .eq('id', slipId)
      .single();
    if (e1) { console.error(e1); setStatus('Gagal memuat header: ' + (e1.message || ''), 'error'); return; }

    const { data: det, error: e2 } = await sb
      .from('picking_slip_detail')
      .select('*')
      .eq('picking_slip_id', slipId);
    if (e2) { console.error(e2); setStatus('Gagal memuat detail: ' + (e2.message || ''), 'error'); return; }

    // Lengkapi item_name untuk template print (jika belum ada)
    const itemIds = (det || []).map(x => x.item_id);
    let itemNameMap = {};
    try { itemNameMap = await fetchItemNameMap(itemIds); } catch (e) { console.warn('item name map failed', e); }

    const detail = (det || []).map(x => ({
      ...x,
      item_name: x.item_name || itemNameMap[x.item_id] || x.item_id || 'UNKNOWN'
    }));

    setStatus('Membuka jendela print...', 'success');
    try {
      openPickingSlipWindow(hdr.no_picking_slip || '(tanpa nomor)', hdr, detail);
    } catch (e) {
      console.error(e);
      setStatus('Gagal membuka jendela print: ' + (e.message || ''), 'error');
    }
  };

  const renderRows = (rows, totalsMap) => {
    if (!rpsTbodyEl || !rpsTableEl) return;
    rpsTbodyEl.innerHTML = '';

    (rows || []).forEach(r => {
      const t = totalsMap && totalsMap[r.id] ? totalsMap[r.id] : { karung: 0, ekor: 0, kg: 0 };

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(r.tgl_picking || '')}</td>
        <td><strong>${escapeHtml(r.no_picking_slip || '')}</strong></td>
        <td>${escapeHtml(r.tujuan || '')}</td>
        <td>${escapeHtml(r.nama_customer || '')}</td>
        <td style="text-align:right;">${Number(t.karung || 0)}</td>
        <td style="text-align:right;">${Number(t.ekor || 0)}</td>
        <td style="text-align:right;">${Number(t.kg || 0).toFixed(2)}</td>
        <td>
          <button class="btn btn-primary btn-small" data-action="print">Print Ulang</button>
        </td>
      `;

      const btn = tr.querySelector('button[data-action="print"]');
      if (btn) {
        btn.addEventListener('click', () => printSlipById(r.id));
      }

      rpsTbodyEl.appendChild(tr);
    });

    rpsTableEl.style.display = (rows && rows.length) ? 'table' : 'none';
  };

  
  // Pagination (default: 50 per page). Data tidak dimuat sebelum klik "Cari".
  const PAGE_SIZE = 50;
  let currentPage = 1;
  let lastCount = 0;
  let hasSearched = false;
  let lastFilters = null;

  const rpsPaginationEl = document.getElementById('rps-pagination');
  const rpsBtnPrev = document.getElementById('rps-btn-prev');
  const rpsBtnNext = document.getElementById('rps-btn-next');
  const rpsPageInfo = document.getElementById('rps-page-info');
  const rpsCountInfo = document.getElementById('rps-count-info');

  const getFilters = () => {
    const keyword = (rpsKeywordEl && rpsKeywordEl.value) ? rpsKeywordEl.value.trim() : '';
    const dateFrom = (rpsDateFromEl && rpsDateFromEl.value) ? rpsDateFromEl.value : '';
    const dateTo   = (rpsDateToEl && rpsDateToEl.value) ? rpsDateToEl.value : '';
    return { keyword, dateFrom, dateTo };
  };

  const updatePagerUI = () => {
    if (!rpsPaginationEl) return;

    if (!hasSearched) {
      rpsPaginationEl.style.display = 'none';
      return;
    }

    rpsPaginationEl.style.display = 'flex';

    const totalPages = lastCount ? Math.max(1, Math.ceil(lastCount / PAGE_SIZE)) : 1;
    if (rpsPageInfo) rpsPageInfo.textContent = `Page ${currentPage} / ${totalPages}`;
    if (rpsCountInfo) rpsCountInfo.textContent = lastCount ? `Total: ${lastCount}` : '';

    if (rpsBtnPrev) rpsBtnPrev.disabled = (currentPage <= 1);
    if (rpsBtnNext) rpsBtnNext.disabled = (currentPage >= totalPages);
  };

  const loadPage = async () => {
    if (!hasSearched) return;

    const filters = lastFilters || getFilters();
    const from = (currentPage - 1) * PAGE_SIZE;
    const to = from + PAGE_SIZE - 1;

    try {
      setStatus('Mengambil data...', 'info');
      if (rpsTableEl) rpsTableEl.style.display = 'none';
      if (rpsTbodyEl) rpsTbodyEl.innerHTML = '';

      let q = sb
        .from('picking_slip')
        .select('id, no_picking_slip, tgl_picking, tujuan, nama_customer, no_so, status, created_at', { count: 'exact' })
        .order('tgl_picking', { ascending: false })
        .order('created_at', { ascending: false })
        .range(from, to);

      if (filters.dateFrom) q = q.gte('tgl_picking', filters.dateFrom);
      if (filters.dateTo)   q = q.lte('tgl_picking', filters.dateTo);

      // Keyword search hanya pada kolom text (hindari ILIKE pada enum tujuan).
      if (filters.keyword) {
        const kw = filters.keyword.replace(/%/g, '\\%').replace(/_/g, '\\_');
        q = q.or(`no_picking_slip.ilike.%${kw}%,nama_customer.ilike.%${kw}%,no_so.ilike.%${kw}%`);
      }

      const { data, error, count } = await q;
      if (error) throw error;

      const rows = data || [];
      lastCount = (typeof count === 'number') ? count : (rows.length ? rows.length : 0);

      if (rows.length === 0) {
        if (rpsTableEl) rpsTableEl.style.display = 'none';
        setStatus('Tidak ada data.', 'warning');
        updatePagerUI();
        return;
      }

      try {
        const totalsMap = await fetchTotalsBySlipIds(rows.map(r => r.id));
        setStatus(`Menampilkan ${rows.length} data.`, 'success');
        renderRows(rows, totalsMap);
      } catch (e) {
        console.error(e);
        setStatus('Data header ditemukan, tapi gagal hitung total detail: ' + (e.message || ''), 'error');
        renderRows(rows, {});
      }

      updatePagerUI();
    } catch (e) {
      console.error(e);
      setStatus('Gagal mencari: ' + (e.message || ''), 'error');
      lastCount = 0;
      updatePagerUI();
    }
  };

  const search = async () => {
    hasSearched = true;
    currentPage = 1;
    lastFilters = getFilters();
    await loadPage();
  };

  if (rpsBtnSearch) rpsBtnSearch.addEventListener('click', () => { search(); });
  if (rpsKeywordEl) rpsKeywordEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') search(); });

  if (rpsBtnPrev) rpsBtnPrev.addEventListener('click', async () => {
    if (!hasSearched) return;
    if (currentPage <= 1) return;
    currentPage -= 1;
    await loadPage();
  });

  if (rpsBtnNext) rpsBtnNext.addEventListener('click', async () => {
    if (!hasSearched) return;
    const totalPages = lastCount ? Math.max(1, Math.ceil(lastCount / PAGE_SIZE)) : 1;
    if (currentPage >= totalPages) return;
    currentPage += 1;
    await loadPage();
  });

  // Pastikan awalnya tidak memuat data
  updatePagerUI();

}
  let laporanStokInitialized = false;
  let laporanStokSemuaInitialized = false;
  let laporanBatchInitialized  = false;
  let laporanMutasiInitialized = false;

  // ====== LOGIN FLOW ======
  function showLoginPage() {
    loginPage.style.display = 'flex';
    appPage.style.display = 'none';
  }
  function showAppPage() {
    loginPage.style.display = 'none';
    appPage.style.display = 'block';
    if (window.innerWidth <= 768) {
      appShellEl.classList.add('mobile-sidebar-collapsed');
    } else {
      appShellEl.classList.remove('mobile-sidebar-collapsed');
    }
  }

  loginBtn.addEventListener('click', async () => {
    loginError.textContent = '';
    const email = loginEmail.value.trim();
    const password = loginPass.value;
    if (!email || !password) {
      loginError.textContent = 'Email dan password wajib diisi.';
      return;
    }
    const { error } = await sb.auth.signInWithPassword({ email, password });
    if (error) {
      console.error(error);
      loginError.textContent = error.message || 'Login gagal.';
      return;
    }
    await loadProfileAndShowApp();
  });

  logoutBtn.addEventListener('click', async () => {
    await sb.auth.signOut();
    loginEmail.value = '';
    loginPass.value = '';
    showLoginPage();
  });

  window.addEventListener('load', async () => {
    const { data } = await sb.auth.getSession();
    if (data.session) {
      await loadProfileAndShowApp();
    } else {
      showLoginPage();
    }
  });

  async function loadProfileAndShowApp() {
    const { data: { user } } = await sb.auth.getUser();
    if (!user) {
      showLoginPage();
      return;
    }
    currentUser = user;

    let fullName = user.email;
    let role = 'operator';

    const { data: profile } = await sb
      .from('profiles')
      .select('full_name, role, is_active')
      .eq('id', user.id)
      .maybeSingle();

    currentProfile = profile || null;
    if (profile) {
      if (profile.full_name) fullName = profile.full_name;
      if (profile.role) role = profile.role;
      if (profile.is_active === false) {
        alert('Akun anda non-aktif. Silakan hubungi admin.');
        await sb.auth.signOut();
        showLoginPage();
        return;
      }
    }

    operatorDisplayName = fullName;

    // Role-based menu visibility (only toggle items that are explicitly hidden)
    try {
      const r = (role || '').toLowerCase();
      const canSeeSupervisorAdmin = (r === 'admin' || r === 'supervisor');
      document.querySelectorAll('.menu-supervisor-admin').forEach(el => {
        el.style.display = canSeeSupervisorAdmin ? 'block' : 'none';
      });
    } catch (e) {
      console.warn('menu visibility error', e);
    }

    userInfoEl.innerHTML = `
      ${fullName} <span class="badge-role">${role}</span><br/>
      <span style="font-size:0.75rem; color:#9ca3af;">${user.email}</span>
    `;

    showAppPage();
    showPage('dashboard');

    await initTambahKarungOnce();
    await initPindahLokasiOnce();
  }

  // ====== MENU HANDLER ======
  menuButtons.forEach(btn => {
    btn.addEventListener('click', async () => {
      const page = btn.dataset.page;
      setActiveMenu(page);
      showPage(page);

      if (page === 'form-tambah-karung') {
        await initTambahKarungOnce();
      }
      if (page === 'form-buat-karung-draft') {
        await initBuatKarungDraftOnce();
      }
      if (page === 'form-receipt-slip') {
        await initReceiptSlipOnce();
      }
      if (page === 'form-tambah-batch') {
      await initFormTambahBatchOnce();
      }
      if (page === 'form-pindah-lokasi') {
        await initPindahLokasiOnce();
      }
      if (page === 'form-input-pallet') {
        await initInputPalletOnce();
      }
      if (page === 'form-cek-karung') {
        await initCekKarungOnce();
      }
      if (page === 'form-revisi-karung') {
        await initRevisiKarungOnce();
      }
      if (page === 'form-gabung-karung') {
        await initGabungKarungOnce();
      }
      if (page === 'form-picking-slip') {
      await initPickingSlipOnce();
      }
      if (page === 'riwayat-picking-slip') {
        await initRiwayatPickingSlipOnce();
      }
      if (page === 'laporan-stok') {
        await initLaporanStokOnce();
      }
      if (page === 'laporan-stok-semua') {
        await initLaporanStokSemuaOnce();
      }
      if (page === 'laporan-batch') {
      await initLaporanBatchOnce();
      }
      if (page === 'laporan-mutasi') {
      await initLaporanMutasiOnce();
      }
      if (window.innerWidth <= 768) {
        appShellEl.classList.add('mobile-sidebar-collapsed');
      }
    });
  });

  function setActiveMenu(page) {
    menuButtons.forEach(btn => {
      if (btn.dataset.page === page) btn.classList.add('active');
      else btn.classList.remove('active');
    });
  }

  function setPageVisible(el, visible) {
    if (!el) return;
    el.style.display = visible ? 'block' : 'none';
  }

  function showPage(page) {
    setPageVisible(pageDashboard,        (page === 'dashboard' || !page));
    setPageVisible(pageFormTambahKarung, (page === 'form-tambah-karung'));
    setPageVisible(pageFormBuatKarungDraft, (page === 'form-buat-karung-draft'));
    setPageVisible(pageFormReceiptSlip,  (page === 'form-receipt-slip'));
    setPageVisible(pageFormPindahLokasi, (page === 'form-pindah-lokasi'));
    setPageVisible(pageFormInputPallet,  (page === 'form-input-pallet'));
    setPageVisible(pageFormCekKarung,    (page === 'form-cek-karung'));
    setPageVisible(pageFormRevisiKarung,(page === 'form-revisi-karung'));
    setPageVisible(pageFormGabungKarung, (page === 'form-gabung-karung'));
    setPageVisible(pageFormTambahBatch,  (page === 'form-tambah-batch'));
    setPageVisible(pageFormPickingSlip,  (page === 'form-picking-slip'));
    setPageVisible(pageRiwayatPickingSlip,(page === 'riwayat-picking-slip'));
    setPageVisible(pageLaporanBatch,     (page === 'laporan-batch'));
    setPageVisible(pageLaporanStok,      (page === 'laporan-stok'));
    setPageVisible(pageLaporanStokSemua, (page === 'laporan-stok-semua'));
    setPageVisible(pageLaporanMutasi,    (page === 'laporan-mutasi'));
  }


  toggleSidebarBtn.addEventListener('click', () => {
    appShellEl.classList.toggle('mobile-sidebar-collapsed');
  });
  window.addEventListener('resize', () => {
    if (window.innerWidth > 768) appShellEl.classList.remove('mobile-sidebar-collapsed');
    else appShellEl.classList.add('mobile-sidebar-collapsed');
  });

  // ============== FORM TAMBAH KARUNG LOGIC ==============

  const RAK_OPTIONS = [
    "RAK-01","RAK-02","RAK-03","RAK-04","RAK-05",
    "RAK-06","RAK-07","RAK-08","RAK-09","RAK-10",
    "RAK-11","RAK-12","RAK-13","RAK-14","RAK-15",
    "RAK-16","RAK-17","RAK-18","RAK-19","RAK-20"
  ];

  let items = [];
  let lastPreviewData = {};
  let lastRakStructure = [];

  const tglAbfInput       = document.getElementById('tglAbf');
  const batchSelect       = document.getElementById('batchSelect');
  const shiftAbfInput     = document.getElementById('shiftAbf');
  const itemSearchInput   = document.getElementById('itemSearch');
  const itemSelect        = document.getElementById('itemSelect');
  const selectedItemIdInp = document.getElementById('selectedItemId');
  const tglProduksiInput  = document.getElementById('tglProduksi');
  const operatorInput2    = document.getElementById('operatorName');
  const catatanInput      = document.getElementById('catatan');
  const rakTbody          = document.getElementById('rakTbody');
  const totalEkorSpan     = document.getElementById('totalEkor');
  const totalKgSpan       = document.getElementById('totalKg');
  const confirmBox        = document.getElementById('confirmBox');
  const btnSubmitNew      = document.getElementById('btnSubmitNew');
  const btnClear          = document.getElementById('btnClear');
  const statusMessage     = document.getElementById('statusMessage');
  const btnPreview        = document.getElementById('btnPreview');
  const btnTambahRak      = document.getElementById('btnTambahRak');
  const tkUserInfo        = document.getElementById('tk-userInfo');

  async function initTambahKarungOnce() {
    if (tambahKarungInitialized) return;
    tambahKarungInitialized = true;

    if (operatorInput2 && operatorDisplayName) {
      operatorInput2.value = operatorDisplayName;
    }
    if (tkUserInfo && operatorDisplayName) {
      const r = currentProfile && currentProfile.role ? currentProfile.role : 'operator';
      tkUserInfo.textContent = operatorDisplayName + (r ? ` (${r})` : '');
    }

    statusMessage.textContent = 'Memuat data item...';
    statusMessage.className = 'status';

    const { data: itemData, error: itemError } = await sb
      .from('items')
      .select('item_id, item_name')
      .order('item_name', { ascending: true });

    if (itemError) {
      console.error(itemError);
      statusMessage.textContent = 'Gagal memuat items: ' + itemError.message;
      statusMessage.className = 'status error';
      return;
    }

    items = itemData || [];
    populateItemOptions(items);
    statusMessage.textContent = 'Form Tambah Karung siap digunakan.';
    statusMessage.className = 'status success';

    if (rakTbody.children.length === 0) {
      addRakRow();
    }

    tglAbfInput.addEventListener('change', handleTglAbfChange);
    batchSelect.addEventListener('change', () => {
      const opt = batchSelect.options[batchSelect.selectedIndex];
      shiftAbfInput.value = opt && opt.dataset.shift ? opt.dataset.shift : '';
    });
    itemSearchInput.addEventListener('input', filterItemOptions);
    itemSelect.addEventListener('change', onItemChange);
    btnTambahRak.addEventListener('click', () => addRakRow());
    btnPreview.addEventListener('click', handleSavePreview);
    btnSubmitNew.addEventListener('click', () => handleSubmit());
    btnClear.addEventListener('click', handleClearForm);
  }

  
  // ==============================
  // FORM BUAT KARUNG ID (DRAFT)
  // ==============================
  let buatDraftInitialized = false;

  async function initBuatKarungDraftOnce() {
    if (buatDraftInitialized) return;
    buatDraftInitialized = true;

    const bdUserInfo = document.getElementById('bd-userInfo');
    const bdItemSel  = document.getElementById('bd-item');
    const bdTglProd  = document.getElementById('bd-tgl-produksi');
    const bdEkor     = document.getElementById('bd-ekor');
    const bdKg       = document.getElementById('bd-kg');
    const bdSaldoAwalWrap = document.getElementById('bd-saldo-awal-wrap');
    const bdSaldoAwalChk  = document.getElementById('bd-saldo-awal');
    const bdGenerate = document.getElementById('bd-generate');
    const bdClear    = document.getElementById('bd-clear');
    const bdStatus   = document.getElementById('bd-status');

    // Admin-only: tampilkan checkbox saldo awal
    try {
      const role = (currentProfile?.role || '').toLowerCase();
      const isAdmin = (role === 'admin');
      if (bdSaldoAwalWrap) bdSaldoAwalWrap.style.display = isAdmin ? 'block' : 'none';
      if (!isAdmin && bdSaldoAwalChk) bdSaldoAwalChk.checked = false;
    } catch (e) {
      console.warn('bd saldo awal visibility error', e);
      if (bdSaldoAwalWrap) bdSaldoAwalWrap.style.display = 'none';
    }

    async function bdAutoPostSaldoAwal(karungId) {
      // Membuat Receipt Slip draft â†’ add line â†’ set qty â†’ post sumber=awal
      // Tujuan: karung draft langsung dianggap masuk sebagai saldo awal.
      const role = (currentProfile?.role || '').toLowerCase();
      if (role !== 'admin') throw new Error('Akses ditolak (admin saja).');
      if (!karungId) throw new Error('karung_id tidak valid.');

      // 1) Create receipt draft
      const { data: hdr, error: e1 } = await sb.rpc('fn_receipt_create_draft', {});
      if (e1) throw e1;
      const receiptId = hdr?.receipt_id;
      if (!receiptId) throw new Error('Gagal membuat receipt draft (receipt_id kosong).');

      // 2) Add line
      const { error: e2 } = await sb.rpc('fn_receipt_add_line', {
        p_receipt_id: receiptId,
        p_karung_id: karungId
      });
      if (e2) throw e2;

      // 3) Pastikan qty line sesuai input form (jaga-jaga kalau default 0)
      // Ambil line terakhir utk karung tsb
      const { data: lines, error: e3 } = await sb
        .from('barang_masuk_receipt_line')
        .select('line_id, karung_id_input')
        .eq('receipt_id', receiptId)
        .eq('karung_id_input', karungId)
        .order('line_id', { ascending: false })
        .limit(1);
      if (e3) throw e3;
      const lineId = lines && lines[0] ? lines[0].line_id : null;
      if (!lineId) throw new Error('Gagal menemukan receipt line untuk karung ini.');

      const qtyEkor = parseInt(bdEkor.value || '0', 10) || 0;
      const qtyKg   = parseFloat(bdKg.value || '0') || 0;
      const { error: e4 } = await sb.rpc('fn_receipt_update_line_qty', {
        p_line_id: lineId,
        p_qty_ekor: qtyEkor,
        p_qty_kg: qtyKg
      });
      if (e4) throw e4;

      // 4) Post receipt (saldo awal)
      const today = new Date();
      const tglTerima = new Date(Date.UTC(today.getFullYear(), today.getMonth(), today.getDate()))
        .toISOString().slice(0, 10);
      const { error: e5 } = await sb.rpc('fn_receipt_post2', {
        p_receipt_id: receiptId,
        p_tgl_terima: tglTerima,
        p_sumber: 'awal',
        p_gudang_asal: null,
        p_keterangan: 'saldo awal (auto)',
        p_operator: operatorDisplayName || null
      });
      if (e5) throw e5;

      return { receipt_id: receiptId, receipt_no: hdr?.receipt_no || null };
    }

    if (bdUserInfo && operatorDisplayName) {
      const r = currentProfile && currentProfile.role ? currentProfile.role : 'operator';
      bdUserInfo.textContent = operatorDisplayName + (r ? ` (${r})` : '');
    }

    bdStatus.textContent = 'Memuat data item...';
    bdStatus.className = 'status';

    const { data: itemData, error: itemError } = await sb
      .from('items')
      .select('item_id, item_name')
      .order('item_name', { ascending: true });

    if (itemError) {
      bdStatus.textContent = 'Gagal memuat items: ' + itemError.message;
      bdStatus.className = 'status error';
      return;
    }

    const list = itemData || [];
    bdItemSel.innerHTML = '';
    list.forEach(item => {
      const opt = document.createElement('option');
      opt.value = item.item_id;
      opt.textContent = item.item_name;
      bdItemSel.appendChild(opt);
    });

    bdStatus.textContent = 'Siap. Isi data lalu klik Generate & Print.';
    bdStatus.className = 'status success';

    bdGenerate.addEventListener('click', async () => {
      bdGenerate.disabled = true;
      bdStatus.textContent = 'Membuat karung_id draft...';
      bdStatus.className = 'status';

      try {
        const role = (currentProfile?.role || '').toLowerCase();
        const isAdmin = (role === 'admin');
        const isSaldoAwal = isAdmin && !!(bdSaldoAwalChk && bdSaldoAwalChk.checked);

        const itemId = (bdItemSel.value || '').trim();
        const tglProduksi = (bdTglProd.value || '').trim();
        const qtyEkor = parseInt(bdEkor.value || '0', 10) || 0;
        const qtyKg = parseFloat(bdKg.value || '0') || 0;
if (!itemId) throw new Error('Item wajib dipilih.');
        if (!tglProduksi) throw new Error('Tgl Produksi wajib diisi.');
        if (qtyEkor <= 0 && qtyKg <= 0) throw new Error('Minimal isi Ekor atau Kg (> 0).');

        // RPC: membuat row stok_karung dengan status = draft
        const { data, error } = await sb.rpc('rpc_create_draft_karung', {
          p_item_id: itemId,
          p_qty_ekor: qtyEkor,
          p_qty_kg: qtyKg,
          p_tgl_produksi: tglProduksi
        });

        if (error) throw error;

        const row = Array.isArray(data) ? data[0] : data;
        const karungId = row && row.karung_id ? row.karung_id : null;
        if (!karungId) throw new Error('RPC tidak mengembalikan karung_id.');

        // Ambil item name untuk label
        const itemName = bdItemSel.options[bdItemSel.selectedIndex]?.textContent || 'ITEM';
        const catatan = '';

        bdStatus.textContent = 'Berhasil membuat draft: ' + karungId + '. Membuka jendela print...';
        bdStatus.className = 'status success';

        // Print label (1 karung, non-bulk)
        openLabelWindow(karungId, {
          itemName,
          tglProduksi,
          totalEkor: qtyEkor,
          totalKg: qtyKg,
          catatan});

        // Jika admin mencentang saldo awal, otomatis posting receipt sumber=awal
        if (isSaldoAwal) {
          bdStatus.textContent = 'Label dicetak. Mem-posting sebagai saldo awal...';
          bdStatus.className = 'status';
          try {
            const posted = await bdAutoPostSaldoAwal(karungId);
            const noTxt = posted?.receipt_no ? ` (Receipt: ${posted.receipt_no})` : '';
            bdStatus.textContent = 'Saldo awal berhasil diposting untuk ' + karungId + noTxt;
            bdStatus.className = 'status success';
          } catch (e) {
            console.error(e);
            bdStatus.textContent = 'Karung draft berhasil dibuat, tapi gagal auto saldo awal: ' + (e?.message || e);
            bdStatus.className = 'status error';
          }
        }

        // Reset form untuk input berikutnya
        bdEkor.value = '';
        bdKg.value = '';
bdTglProd.focus();
      } catch (err) {
        const msg = err?.message || String(err);
        bdStatus.textContent = 'Gagal: ' + msg;
        bdStatus.className = 'status error';
      } finally {
        bdGenerate.disabled = false;
      }
    });

    bdClear.addEventListener('click', () => {
      bdTglProd.value = '';
      bdEkor.value = '';
      bdKg.value = '';
      if (bdSaldoAwalChk) bdSaldoAwalChk.checked = false;
bdStatus.textContent = 'Form dikosongkan.';
      bdStatus.className = 'status';
    });
  }


  // ==============================
  // FORM RECEIPT SLIP
  // ==============================
  let receiptInitialized = false;
  let currentReceiptId = null;
  let currentReceiptNo = null;
  let receiptStatus = 'draft';
  let receiptLines = []; // {line_id, karung_id_input, item_id, item_name, qty_ekor, qty_kg, tgl_produksi}

  const BEEP_OK_SRC  = "data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAIlYAAESsAAACABAAZGF0YQAAAAA="; // tiny silent-ish (fallback)
  const beepOk = new Audio(BEEP_OK_SRC);
  const beepErr = new Audio(BEEP_OK_SRC);

  function rsSetStatus(msg, type='ok') {
    const el = document.getElementById('rs-status');
    if (!el) return;
    el.className = 'status ' + (type === 'error' ? 'status-error' : 'status-ok');
    el.textContent = msg || '';
    if (!msg) el.className = 'status';
  }

  function rsMaybeBeep(isOk) {
    const enabled = document.getElementById('rs-beep')?.checked;
    if (!enabled) return;
    try {
      (isOk ? beepOk : beepErr).currentTime = 0;
      beep(isOk ? 880 : 220, 90);
    } catch {}
  }

  async function rsLoadSumberMasukEnum() {
    // enum sumber_masuk_enum via RPC (kita buat SQL-nya)
    const sel = document.getElementById('rs-gudang-asal');
    if (!sel) return;
    sel.innerHTML = '<option value="">-- Pilih gudang asal --</option>';
    const { data, error } = await sb.rpc('fn_list_gudang_asal_options');
    if (error) {
      console.warn('fn_list_gudang_asal_options error', error);
      // fallback: tetap kosong, user bisa ketik di catatan bila perlu
      return;
    }
    (data || []).forEach(row => {
      const opt = document.createElement('option');
      opt.value = row.gudang_id;
      opt.textContent = (row.nama_gudang ? row.nama_gudang + ' (' + row.gudang_id + ')' : row.gudang_id);
      sel.appendChild(opt);
    });
  }

  function rsRenderHeader() {
    document.getElementById('rs-no').value = currentReceiptNo || '';
    document.getElementById('rs-badge').textContent = (receiptStatus || 'draft').toUpperCase();
    document.getElementById('rs-userInfo').textContent = operatorDisplayName || '';
  }

  function rsCalcSummary() {
    let totalKarung = receiptLines.length;
    let totalEkor = 0;
    let totalKg = 0;
    receiptLines.forEach(l => {
      totalEkor += Number(l.qty_ekor || 0);
      totalKg += Number(l.qty_kg || 0);
    });
    document.getElementById('rs-summary').textContent =
      `${totalKarung} karung, ${totalEkor} ekor, ${totalKg.toFixed(2)} kg`;
  }

  function rsRenderTable() {
    const tbody = document.querySelector('#rs-table tbody');
    tbody.innerHTML = '';
    receiptLines.forEach((l, idx) => {
      const tr = document.createElement('tr');

      tr.innerHTML = `
        <td>${idx+1}</td>
        <td><code>${escapeHtml(l.karung_id_input || '')}</code></td>
        <td>${escapeHtml(l.item_name || '')}</td>
        <td><input type="number" min="0" step="1" value="${l.qty_ekor ?? ''}" data-line-id="${l.line_id}" data-field="qty_ekor" class="rs-edit" style="width:80px;"></td>
        <td><input type="number" min="0" step="0.01" value="${l.qty_kg ?? ''}" data-line-id="${l.line_id}" data-field="qty_kg" class="rs-edit" style="width:95px;"></td>
        <td>${escapeHtml(l.tgl_produksi || '')}</td>
        <td><button class="btn-small btn-ghost rs-remove" data-line-id="${l.line_id}">Hapus</button></td>
      `;
      tbody.appendChild(tr);
    });

    // attach listeners
    tbody.querySelectorAll('.rs-remove').forEach(btn => {
      btn.addEventListener('click', async () => {
        const lineId = Number(btn.dataset.lineId);
        if (!confirm('Hapus baris ini?')) return;
        await rsRemoveLine(lineId);
      });
    });

    // debounce edits
    let debounceTimer = null;
    tbody.querySelectorAll('.rs-edit').forEach(inp => {
      inp.addEventListener('input', () => {
        if (debounceTimer) clearTimeout(debounceTimer);
        debounceTimer = setTimeout(async () => {
          const lineId = Number(inp.dataset.lineId);
          const field = inp.dataset.field;
          const row = receiptLines.find(x => Number(x.line_id) === lineId);
          if (!row) return;

          const newVal = inp.value;
          if (field === 'qty_ekor') {
            const v = parseInt(newVal, 10);
            if (isNaN(v) || v < 0) { rsSetStatus('Ekor tidak valid', 'error'); return; }
            row.qty_ekor = v;
          } else {
            const v = Number(newVal);
            if (!isFinite(v) || v <= 0) { rsSetStatus('Kg harus > 0', 'error'); return; }
            row.qty_kg = v;
          }
          rsCalcSummary();
          await rsUpdateLine(lineId, row.qty_ekor, row.qty_kg);
        }, 600);
      });
    });

    rsCalcSummary();
  }

  async function rsCreateDraft() {
    const { data, error } = await sb.rpc('fn_receipt_create_draft', {});
    if (error) throw error;
    currentReceiptId = data.receipt_id;
    currentReceiptNo = data.receipt_no;
    receiptStatus = data.status || 'draft';
    rsRenderHeader();
  }

  async function rsFetchLines() {
    if (!currentReceiptId) return;
    // Ambil line + item name (via query items terpisah untuk safety)
    const { data: lines, error } = await sb
      .from('barang_masuk_receipt_line')
      .select('line_id, karung_id_input, item_id, qty_ekor, qty_kg, tgl_produksi')
      .eq('receipt_id', currentReceiptId)
      .order('line_id', { ascending: true });

    if (error) throw error;
    const itemIds = Array.from(new Set((lines||[]).map(x => x.item_id).filter(Boolean)));
    let itemMap = {};
    if (itemIds.length) {
      const { data: items, error: e2 } = await sb
        .from('items')
        .select('item_id, item_name')
        .in('item_id', itemIds);
      if (!e2) {
        (items||[]).forEach(it => itemMap[it.item_id] = it.item_name);
      }
    }
    receiptLines = (lines||[]).map(l => ({
      ...l,
      item_name: itemMap[l.item_id] || l.item_id
    }));
    rsRenderTable();
  }

  // NOTE: Header autosave to DB was removed because the user's DB enforces header validation at POST
  // and some projects have RLS/REST conflicts that return 409. We keep header state in UI and send
  // it at posting time (fn_receipt_post2 will persist it atomically before posting).
  async function rsSaveHeader() {
    // no-op (UI only)
    return;
  }

  async function rsLookupKarung(karungId) {
    const { data: sk, error } = await sb
      .from('stok_karung')
      .select('karung_id,item_id,qty_ekor,qty_kg,qty_ekor_sisa,qty_kg_sisa,tgl_produksi,status_karung')
      .eq('karung_id', karungId)
      .maybeSingle();
    if (error) throw error;
    if (!sk) return { ok:false, message:'Karung tidak ditemukan' };

    const statusTxt = (sk.status_karung || '').toString();
    if (statusTxt === 'tersedia' || statusTxt === 'terbuka') {
      return { ok:false, message:'karung ini masih ada di gudang' };
    }
    if (statusTxt !== 'habis' && statusTxt !== 'draft') {
      // fallback: bila enum tidak ada draft, tetap hanya izinkan habis
      // namun kita tetap toleran: selain tersedia/terbuka -> ditolak jelas
      return { ok:false, message:`Status karung tidak valid untuk receipt: ${statusTxt}` };
    }
    return { ok:true, sk };
  }

  async function rsAddKarung(rawId) {
    // Buat draft otomatis saat karung pertama ditambahkan
    if (!currentReceiptId) {
      await rsCreateDraft();
      await rsFetchLines();
    }

    const karungId = normalizeKarungId(rawId);
    if (!karungId) return;

    // Prevent duplicate in UI quickly
    if (receiptLines.some(l => (l.karung_id_input || '') === karungId)) {
      rsSetStatus('Karung sudah ada di daftar', 'error');
      rsMaybeBeep(false);
      return;
    }

    // Quick precheck (better UX), final check enforced by RPC add_line
    const pre = await rsLookupKarung(karungId);
    if (!pre.ok) {
      rsSetStatus(pre.message, 'error');
      rsMaybeBeep(false);
      return;
    }

    const { data, error } = await sb.rpc('fn_receipt_add_line', {
      p_receipt_id: currentReceiptId,
      p_karung_id: karungId
    });
    if (error) {
      rsSetStatus(error.message || 'Gagal tambah karung', 'error');
      rsMaybeBeep(false);
      return;
    }

    rsSetStatus('Karung ditambahkan', 'ok');
    rsMaybeBeep(true);
    await rsFetchLines();
  }

  async function rsUpdateLine(lineId, qtyEkor, qtyKg) {
    const { error } = await sb.rpc('fn_receipt_update_line_qty', {
      p_line_id: lineId,
      p_qty_ekor: qtyEkor,
      p_qty_kg: qtyKg
    });
    if (error) {
      rsSetStatus(error.message || 'Gagal menyimpan baris', 'error');
      rsMaybeBeep(false);
    } else {
      rsSetStatus('Perubahan tersimpan.', 'ok');
    }
  }

  async function rsRemoveLine(lineId) {
    const { error } = await sb.rpc('fn_receipt_remove_line', { p_line_id: lineId });
    if (error) {
      rsSetStatus(error.message || 'Gagal hapus baris', 'error');
      return;
    }
    await rsFetchLines();
    rsSetStatus('Baris dihapus.', 'ok');
  }

  function rsValidateBeforePost() {
    const sumber = document.getElementById('rs-sumber').value;
    const gudangAsal = document.getElementById('rs-gudang-asal').value;
    const pelanggan = document.getElementById('rs-pelanggan').value.trim();

    if (!sumber) return 'Sumber wajib dipilih';
    if (sumber === 'dari_lokasi_lain' && !gudangAsal) return 'Gudang asal wajib diisi';
    if (sumber === 'retur' && !pelanggan) return 'Nama pelanggan wajib diisi';
    if (!receiptLines.length) return 'Minimal 1 karung';
    // qty checks
    for (const l of receiptLines) {
      if (!Number.isFinite(Number(l.qty_kg)) || Number(l.qty_kg) <= 0) return `Kg tidak valid pada ${l.karung_id_input}`;
      if (!Number.isFinite(Number(l.qty_ekor)) || Number(l.qty_ekor) < 0) return `Ekor tidak valid pada ${l.karung_id_input}`;
    }
    return null;
  }

  async function rsPostAndPrint() {
    const err = rsValidateBeforePost();
    if (err) {
      rsSetStatus(err, 'error');
      return;
    }
    if (!confirm('Posting Receipt Slip dan cetak laporan?')) return;

    // Kirim header dari UI pada saat posting (persist + post atomic via fn_receipt_post2)
    const tgl = document.getElementById('rs-tgl').value || null;
    const sumber = document.getElementById('rs-sumber').value || null;
    const gudangAsal = document.getElementById('rs-gudang-asal').value || null;
    const pelanggan = document.getElementById('rs-pelanggan').value.trim();
    const catatan = document.getElementById('rs-catatan').value.trim();

    // mapping header -> DB (sama seperti konsep)
    let keterangan = null;
    let gudang_asal = null;
    if (sumber === 'dari_lokasi_lain') {
      gudang_asal = gudangAsal || null;
      keterangan = catatan || null;
    } else if (sumber === 'retur') {
      keterangan = pelanggan || null;
      if (catatan) keterangan = keterangan ? (keterangan + ' | ' + catatan) : catatan;
    } else if (sumber === 'awal') {
      keterangan = 'saldo awal';
      if (catatan) keterangan = keterangan + ' | ' + catatan;
    } else if (sumber === 'chiller') {
      keterangan = 'dari chiller';
      if (catatan) keterangan = keterangan + ' | ' + catatan;
    } else {
      keterangan = catatan || null;
    }

    const { data, error } = await sb.rpc('fn_receipt_post2', {
      p_receipt_id: currentReceiptId,
      p_tgl_terima: tgl,
      p_sumber: sumber,
      p_gudang_asal: gudang_asal,
      p_keterangan: keterangan,
      p_operator: operatorDisplayName || null
    });
    if (error) {
      rsSetStatus(error.message || 'Posting gagal', 'error');
      return;
    }
    receiptStatus = 'posted';
    rsRenderHeader();
    rsSetStatus('Posted berhasil. Membuka print...', 'ok');

    // ambil data terbaru untuk print
    await rsFetchLines();
    const header = await rsFetchHeaderForPrint();
    openReceiptSlipWindow(header, receiptLines);

    // Auto-reset setelah Post & Print supaya siap untuk receipt berikutnya
    await rsStartNewReceipt();
  }


  async function rsStartNewReceipt() {
    // Reset UI + buat draft receipt baru (mirip UX picking slip)
    rsSetStatus('', 'ok');

    // stop scanner if running
    try {
      const closeBtn = document.getElementById('rs-close-scanner');
      const wrap = document.getElementById('rs-scanner-wrap');
      if (wrap && wrap.style.display !== 'none') {
        // trigger existing close handler if any
        closeBtn && closeBtn.click();
      }
    } catch (e) {}

    // reset header fields
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');

    const tglEl = document.getElementById('rs-tgl');
    if (tglEl) tglEl.value = `${yyyy}-${mm}-${dd}`;

    const sumberEl = document.getElementById('rs-sumber');
    if (sumberEl) sumberEl.value = '';

    const gudangEl = document.getElementById('rs-gudang-asal');
    if (gudangEl) gudangEl.value = '';

    const pelangganEl = document.getElementById('rs-pelanggan');
    if (pelangganEl) pelangganEl.value = '';

    const catatanEl = document.getElementById('rs-catatan');
    if (catatanEl) catatanEl.value = '';

    const karungInp = document.getElementById('rs-karung-input');
    if (karungInp) karungInp.value = '';

    // reset local state
    receiptLines = [];
    receiptStatus = 'draft';
    currentReceiptId = null;

    rsRenderLines();
    rsRenderHeader();

    // create new draft
    function rsSetDisabled(disabled) {
      const ids = ['rs-tgl','rs-sumber','rs-gudang-asal','rs-pelanggan','rs-catatan','rs-karung-input','rs-open-scanner','rs-post-print'];
      ids.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.disabled = !!disabled;
      });
    }
    rsSetDisabled(true);

    try {
      await rsCreateDraft();
      await rsFetchLines();
      rsSetStatus('Receipt baru siap. Silakan scan karung.', 'ok');
      rsSetDisabled(false);
      try { await rsSaveHeader(); } catch (e) { console.warn('rsSaveHeader after new', e); }
      try { karungInp && karungInp.focus(); } catch(e) {}
    } catch (e) {
      console.error(e);
      rsSetStatus('Gagal membuat receipt baru. Cek koneksi/RLS.', 'error');
      rsSetDisabled(false);
    }
  }

  async function rsFetchHeaderForPrint() {
    const { data, error } = await sb
      .from('barang_masuk_receipt')
      .select('receipt_no, tgl_terima, sumber, gudang_asal, keterangan, operator, status, posted_at')
      .eq('receipt_id', currentReceiptId)
      .single();
    if (error) throw error;
    return data;
  }

  function rsGroupLinesByItem(lines) {
    const map = {};
    for (const l of lines) {
      const key = l.item_id;
      if (!map[key]) map[key] = { item_id: l.item_id, item_name: l.item_name, lines: [] };
      map[key].lines.push(l);
    }
    return Object.values(map);
  }

  function build3ColTableRows(rows) {
    // rows: array of {no, karung_id, ekor, kg}
    const perCol = 6; // kira-kira muat per kolom pada tinggi 16cm (tergantung font)
    const cols = [[],[],[]];
    rows.forEach((r, i) => {
      const colIdx = Math.floor(i / perCol);
      if (colIdx < 3) cols[colIdx].push(r);
      else cols[2].push(r); // overflow tetap kolom 3 (akan panjang di halaman selanjutnya via page break)
    });

    function colHtml(col) {
      let h = `<table class="mini"><thead><tr><th>No</th><th>Karung ID</th><th>Ek</th><th>Kg</th></tr></thead><tbody>`;
      col.forEach(r => {
        h += `<tr><td>${r.no}</td><td>${escapeHtml(r.karung_id)}</td><td>${r.ekor}</td><td>${Number(r.kg).toFixed(2)}</td></tr>`;
      });
      h += `</tbody></table>`;
      return h;
    }
    return `<div class="cols3">${colHtml(cols[0])}${colHtml(cols[1])}${colHtml(cols[2])}</div>`;
  }

  function openReceiptSlipWindow(header, lines) {
    // Summary per item
    const perItem = {};
    lines.forEach(l => {
      const k = l.item_id || 'UNKNOWN';
      if (!perItem[k]) perItem[k] = { item_name: l.item_name || 'UNKNOWN', karung:0, ekor:0, kg:0 };
      perItem[k].karung += 1;
      perItem[k].ekor += Number(l.qty_ekor || 0);
      perItem[k].kg += Number(l.qty_kg || 0);
    });
    const summaryRows = Object.values(perItem);

    // Source line
    let sumberText = '';
    if (header.sumber === 'dari_lokasi_lain') sumberText = `Gudang â†’ ${header.gudang_asal || '-'}`;
    else if (header.sumber === 'retur') sumberText = `Retur â†’ ${(header.keterangan || '').split('|')[0].trim() || '-'}`;
    else sumberText = `Chiller`;

    // Group detail by item (for heading)
    const groups = rsGroupLinesByItem(lines);

    const nowStr = new Date().toLocaleString('id-ID');
    const docTitle = `Receipt Slip ${header.receipt_no}`;

    let detailHtml = '';
    let globalNo = 1;
    groups.forEach(g => {
      detailHtml += `<div class="item-heading">ITEM: ${escapeHtml(g.item_name || g.item_id)}</div>`;
      const rows = g.lines.map(l => ({
        no: globalNo++,
        karung_id: l.karung_id_input,
        ekor: Number(l.qty_ekor || 0),
        kg: Number(l.qty_kg || 0)
      }));
      detailHtml += build3ColTableRows(rows);
      detailHtml += `<div class="spacer"></div>`;
    });

    const summaryHtml = summaryRows.map(r => `
      <tr>
        <td>${escapeHtml(r.item_name)}</td>
        <td style="text-align:right;">${r.karung}</td>
        <td style="text-align:right;">${r.ekor}</td>
        <td style="text-align:right;">${r.kg.toFixed(2)}</td>
      </tr>
    `).join('');

    const htmlPrint = `
<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>${escapeHtml(docTitle)}</title>
<style>
  @page { size: 21.5cm 16cm landscape; margin: 6mm; }
  body { font-family: Arial, sans-serif; font-size: 10px; margin:0; }
  .hdr { display:flex; justify-content:space-between; align-items:flex-start; }
  .title { font-size: 12px; font-weight:700; }
  .meta { text-align:right; }
  .line { margin-top:2px; }
  .box { border-top:1px dashed #999; margin-top:6px; padding-top:6px; }
  table { border-collapse: collapse; width:100%; }
  th, td { border:1px solid #ddd; padding:3px 4px; }
  th { background:#f2f2f2; }
  .mini th, .mini td { font-size:9px; padding:2px 3px; }
  .mini { width:100%; }
  .cols3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:6px; }
  .item-heading { font-weight:700; margin-top:6px; margin-bottom:4px; }
  .spacer { height:4px; }
  .footer { margin-top:6px; display:flex; justify-content:space-between; }
  .sign { width:48%; }
  .sign .name { margin-top:14px; border-top:1px solid #333; padding-top:3px; }
  .muted { color:#555; }
</style>
</head>
<body>
  <div class="hdr">
    <div>
      <div class="title">RECEIPT SLIP</div>
      <div class="line"><strong>No:</strong> ${escapeHtml(header.receipt_no)} &nbsp;&nbsp; <strong>Tgl:</strong> ${escapeHtml(String(header.tgl_terima || ''))}</div>
      <div class="line"><strong>Sumber:</strong> ${escapeHtml(sumberText)}</div>
      ${header.keterangan ? `<div class="line"><span class="muted">Ket:</span> ${escapeHtml(header.keterangan)}</div>` : ``}
    </div>
    <div class="meta">
      <div class="line"><strong>Status:</strong> ${escapeHtml(String(header.status||'posted').toUpperCase())}</div>
      <div class="line"><strong>Operator:</strong> ${escapeHtml(header.operator || '')}</div>
      <div class="line"><span class="muted">Cetak:</span> ${escapeHtml(nowStr)}</div>
    </div>
  </div>

  <div class="box">
    <div style="font-weight:700; margin-bottom:4px;">REKAP PER ITEM</div>
    <table>
      <thead><tr><th>Item</th><th>Karung</th><th>Ekor</th><th>Kg</th></tr></thead>
      <tbody>
        ${summaryHtml}
      </tbody>
    </table>
  </div>

  <div class="box">
    <div style="font-weight:700; margin-bottom:4px;">RINCIAN KARUNG</div>
    ${detailHtml}
  </div>

  <div class="footer">
    <div class="sign">
      Diterima Oleh (Operator)
      <div class="name">Nama / Tgl</div>
    </div>
    <div class="sign">
      Diperiksa Oleh (Checker)
      <div class="name">Nama / Tgl</div>
    </div>
  </div>
</body>
</html>
    `;

    const w = window.open('', '_blank');
    w.document.open();
    w.document.write(htmlPrint);
    w.document.close();
    w.focus();
    w.print();
  }

  async function initReceiptSlipOnce() {
    if (receiptInitialized) return;
    receiptInitialized = true;

    // disable inputs until draft ready (prevent race: header change before currentReceiptId exists)
    function rsSetDisabled(disabled) {
      const ids = ['rs-tgl','rs-sumber','rs-gudang-asal','rs-pelanggan','rs-catatan','rs-karung-input','rs-open-scanner','rs-post-print'];
      ids.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.disabled = !!disabled;
      });
    }
    rsSetDisabled(true);


    // init
    rsSetStatus('', 'ok');
    document.getElementById('rs-userInfo').textContent = operatorDisplayName || '';

    // set default date
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth()+1).padStart(2,'0');
    const dd = String(today.getDate()).padStart(2,'0');
    document.getElementById('rs-tgl').value = `${yyyy}-${mm}-${dd}`;

    await rsLoadSumberMasukEnum();

    // Draft receipt TIDAK dibuat otomatis saat halaman dibuka.
    // Draft akan dibuat otomatis saat karung pertama ditambahkan (menghindari draft kosong terbentuk tanpa aksi user).
    rsSetStatus('Siap. Scan/isi Karung ID lalu tekan Enter. Draft akan dibuat otomatis saat karung pertama ditambahkan.', 'ok');
    rsSetDisabled(false);

    // header behavior
    const sumberSel = document.getElementById('rs-sumber');
    const rowGudang = document.getElementById('rs-row-gudang');
    const rowPelanggan = document.getElementById('rs-row-pelanggan');

    function syncHeaderVisibility() {
      const v = sumberSel.value;
      rowGudang.style.display = (v === 'dari_lokasi_lain') ? '' : 'none';
      rowPelanggan.style.display = (v === 'retur') ? '' : 'none';
    }
    sumberSel.addEventListener('change', async () => {
      syncHeaderVisibility();
      try { await rsSaveHeader(); } catch(e) { console.warn(e); }
    });
    document.getElementById('rs-gudang-asal').addEventListener('change', async () => {
      try { await rsSaveHeader(); } catch(e) { console.warn(e); }
    });
    document.getElementById('rs-pelanggan').addEventListener('input', debounce(async () => {
      try { await rsSaveHeader(); } catch(e) { console.warn(e); }
    }, 600));
    document.getElementById('rs-catatan').addEventListener('input', debounce(async () => {
      try { await rsSaveHeader(); } catch(e) { console.warn(e); }
    }, 700));
    document.getElementById('rs-tgl').addEventListener('change', async () => {
      try { await rsSaveHeader(); } catch(e) { console.warn(e); }
    });

    syncHeaderVisibility();

    // add karung input enter
    const karungInp = document.getElementById('rs-karung-input');
    karungInp.addEventListener('keydown', async (ev) => {
      if (ev.key === 'Enter') {
        ev.preventDefault();
        const id = karungInp.value.trim();
        if (!id) return;
        await rsAddKarung(id);
        karungInp.value = '';
        karungInp.focus();
      }
    });

    document.getElementById('rs-save').addEventListener('click', async () => {
      try { await rsSaveHeader(); rsSetStatus('Draft tersimpan.', 'ok'); }
      catch(e) { rsSetStatus(e.message || 'Gagal simpan draft', 'error'); }
    });

    const rsNewBtn = document.getElementById('rs-new');
    if (rsNewBtn) {
      rsNewBtn.addEventListener('click', async () => {
        if (receiptLines && receiptLines.length) {
          if (!confirm('Buat Receipt baru? Draft saat ini akan di-reset.')) return;
        }
        await rsStartNewReceipt();
      });
    }

    document.getElementById('rs-post-print').addEventListener('click', rsPostAndPrint);

    // QR scanner reuse html5-qrcode (like picking slip)
    let rsQr = null;
    document.getElementById('rs-open-scanner').addEventListener('click', async () => {
      document.getElementById('rs-scanner-wrap').style.display = '';
      document.getElementById('rs-open-scanner').style.display = 'none';
      document.getElementById('rs-close-scanner').style.display = '';
      try {
        if (!window.Html5Qrcode) {
          rsSetStatus('Library QR belum siap. Coba reload.', 'error');
          return;
        }
        rsQr = new Html5Qrcode("rs-qr-reader");
        await rsQr.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: { width: 240, height: 240 } },
          async (decodedText) => {
            const scanMassal = document.getElementById('rs-scan-massal')?.checked;
            if (!scanMassal) {
              karungInp.value = normalizeKarungId(decodedText);
              rsSetStatus('QR terbaca. Tekan Enter untuk tambah.', 'ok');
              rsMaybeBeep(true);
              return;
            }
            await rsAddKarung(decodedText);
          }
        );
      } catch (e) {
        console.error(e);
        rsSetStatus('Gagal membuka kamera.', 'error');
      }
    });

    document.getElementById('rs-close-scanner').addEventListener('click', async () => {
      document.getElementById('rs-scanner-wrap').style.display = 'none';
      document.getElementById('rs-open-scanner').style.display = '';
      document.getElementById('rs-close-scanner').style.display = 'none';
      try { if (rsQr) { await rsQr.stop(); rsQr.clear(); rsQr = null; } } catch {}
    });
  }

let tambahBatchInitialized = false;

  async function initFormTambahBatchOnce() {
    if (tambahBatchInitialized) return;
    tambahBatchInitialized = true;

    const tbUserInfo = document.getElementById('tb-userInfo');
    const tbTglAbf = document.getElementById('tb-tgl-abf');
    const tbShift = document.getElementById('tb-shift');
    const tbBatchId = document.getElementById('tb-batch-id');
    const tbGenerateBtn = document.getElementById('tb-generate-btn');
    const tbSubmitBtn = document.getElementById('tb-submit-btn');
    const tbStatus = document.getElementById('tb-status');
    const tbRakMappingEl = document.getElementById('tb-rak-mapping');

    function buildRakMappingUI() {
      if (!tbRakMappingEl) return;
      const racks = Array.from({ length: 20 }, (_, i) => `RAK-${String(i + 1).padStart(2, '0')}`);
      const mesinOptions = ['','1','2','3','4','5','6'];

      const grid = document.createElement('div');
      grid.className = 'rack-grid';

      racks.forEach(rak => {
        const card = document.createElement('div');
        card.className = 'rack-card';

        const label = document.createElement('div');
        label.className = 'rack-label';
        label.textContent = rak;

        const sel = document.createElement('select');
        sel.dataset.rak = rak;

        const opt0 = document.createElement('option');
        opt0.value = '';
        opt0.textContent = '-- Mesin --';
        sel.appendChild(opt0);

        for (let m = 1; m <= 6; m++) {
          const opt = document.createElement('option');
          opt.value = String(m);
          opt.textContent = `ABF ${m}`;
          sel.appendChild(opt);
        }

        card.appendChild(label);
        card.appendChild(sel);
        grid.appendChild(card);
      });

      tbRakMappingEl.innerHTML = '';
      tbRakMappingEl.appendChild(grid);
    }

    function getMappingPayload() {
      if (!tbRakMappingEl) return [];
      const selects = tbRakMappingEl.querySelectorAll('select[data-rak]');
      const payload = [];
      selects.forEach(sel => {
        const val = sel.value;
        if (val) {
          payload.push({ rak_abf: sel.dataset.rak, mesin_abf: Number(val) });
        }
      });
      return payload;
    }

    function resetRakMapping() {
      if (!tbRakMappingEl) return;
      const selects = tbRakMappingEl.querySelectorAll('select[data-rak]');
      selects.forEach(sel => { sel.value = ''; });
    }

    // render mapping UI
    buildRakMappingUI();


    // tampilkan operator
    if (tbUserInfo && operatorDisplayName) {
      tbUserInfo.textContent = operatorDisplayName;
    }

    // generate batch id
    tbGenerateBtn.addEventListener('click', () => {
      tbStatus.textContent = "";
      const tgl = tbTglAbf.value;
      const shift = tbShift.value;

      if (!tgl || !shift) {
        tbStatus.textContent = "Isi tanggal & shift terlebih dahulu.";
        tbStatus.className = "status error";
        return;
      }

      const d = new Date(tgl);
      const YY = String(d.getFullYear()).slice(-2);
      const MM = String(d.getMonth()+1).padStart(2,'0');
      const DD = String(d.getDate()).padStart(2,'0');

      const batchId = `BF-${YY}${MM}${DD}${shift}`;
      tbBatchId.value = batchId;

      tbStatus.textContent = "Batch ID berhasil dihasilkan.";
      tbStatus.className = "status success";
    });

    // submit batch ke Supabase
    tbSubmitBtn.addEventListener('click', async () => {
      tbStatus.textContent = "";
      tbStatus.className = "status";

      const tgl = tbTglAbf.value;
      const shift = tbShift.value;
      const batchId = tbBatchId.value;

      if (!tgl || !shift || !batchId) {
        tbStatus.textContent = "Lengkapi tanggal, shift, lalu tekan Generate Batch ID.";
        tbStatus.className = "status error";
        return;
      }

      const mappingPayload = getMappingPayload();
      if (!mappingPayload.length) {
        tbStatus.textContent = "Mapping rak ke mesin wajib diisi minimal 1 rak.";
        tbStatus.className = "status error";
        return;
      }

      tbStatus.textContent = "Menyimpan batch + mapping rak...";
      tbStatus.className = "status";

      const { data, error } = await sb.rpc('fn_upsert_batch_abf_with_rak_mesin', {
        p_batch_id: batchId,
        p_tgl_abf: tgl,
        p_shift_abf: Number(shift),
        p_mapping: mappingPayload,
        p_replace: true
      });

      if (error) {
        tbStatus.textContent = "Gagal menyimpan: " + error.message;
        tbStatus.className = "status error";
        return;
      }

      tbStatus.textContent = "Batch berhasil disimpan! (" + (data?.mapping_count ?? mappingPayload.length) + " rak)";
      tbStatus.className = "status success";

      // reset form
      tbBatchId.value = "";
      tbShift.value = "";
      tbTglAbf.value = "";
      resetRakMapping();
    });
}


  async function handleTglAbfChange() {
    const tglAbf = tglAbfInput.value;

    batchSelect.innerHTML = '<option value="">-- Pilih batch --</option>';
    shiftAbfInput.value = '';
    confirmBox.style.display = 'none';
    confirmBox.textContent = '';
    statusMessage.textContent = '';
    statusMessage.className = 'status';

    itemSearchInput.disabled = true;
    itemSelect.disabled = true;
    tglProduksiInput.disabled = true;

    if (!tglAbf) return;

    statusMessage.textContent = 'Memuat batch untuk tanggal ABF...';
    statusMessage.className = 'status';

    const { data: batchData, error: batchError } = await sb
      .from('master_batch_abf')
      .select('batch_id, shift_abf')
      .eq('tgl_abf', tglAbf)
      .order('shift_abf', { ascending: true });

    if (batchError) {
      console.error(batchError);
      statusMessage.textContent = 'Gagal memuat batch: ' + batchError.message;
      statusMessage.className = 'status error';
      return;
    }

    if (!batchData || batchData.length === 0) {
      statusMessage.textContent = 'Tidak ada batch pembekuan untuk tanggal ini.';
      statusMessage.className = 'status error';
      batchSelect.innerHTML = '<option value="">-- Tidak ada batch --</option>';
      itemSearchInput.disabled = true;
      itemSelect.disabled = true;
      tglProduksiInput.disabled = true;
      return;
    }

    batchSelect.innerHTML = '<option value="">-- Pilih batch --</option>';
    batchData.forEach(b => {
      const opt = document.createElement('option');
      const shiftStr = String(b.shift_abf).padStart(2, '0');
      opt.value = b.batch_id;
      opt.textContent = `${b.batch_id} (Shift ${shiftStr})`;
      opt.dataset.shift = shiftStr;
      batchSelect.appendChild(opt);
    });

    statusMessage.textContent = 'Batch berhasil dimuat.';
    statusMessage.className = 'status success';

    itemSearchInput.disabled = false;
    itemSelect.disabled = false;
    tglProduksiInput.disabled = false;
  }

  function populateItemOptions(list) {
    itemSelect.innerHTML = '';
    list.forEach(item => {
      const opt = document.createElement('option');
      opt.value = item.item_id;
      opt.textContent = item.item_name;
      itemSelect.appendChild(opt);
    });
    if (list.length > 0) {
      itemSelect.selectedIndex = 0;
      selectedItemIdInp.value = list[0].item_id;
    } else {
      selectedItemIdInp.value = '';
    }
  }

  function filterItemOptions() {
    const keyword = itemSearchInput.value.toLowerCase().trim();
    const filtered = items.filter(i => i.item_name.toLowerCase().includes(keyword));
    populateItemOptions(filtered);
  }

  function onItemChange() {
    const opt = itemSelect.options[itemSelect.selectedIndex];
    selectedItemIdInp.value = opt ? opt.value : '';
  }

  function addRakRow(rakName = '') {
    const tr = document.createElement('tr');

    const tdRak = document.createElement('td');
    const selectRak = document.createElement('select');
    const optDefault = document.createElement('option');
    optDefault.value = '';
    optDefault.textContent = '-- Pilih Rak --';
    selectRak.appendChild(optDefault);
    RAK_OPTIONS.forEach(r => {
      const opt = document.createElement('option');
      opt.value = r;
      opt.textContent = r;
      selectRak.appendChild(opt);
    });
    if (rakName) selectRak.value = rakName;
    tdRak.appendChild(selectRak);

    const tdEkor = document.createElement('td');
    const inputEkor = document.createElement('input');
    inputEkor.type = 'number';
    inputEkor.min = '1';
    inputEkor.step = '1';
    inputEkor.oninput = updateTotals;
    tdEkor.appendChild(inputEkor);

    const tdKg = document.createElement('td');
    const inputKg = document.createElement('input');
    inputKg.type = 'number';
    inputKg.min = '0.01';
    inputKg.step = '0.01';
    inputKg.oninput = updateTotals;
    tdKg.appendChild(inputKg);

    const tdAksi = document.createElement('td');
    const btnHapus = document.createElement('button');
    btnHapus.type = 'button';
    btnHapus.textContent = 'Hapus';
    btnHapus.className = 'btn btn-ghost btn-small';
    btnHapus.onclick = () => {
      tr.remove();
      updateTotals();
    };
    tdAksi.appendChild(btnHapus);

    tr.appendChild(tdRak);
    tr.appendChild(tdEkor);
    tr.appendChild(tdKg);
    tr.appendChild(tdAksi);

    rakTbody.appendChild(tr);
  }

  function updateTotals() {
    let totalEkor = 0;
    let totalKg = 0;
    const rows = rakTbody.querySelectorAll('tr');
    rows.forEach(row => {
      const ekorVal = row.children[1].querySelector('input').value;
      const kgVal = row.children[2].querySelector('input').value;
      totalEkor += ekorVal ? parseInt(ekorVal, 10) : 0;
      totalKg += kgVal ? parseFloat(kgVal) : 0;
    });
    totalEkorSpan.textContent = totalEkor;
    totalKgSpan.textContent = totalKg.toFixed(2);
  }

  async function handleSavePreview() {
    statusMessage.textContent = '';
    statusMessage.className = 'status';
    confirmBox.style.display = 'none';
    confirmBox.textContent = '';
    btnSubmitNew.disabled = true;

    const tglAbf = tglAbfInput.value;
    const batchId = batchSelect.value;
    const shift = shiftAbfInput.value;
    const itemId = selectedItemIdInp.value;
    const itemName = itemSelect.selectedOptions[0]
      ? itemSelect.selectedOptions[0].textContent
      : '';
    const tglProduksi = tglProduksiInput.value;
    const operatorName = operatorInput2.value || null;
    const catatan = catatanInput.value || null;

    if (!tglAbf || !batchId || !itemId || !tglProduksi) {
      statusMessage.textContent = 'Mohon isi Tgl ABF, Batch, Item, dan Tgl Produksi.';
      statusMessage.className = 'status error';
      return;
    }

    const rows = rakTbody.querySelectorAll('tr');
    const rakData = [];
    let hasError = false;

    rows.forEach(row => {
      const selectRak = row.children[0].querySelector('select');
      const inputEkor = row.children[1].querySelector('input');
      const inputKg = row.children[2].querySelector('input');

      const rakVal = selectRak.value;
      const ekorRaw = inputEkor.value;
      const kgRaw = inputKg.value;

      if (!rakVal && !ekorRaw && !kgRaw) return;

      const ekorVal = ekorRaw ? Number(ekorRaw) : 0;
      const kgVal = kgRaw ? Number(kgRaw) : 0;

      if (!rakVal) {
        hasError = true;
        statusMessage.textContent = 'Setiap baris yang diisi harus memilih Rak.';
        statusMessage.className = 'status error';
        return;
      }
      if (!ekorRaw || !Number.isInteger(ekorVal) || ekorVal <= 0) {
        hasError = true;
        statusMessage.textContent = 'Ekor harus diisi dengan bilangan bulat positif pada setiap rak.';
        statusMessage.className = 'status error';
        return;
      }
      if (!kgRaw || kgVal <= 0) {
        hasError = true;
        statusMessage.textContent = 'Kg harus diisi dengan angka lebih dari 0 pada setiap rak.';
        statusMessage.className = 'status error';
        return;
      }

      rakData.push({
        rak_abf: rakVal,
        qty_ekor: ekorVal,
        qty_kg: kgVal
      });
    });

    if (hasError) return;

    if (rakData.length === 0) {
      statusMessage.textContent = 'Minimal harus ada 1 baris rak dengan data.';
      statusMessage.className = 'status error';
      return;
    }

    let totalEkor = 0;
    let totalKg = 0;
    rakData.forEach(r => {
      totalEkor += r.qty_ekor;
      totalKg += r.qty_kg;
    });

    if (totalEkor <= 0 || totalKg <= 0) {
      statusMessage.textContent = 'Total ekor dan kg per karung harus > 0.';
      statusMessage.className = 'status error';
      return;
    }

    lastPreviewData = {
      tglAbf,
      batchId,
      shift,
      itemId,
      itemName,
      tglProduksi,
      operatorName,
      catatan,
      totalEkor,
      totalKg,
      rakData
    };
    lastRakStructure = rakData.map(r => r.rak_abf || '');

    let text = '';
    text += `Tgl ABF      : ${tglAbf}\n`;
    text += `Batch ABF    : ${batchId}${shift ? ' (Shift ' + shift + ')' : ''}\n`;
    text += `Item         : ${itemName}\n`;
    text += `Tgl Produksi : ${tglProduksi}\n\n`;
    text += `Detail Rak:\n`;
    lastPreviewData.rakData.forEach(r => {
      text += `- ${r.rak_abf} : ${r.qty_ekor} ekor / ${r.qty_kg.toFixed(2)} kg\n`;
    });
    text += `\nTotal per Karung: ${totalEkor} ekor / ${totalKg.toFixed(2)} kg\n`;
    if (catatan) text += `\nCatatan: ${catatan}`;

    confirmBox.textContent = text;
    confirmBox.style.display = 'block';
    btnSubmitNew.disabled = false;

    statusMessage.textContent = 'Silakan cek konfirmasi. Jika sudah benar, klik "Submit & New Data".';
  }

  async function handleSubmit() {
    if (!lastPreviewData || !lastPreviewData.batchId) {
      statusMessage.textContent = 'Belum ada data yang dikonfirmasi. Klik dulu "Submit (Tampilkan Konfirmasi)".';
      statusMessage.className = 'status error';
      return;
    }

    btnSubmitNew.disabled = true;
    statusMessage.textContent = 'Menyimpan ke database...';
    statusMessage.className = 'status';

    
try {
      // ===== Validasi rak harus sudah didaftarkan pada batch (batch_abf_rak_mesin) =====
      const cleanKey = (v) => String(v || '')
        .replace(/[\u200B-\u200D\uFEFF]/g, '')  // hapus zero-width chars
        .trim()
        .toUpperCase();

      const batchIdTrim = cleanKey(lastPreviewData.batchId);

      const rakList = Array.from(new Set(
        (lastPreviewData.rakData || [])
          .map(r => cleanKey(r.rak_abf))
          .filter(r => !!r)
      ));
// Jika ada rak, pastikan semua terdaftar & aktif pada batch
      const rakToMesin = {};
      if (rakList.length > 0) {
        const { data: mapRows, error: mapErr } = await sb
          .from('batch_abf_rak_mesin')
          .select('rak_abf, mesin_abf, aktif')
          .eq('batch_id', batchIdTrim)
          .eq('aktif', true)
          .in('rak_abf', rakList);

        if (mapErr) {
          console.error(mapErr);
          statusMessage.textContent = 'Gagal validasi rak batch: ' + mapErr.message;
          statusMessage.className = 'status error';
          btnSubmitNew.disabled = false;
          return;
        }

        (mapRows || []).forEach(r => {
          const k = cleanKey(r.rak_abf);
          if (k) rakToMesin[k] = r.mesin_abf;
        });

        const missing = rakList.filter(r => !(r in rakToMesin));
        if (missing.length > 0) {
          statusMessage.textContent =
            `Gagal menyimpan: Rak ${missing.join(', ')} belum didaftarkan pada batch ${batchIdTrim}.`;
          statusMessage.className = 'status error';
          btnSubmitNew.disabled = false;
          return;
        }
      }

      const { data: fnData, error: fnError } = await sb.rpc(
        'fn_barang_masuk_karung',
        {
          p_item_id: lastPreviewData.itemId,
          p_qty_ekor: lastPreviewData.totalEkor,
          p_qty_kg: lastPreviewData.totalKg,
          p_tgl_produksi: lastPreviewData.tglProduksi,
          p_batch_pembekuan: lastPreviewData.batchId,
          p_pallet_id: null,
          p_operator: lastPreviewData.operatorName,
          p_keterangan: lastPreviewData.catatan,
          p_karung_id: null
        }
      );

      if (fnError) {
        console.error(fnError);
        statusMessage.textContent = 'Gagal menyimpan karung: ' + fnError.message;
        statusMessage.className = 'status error';
        btnSubmitNew.disabled = false;
        return;
      }

      const karungId = fnData;

      const rowsToInsert = lastPreviewData.rakData.map(r => ({
        karung_id: karungId,
        rak_abf: r.rak_abf,
        mesin_abf: (typeof rakToMesin !== 'undefined') ? (rakToMesin[String(r.rak_abf || '').trim()] ?? null) : null,
        qty_ekor: r.qty_ekor,
        qty_kg: r.qty_kg
      }));

      const { error: rakError } = await sb
        .from('karung_rak_abf')
        .insert(rowsToInsert);

      if (rakError) {
        console.error(rakError);
        statusMessage.textContent =
          'Karung sudah tersimpan, tapi gagal menyimpan detail rak: ' +
          rakError.message;
        statusMessage.className = 'status error';
        btnSubmitNew.disabled = false;
        return;
      }

      statusMessage.textContent = `Karung ${karungId} berhasil disimpan.`;
      statusMessage.className = 'status success';

      openLabelWindow(karungId, lastPreviewData);

      confirmBox.style.display = 'none';
      confirmBox.textContent = '';
      rakTbody.innerHTML = '';
      if (lastRakStructure && lastRakStructure.length > 0) {
        lastRakStructure.forEach(rakName => addRakRow(rakName));
      } else {
        addRakRow();
      }
      updateTotals();
      btnSubmitNew.disabled = true;
    } catch (err) {
      console.error(err);
      statusMessage.textContent = 'Terjadi error tidak terduga: ' + err.message;
      statusMessage.className = 'status error';
      btnSubmitNew.disabled = false;
    }
  }

  function handleClearForm() {
    tglAbfInput.value = '';
    batchSelect.innerHTML = '<option value="">-- Pilih batch --</option>';
    shiftAbfInput.value = '';
    itemSearchInput.value = '';
    populateItemOptions(items);
    tglProduksiInput.value = '';
    catatanInput.value = '';
    rakTbody.innerHTML = '';
    addRakRow();
    updateTotals();
    confirmBox.style.display = 'none';
    confirmBox.textContent = '';
    lastPreviewData = {};
    lastRakStructure = [];
    itemSearchInput.disabled = false;
    itemSelect.disabled = false;
    tglProduksiInput.disabled = false;
    btnSubmitNew.disabled = true;
    statusMessage.textContent = 'Form telah dikosongkan.';
    statusMessage.className = 'status';
  }

  function openLabelWindow(karungId, preview) {
    // Robust label print: avoid "callback is no longer runnable" by rendering QR inside
    // the popup window and printing only after the popup fully loads.
    const payload = [
      karungId,
      preview.itemName,
      preview.tglProduksi,
      preview.totalEkor,
      Number(preview.totalKg || 0).toFixed(2)
    ].join('|');

    const rawMemo = preview?.catatan ?? "";
    const memoStr =
      (typeof rawMemo === "string") ? rawMemo :
      (typeof rawMemo === "number") ? String(rawMemo) :
      JSON.stringify(rawMemo);
    const memoText = memoStr.substring(0, 200);

    const labelHTML = `
<html>
<head>
  <meta charset="UTF-8" />
  <title>Label Karung</title>
  <style>
    @page {
      margin-top: 10mm !important;
      margin-bottom: 10mm !important;
      margin-left: 0;
      margin-right: 0;
    }
    body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
    .karung-label {
      width: 100mm;
      height: 90mm;
      border: 1px solid #000;
      margin: 0;
      box-sizing: border-box;
      padding: 20mm 4mm 4mm 4mm;
      font-size: 10pt;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .label-header { text-align: center; font-weight: 700; font-size: 14pt; text-transform: uppercase; margin-bottom: 0; }
	.label-header-karung { text-align: center; font-weight: 600; font-size: 10pt; margin-bottom: 2mm; }
    .label-status { text-align: center; font-weight: 800; font-size: 12pt; letter-spacing: 1px; margin-top: 1mm; }
    .label-main { flex: 1; display: flex; flex-direction: row; gap: 4mm; }
    .label-left { width: 38%; display: flex; flex-direction: column; align-items: center; text-align: center; }
    .label-qr { width: 35mm; height: 35mm; display: flex; align-items: center; justify-content: center; }
    .label-karung-id { margin-top: 2mm; font-weight: 700; font-size: 11pt; }
    .label-right { flex: 1; display: flex; flex-direction: column; }
    .label-item-name { text-align: center; font-weight: 700; font-size: 13pt; margin-bottom: 3mm; }
    .label-row { display: flex; justify-content: space-between; margin-bottom: 1.5mm; font-size: 10pt; }
    .label-text { font-weight: 600; }
    .label-memo { margin-top: 2mm; font-size: 9pt; line-height: 1.2; white-space: pre-wrap; border-top: 1px dashed #aaa; padding-top: 1.5mm; }
	.label-footer{ text-align: center;font-size: 8pt;font-weight: 600;padding-top: 2mm;border-top: 1px solid #000;margin-top: 1mm;}
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"><\/script>
</head>
<body>
  <div class="karung-label">
    <div>
      <div class="label-header">KURNIA'S FOOD</div>
	  <div class="label-header-karung">${escapeHtml(karungId)}</div>
    </div>

    <div class="label-main">
      <div class="label-left">
        <div id="qrcode" class="label-qr"></div>
        <div class="label-karung-id">${escapeHtml(karungId)}</div>
      </div>
      <div class="label-right">
        <div class="label-item-name">${escapeHtml(preview.itemName || '')}</div>
        <div class="label-row"><span class="label-text">Tgl Produksi</span><span>${escapeHtml(preview.tglProduksi || '')}</span></div>
        <div class="label-row"><span class="label-text">Ekor</span><span>${Number(preview.totalEkor || 0)}</span></div>
        <div class="label-row"><span class="label-text">Kg</span><span>${Number(preview.totalKg || 0).toFixed(2)}</span></div>
        ${memoText ? `<div class="label-memo">${escapeHtml(memoText)}</div>` : ``}
      </div>
    </div>
    <div class="label-footer">
      Produk ini harus disimpan di suhu -20Â°C
    </div>
  </div>

  <script>
    (function() {
      const payload = ${JSON.stringify(payload)};

      function safePrint() {
        try {
          window.focus();
          // Give the browser a moment to paint the QR before printing
          setTimeout(() => {
            try { window.print(); } catch (e) { console.error('print failed', e); }
          }, 200);
        } catch (e) { console.error(e); }
      }

      function renderQrAndPrint() {
        try {
          const el = document.getElementById('qrcode');
          if (typeof QRCode === 'function' && el) {
            new QRCode(el, { text: payload, width: 140, height: 140 });
          }
        } catch (e) {
          console.error('QR render failed', e);
        } finally {
          safePrint();
        }
      }

      if (document.readyState === 'complete') renderQrAndPrint();
      else window.addEventListener('load', renderQrAndPrint);
    })();
  <\/script>
</body>
</html>
    `;

    const w = window.open('', '_blank');
    if (!w) {
      alert('Popup diblokir oleh browser. Izinkan popup untuk mencetak label.');
      return;
    }
    w.document.open();
    w.document.write(labelHTML);
    w.document.close();
  }

  // ============== FORM PINDAH LOKASI LOGIC (incl. QR CAMERA) ==============

  const plUserInfoEl      = document.getElementById('pl-userInfo');
  const plScanInput       = document.getElementById('pl-scan-input');
  const plBtnSearch       = document.getElementById('pl-btn-search');
  const plSearchResults   = document.getElementById('pl-search-results');
  const plKarungIdInput   = document.getElementById('pl-karung-id');
  const plItemNameInput   = document.getElementById('pl-item-name');
  const plPalletLamaInput = document.getElementById('pl-pallet-lama');
  const plStatusInput     = document.getElementById('pl-status-karung');
  const plStokSisaInput   = document.getElementById('pl-stok-sisa');
  const plPalletBaruSelect= document.getElementById('pl-pallet-baru');
  const plOperatorInput   = document.getElementById('pl-operator');
  const plCatatanInput    = document.getElementById('pl-catatan');
  const plBtnSubmit       = document.getElementById('pl-btn-submit');
  const plStatusMessage   = document.getElementById('pl-status-message');

  const plBtnStartCamera  = document.getElementById('pl-btn-start-camera');
  const plBtnStopCamera   = document.getElementById('pl-btn-stop-camera');
  const plQrRegion        = document.getElementById('pl-qr-region');

  let pallets = [];
  let currentKarungData = null;
  let plQrScanner = null;
  let plCameraRunning = false;

  async function initPindahLokasiOnce() {
    if (pindahLokasiInitialized) return;
    pindahLokasiInitialized = true;

    if (plOperatorInput && operatorDisplayName) {
      plOperatorInput.value = operatorDisplayName;
    }
    if (plUserInfoEl && operatorDisplayName) {
      const r = currentProfile && currentProfile.role ? currentProfile.role : 'operator';
      plUserInfoEl.textContent = operatorDisplayName + (r ? ` (${r})` : '');
    }

    plStatusMessage.textContent = 'Memuat daftar pallet...';
    plStatusMessage.className = 'status';

    const { data: palletData, error: palletError } = await sb
      .from('master_pallet')
      .select('pallet_id')
      .order('pallet_id', { ascending: true });

    if (palletError) {
      console.error(palletError);
      plStatusMessage.textContent = 'Gagal memuat pallet: ' + palletError.message;
      plStatusMessage.className = 'status error';
    } else {
      pallets = palletData || [];
      plPalletBaruSelect.innerHTML = '<option value="">-- Pilih pallet baru --</option>';
      pallets.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.pallet_id;
        opt.textContent = p.pallet_id;
        plPalletBaruSelect.appendChild(opt);
      });
      plStatusMessage.textContent = 'Form pindah pallet siap digunakan.';
      plStatusMessage.className = 'status success';
    }

    plBtnSearch.addEventListener('click', plSearchKarung);
    plScanInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        plSearchKarung();
      }
    });
    plBtnSubmit.addEventListener('click', plSubmitPindah);

    if (plBtnStartCamera) {
      plBtnStartCamera.addEventListener('click', plStartCameraScan);
    }
    if (plBtnStopCamera) {
      plBtnStopCamera.addEventListener('click', plStopCameraScan);
    }
  }
  // ============== FORM INPUT PALLET (multi karung) ==============

  const ipUserInfoEl   = document.getElementById('ip-userInfo');
  const ipPalletSel    = document.getElementById('ip-pallet');
  const ipCountAwalEl  = document.getElementById('ip-count-awal');
  const ipCountTambahEl= document.getElementById('ip-count-tambah');
  const ipCountAkhirEl = document.getElementById('ip-count-akhir');

  const ipKarungInput  = document.getElementById('ip-karung-input');
  const ipBtnAdd       = document.getElementById('ip-btn-add');
  const ipTable        = document.getElementById('ip-table');
  const ipTbody        = ipTable ? ipTable.querySelector('tbody') : null;

  const ipStatusEl     = document.getElementById('ip-status');
  const ipCatatanEl    = document.getElementById('ip-catatan');
  const ipSubmitBtn    = document.getElementById('ip-submit');

  const ipOpenScannerBtn  = document.getElementById('ip-open-scanner');
  const ipCloseScannerBtn = document.getElementById('ip-close-scanner');
  const ipScannerWrap     = document.getElementById('ip-scanner-wrap');

  let ipQr = null;
  let ipList = []; // { karung_id, item_name, qty_ekor_sisa, qty_kg_sisa, pallet_lama }

  let ipCountAwal = 0;

  function ipSetStatus(msg, kind) {
    if (!ipStatusEl) return;
    ipStatusEl.textContent = msg || '';
    ipStatusEl.className = 'status' + (kind ? (' ' + kind) : '');
  }


  function ipSetEnabled(enabled) {
    const on = !!enabled;
    if (ipKarungInput) ipKarungInput.disabled = !on;
    if (ipBtnAdd) ipBtnAdd.disabled = !on;
    if (ipOpenScannerBtn) ipOpenScannerBtn.disabled = !on;
    const massal = document.getElementById('ip-scan-massal');
    if (massal) massal.disabled = !on;
    if (ipSubmitBtn) ipSubmitBtn.disabled = !on;
  }

  function ipUpdateCounts() {
    const tambah = ipList.length;
    if (ipCountAwalEl) ipCountAwalEl.value = String(ipCountAwal || 0);
    if (ipCountTambahEl) ipCountTambahEl.value = String(tambah);
    if (ipCountAkhirEl) ipCountAkhirEl.value = String((ipCountAwal || 0) + tambah);
  }

  function ipRenderTable() {
    if (!ipTbody) return;
    ipTbody.innerHTML = '';

    ipList.forEach((r, i) => {
      const tr = document.createElement('tr');

      const tdNo = document.createElement('td');
      tdNo.textContent = String(i + 1);
      tr.appendChild(tdNo);

      const tdId = document.createElement('td');
      tdId.textContent = r.karung_id;
      tr.appendChild(tdId);

      const tdItem = document.createElement('td');
      tdItem.textContent = r.item_name || r.item_id || '';
      tr.appendChild(tdItem);

      const tdEk = document.createElement('td');
      tdEk.textContent = String(r.qty_ekor_sisa ?? 0);
      tr.appendChild(tdEk);

      const tdKg = document.createElement('td');
      tdKg.textContent = Number(r.qty_kg_sisa ?? 0).toFixed(2);
      tr.appendChild(tdKg);

      const tdPl = document.createElement('td');
      tdPl.textContent = r.pallet_lama || '';
      tr.appendChild(tdPl);

      const tdAct = document.createElement('td');
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'btn btn-ghost btn-small';
      btn.textContent = 'Hapus';
      btn.onclick = () => {
        ipList = ipList.filter(x => x.karung_id !== r.karung_id);
        ipRenderTable();
        ipUpdateCounts();
      };
      tdAct.appendChild(btn);
      tr.appendChild(tdAct);

      ipTbody.appendChild(tr);
    });

    ipUpdateCounts();
  }

  async function ipLoadPalletOptions() {
    const { data: palletData, error: palletError } = await sb
      .from('master_pallet')
      .select('pallet_id')
      .order('pallet_id', { ascending: true });

    if (palletError) throw palletError;

    ipPalletSel.innerHTML = '<option value="">-- Pilih pallet --</option>';
    (palletData || []).forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.pallet_id;
      opt.textContent = p.pallet_id;
      ipPalletSel.appendChild(opt);
    });
  }

  async function ipFetchCountAwal(palletId) {
    if (!palletId) {
      ipCountAwal = 0;
      ipUpdateCounts();
      return;
    }

    // Count karung yang dianggap "ada di pallet" = status tersedia / terbuka
    const { count, error } = await sb
      .from('stok_karung')
      .select('karung_id', { count: 'exact', head: true })
      .eq('pallet_id', palletId)
      .in('status_karung', ['tersedia', 'terbuka']);

    if (error) throw error;

    ipCountAwal = count || 0;
    ipUpdateCounts();
  }

  async function ipLookupKarung(karungId) {
    const { data, error } = await sb
      .from('stok_karung')
      .select('karung_id, item_id, qty_ekor_sisa, qty_kg_sisa, pallet_id, status_karung')
      .eq('karung_id', karungId)
      .maybeSingle();

    if (error) throw error;
    return data;
  }

  async function ipLookupItemName(itemId) {
    if (!itemId) return '';
    const { data, error } = await sb
      .from('items')
      .select('item_name')
      .eq('item_id', itemId)
      .maybeSingle();
    if (error) return '';
    return data?.item_name || '';
  }

  async function ipAddKarung(rawId) {
    const palletTujuan = (ipPalletSel?.value || '').trim();
    if (!palletTujuan) {
      ipSetStatus('Pilih pallet tujuan terlebih dahulu.', 'error');
      playBeep('error');
      return;
	    }

	    const karungId = normalizeKarungId(rawId);
	    if (!karungId) return;

	    if (ipList.some(x => x.karung_id === karungId)) {
      ipSetStatus('Karung ini sudah ada di daftar.', '');
      playBeep('error');
      return;
    }

    ipSetStatus('Mencari karung...', '');
    let k = null;
    try {
	      k = await ipLookupKarung(karungId);
    } catch (e) {
      ipSetStatus('Gagal lookup karung: ' + (e.message || e), 'error');
      playBeep('error');
      return;
    }

	    if (!k) {
	      ipSetStatus('Karung tidak ditemukan: ' + karungId, 'error');
      playBeep('error');
      return;
    }

    const st = String(k.status_karung || '').toLowerCase();
	    if (!['tersedia', 'terbuka'].includes(st)) {
	      ipSetStatus(`Karung ${karungId} status ${st.toUpperCase()} tidak boleh dimasukkan ke pallet. Hanya TERSEDIA / TERBUKA.`, 'error');
      playBeep('error');
      return;
    }

	    if ((k.pallet_id || '') === palletTujuan) {
	      ipSetStatus(`Karung ${karungId} sudah berada di pallet ${palletTujuan}.`, 'error');
      playBeep('error');
      return;
    }

    const itemName = await ipLookupItemName(k.item_id);

    ipList.push({
      karung_id: k.karung_id,
      item_id: k.item_id,
      item_name: itemName || k.item_id,
      qty_ekor_sisa: k.qty_ekor_sisa ?? 0,
      qty_kg_sisa: k.qty_kg_sisa ?? 0,
      pallet_lama: k.pallet_id || ''
    });

    ipRenderTable();
    ipSetStatus('Karung ditambahkan.', 'success');
    playBeep('success');
  }

  async function ipSubmitAll() {
    const palletTujuan = (ipPalletSel?.value || '').trim();
    if (!palletTujuan) {
      ipSetStatus('Pallet tujuan wajib dipilih.', 'error');
      return;
    }
    if (!ipList.length) {
      ipSetStatus('Daftar karung masih kosong.', 'error');
      return;
    }

    if (!confirm(`Pindahkan ${ipList.length} karung ke pallet ${palletTujuan}?`)) return;

    ipSetStatus('Menyimpan perpindahan karung...', '');
    const nowIso = new Date().toISOString();
    const catatan = (ipCatatanEl?.value || '').trim() || null;

    let ok = 0;
    for (const r of ipList) {
      try {
        const { error: updError } = await sb
          .from('stok_karung')
          .update({ pallet_id: palletTujuan, last_location_update: nowIso })
          .eq('karung_id', r.karung_id);

        if (updError) throw updError;

        const { error: logError } = await sb
          .from('log_pindah_lokasi')
          .insert({
            karung_id: r.karung_id,
            pallet_lama: r.pallet_lama || null,
            pallet_baru: palletTujuan,
            operator: operatorDisplayName || null,
            catatan: catatan
          });

        if (logError) throw logError;

        ok++;
      } catch (e) {
        console.error(e);
        ipSetStatus(`Gagal memproses karung ${r.karung_id}: ${e.message || e}`, 'error');
        playBeep('error');
        return;
      }
    }

    ipSetStatus(`Sukses memindahkan ${ok} karung ke pallet ${palletTujuan}.`, 'success');
    ipList = [];
    ipRenderTable();

    // refresh count awal karena pallet sudah berubah
    try { await ipFetchCountAwal(palletTujuan); } catch(e) { console.warn(e); }
    if (ipKarungInput) { ipKarungInput.value = ''; ipKarungInput.focus(); }
  }

  async function ipStartScanner() {
    try {
      if (!window.Html5Qrcode) {
        ipSetStatus('Library QR belum siap. Coba reload.', 'error');
        return;
      }
      if (ipScannerWrap) ipScannerWrap.style.display = '';
      if (ipOpenScannerBtn) ipOpenScannerBtn.style.display = 'none';
      if (ipCloseScannerBtn) ipCloseScannerBtn.style.display = '';

      if (!ipQr) ipQr = new Html5Qrcode('ip-qr-reader');

      await ipQr.start(
        { facingMode: 'environment' },
        { fps: 10, qrbox: { width: 240, height: 240 } },
        async (decodedText) => {
          const scanMassal = document.getElementById('ip-scan-massal')?.checked;
          const raw = String(decodedText || '').trim();
          const id = normalizeKarungId(raw);
          if (!id) return;

          if (scanMassal) {
            await ipAddKarung(id);
            if (ipKarungInput) ipKarungInput.value = '';
          } else {
            if (ipKarungInput) ipKarungInput.value = id;
            ipSetStatus('QR terbaca. Tekan Enter / klik Tambah untuk memasukkan ke daftar.', 'success');
            playBeep('success');
          }
        }
      );
      ipSetStatus('Scanner aktif.', 'success');
    } catch (e) {
      console.error(e);
      ipSetStatus('Gagal mengaktifkan scanner: ' + (e.message || e), 'error');
    }
  }

  async function ipStopScanner() {
    try {
      if (ipQr) {
        await ipQr.stop();
        await ipQr.clear();
      }
    } catch (e) {
      // ignore
    }
    if (ipScannerWrap) ipScannerWrap.style.display = 'none';
    if (ipOpenScannerBtn) ipOpenScannerBtn.style.display = '';
    if (ipCloseScannerBtn) ipCloseScannerBtn.style.display = 'none';
    ipSetStatus('Scanner dihentikan.', '');
  }

  async function initInputPalletOnce() {
    if (inputPalletInitialized) return;
    inputPalletInitialized = true;

    if (ipUserInfoEl && operatorDisplayName) {
      const r = currentProfile && currentProfile.role ? currentProfile.role : 'operator';
      ipUserInfoEl.textContent = operatorDisplayName + (r ? ` (${r})` : '');
    }

    ipSetStatus('Memuat daftar pallet...', '');

    try {
      await ipLoadPalletOptions();
      ipSetStatus('Pilih pallet tujuan, lalu scan/ketik karung.', 'success');
    } catch (e) {
      console.error(e);
      ipSetStatus('Gagal memuat pallet: ' + (e.message || e), 'error');
    }

    ipUpdateCounts();
    ipRenderTable();

    // Kunci input sampai pallet tujuan dipilih
    ipSetEnabled(false);

    if (ipPalletSel) {
      ipPalletSel.addEventListener('change', async () => {
        const palletId = (ipPalletSel.value || '').trim();

        // reset daftar agar tidak salah input antar pallet
        ipList = [];
        ipRenderTable();

        // kunci/unlock input sesuai pilihan pallet
        ipSetEnabled(!!palletId);

        try {
          await ipFetchCountAwal(palletId || null);
        } catch (e) {
          console.warn(e);
          ipSetStatus('Gagal ambil jumlah karung awal: ' + (e.message || e), 'error');
        }

        if (palletId) {
          ipSetStatus('Pallet dipilih. Silakan scan/ketik karung untuk ditambahkan.', 'success');
          if (ipKarungInput) ipKarungInput.focus();
        } else {
          ipSetStatus('Pilih pallet tujuan terlebih dahulu.', '');
        }
      });
    }

    const doAdd = async () => {
      const raw = (ipKarungInput?.value || '').trim();
      if (!raw) return;
      await ipAddKarung(raw);
      if (ipKarungInput) { ipKarungInput.value = ''; ipKarungInput.focus(); }
    };

    if (ipBtnAdd) ipBtnAdd.addEventListener('click', doAdd);
    if (ipKarungInput) {
      ipKarungInput.addEventListener('keydown', async (ev) => {
        if (ev.key === 'Enter') {
          ev.preventDefault();
          await doAdd();
        }
      });
    }

    if (ipSubmitBtn) ipSubmitBtn.addEventListener('click', ipSubmitAll);

    if (ipOpenScannerBtn) ipOpenScannerBtn.addEventListener('click', ipStartScanner);
    if (ipCloseScannerBtn) ipCloseScannerBtn.addEventListener('click', ipStopScanner);
  }



  async function plSearchKarung() {
    plStatusMessage.textContent = '';
    plStatusMessage.className = 'status';
    plSearchResults.innerHTML = '';
    currentKarungData = null;    const rawInput = (plScanInput.value || '').trim();
    const raw = normalizeKarungId(rawInput);
    if (plScanInput) plScanInput.value = raw;

    if (!raw) {
      plStatusMessage.textContent = 'Masukkan / scan Karung ID terlebih dahulu.';
      plStatusMessage.className = 'status error';
      return;
    }

    let { data: karung, error } = await sb
      .from('stok_karung')
      .select('karung_id, item_id, pallet_id, status_karung, qty_ekor_sisa, qty_kg_sisa')
      .eq('karung_id', raw)
      .maybeSingle();

    if (error) {
      console.error(error);
      plStatusMessage.textContent = 'Gagal mencari karung: ' + error.message;
      plStatusMessage.className = 'status error';
      return;
    }

    if (!karung) {
      const { data: candidates, error: searchError } = await sb
        .from('stok_karung')
        .select('karung_id, pallet_id, status_karung')
        .ilike('karung_id', `%${raw}%`)
        .in('status_karung', ['tersedia','terbuka'])
        .limit(10);

      if (searchError) {
        console.error(searchError);
        plStatusMessage.textContent = 'Karung tidak ditemukan dan pencarian tambahan gagal.';
        plStatusMessage.className = 'status error';
        return;
      }

      if (!candidates || candidates.length === 0) {
        plStatusMessage.textContent = 'Karung tidak ditemukan.';
        plStatusMessage.className = 'status error';
        return;
      }

      plStatusMessage.textContent = 'Karung dengan ID persis tidak ada. Pilih dari hasil pencarian di bawah.';
      plStatusMessage.className = 'status';

      plSearchResults.innerHTML = 'Hasil pencarian: ';
      candidates.forEach(c => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn btn-ghost btn-small';
        btn.textContent = c.karung_id + (c.pallet_id ? ` (${c.pallet_id})` : '');
        btn.style.marginRight = '4px';
        btn.onclick = () => {
          plScanInput.value = c.karung_id;
          plLoadKarungById(c.karung_id);
        };
        plSearchResults.appendChild(btn);
      });
      return;
    }

    await plFillKarungInfo(karung);
  }

  async function plLoadKarungById(rawId) {
    const karungId = normalizeKarungId(rawId);
    plStatusMessage.textContent = '';
    plStatusMessage.className = 'status';
    plSearchResults.innerHTML = '';

    const { data: karung, error } = await sb
      .from('stok_karung')
      .select('karung_id, item_id, pallet_id, status_karung, qty_ekor_sisa, qty_kg_sisa')
      .eq('karung_id', karungId)
      .maybeSingle();

    if (error || !karung) {
      plStatusMessage.textContent = 'Gagal mengambil data karung.';
      plStatusMessage.className = 'status error';
      return;
    }

    await plFillKarungInfo(karung);
  }

  async function plFillKarungInfo(karung) {
    // Hanya boleh pindah lokasi untuk status: tersedia / terbuka
    if (!karung || !['tersedia','terbuka'].includes(karung.status_karung)) {
      currentKarungData = null;
      plKarungIdInput.value   = '';
      plItemNameInput.value   = '';
      plPalletLamaInput.value = '';
      plStatusInput.value     = karung && karung.status_karung ? karung.status_karung : '';
      plStokSisaInput.value   = '';
      plStatusMessage.textContent = `Karung ${karung && karung.karung_id ? karung.karung_id : ''} status ${(karung && karung.status_karung ? karung.status_karung : '').toUpperCase()} tidak boleh pindah lokasi. Hanya TERSEDIA / TERBUKA.`;
      plStatusMessage.className = 'status error';
      playBeep('error');
      return;
    }

    currentKarungData = karung;

    plKarungIdInput.value   = karung.karung_id || '';
    plPalletLamaInput.value = karung.pallet_id || '';
    plStatusInput.value     = karung.status_karung || '';
    const sisaEkor = karung.qty_ekor_sisa ?? '';
    const sisaKg   = karung.qty_kg_sisa ?? '';
    plStokSisaInput.value = (sisaEkor || sisaKg)
      ? `${sisaEkor || 0} ekor / ${sisaKg || 0} kg`
      : '';

    let itemName = '';
    if (karung.item_id) {
      const { data: item, error: itemError } = await sb
        .from('items')
        .select('item_name')
        .eq('item_id', karung.item_id)
        .maybeSingle();
      if (!itemError && item) {
        itemName = item.item_name;
      }
    }
    plItemNameInput.value = itemName;

    plStatusMessage.textContent = 'Data karung berhasil dimuat. Silakan pilih pallet baru.';
    plStatusMessage.className = 'status success';
  }

  async function plSubmitPindah() {
    plStatusMessage.textContent = '';
    plStatusMessage.className = 'status';

    if (!currentKarungData) {
      plStatusMessage.textContent = 'Belum ada karung yang dipilih. Cari karung terlebih dahulu.';
      plStatusMessage.className = 'status error';
      return;
    }

    if (!['tersedia','terbuka'].includes(currentKarungData.status_karung)) {
      plStatusMessage.textContent = `Karung ${currentKarungData.karung_id} status ${String(currentKarungData.status_karung).toUpperCase()} tidak boleh pindah lokasi. Hanya TERSEDIA / TERBUKA.`;
      plStatusMessage.className = 'status error';
      playBeep('error');
      return;
    }

    const palletLama = currentKarungData.pallet_id || null;
    const palletBaru = plPalletBaruSelect.value || null;

    if (!palletBaru) {
      plStatusMessage.textContent = 'Pallet baru wajib dipilih.';
      plStatusMessage.className = 'status error';
      return;
    }

    if (palletLama === palletBaru) {
      plStatusMessage.textContent = 'Pallet baru sama dengan pallet lama. Tidak ada perubahan.';
      plStatusMessage.className = 'status error';
      return;
    }

    const catatan = plCatatanInput.value || null;

    plStatusMessage.textContent = 'Menyimpan perpindahan pallet...';
    plStatusMessage.className = 'status';

    try {
      const nowIso = new Date().toISOString();

      const { error: updError } = await sb
        .from('stok_karung')
        .update({
          pallet_id: palletBaru,
          last_location_update: nowIso
        })
        .eq('karung_id', currentKarungData.karung_id);

      if (updError) {
        console.error(updError);
        plStatusMessage.textContent = 'Gagal update lokasi karung: ' + updError.message;
        plStatusMessage.className = 'status error';
        return;
      }

      const { error: logError } = await sb
        .from('log_pindah_lokasi') // GANTI kalau nama tabel log kamu beda
        .insert({
          karung_id: currentKarungData.karung_id,
          pallet_lama: palletLama,
          pallet_baru: palletBaru,
          operator: operatorDisplayName,
          catatan: catatan
        });

      if (logError) {
        console.error(logError);
        plStatusMessage.textContent =
          'Lokasi sudah berpindah, tapi gagal mencatat log perpindahan: ' + logError.message;
        plStatusMessage.className = 'status error';
        return;
      }

      currentKarungData.pallet_id = palletBaru;
      plPalletLamaInput.value = palletBaru;

      plStatusMessage.textContent = 'Pindah pallet berhasil disimpan.';
      plStatusMessage.className = 'status success';
    } catch (err) {
      console.error(err);
      plStatusMessage.textContent = 'Terjadi error tidak terduga: ' + err.message;
      plStatusMessage.className = 'status error';
    }
  }

  async function plStartCameraScan() {
    try {
      if (plCameraRunning) {
        plStatusMessage.textContent = 'Kamera sudah aktif.';
        plStatusMessage.className = 'status';
        return;
      }

      if (!plQrRegion) {
        plStatusMessage.textContent = 'Container kamera tidak ditemukan.';
        plStatusMessage.className = 'status error';
        return;
      }

      plQrRegion.style.display = 'block';
      plStatusMessage.textContent = 'Mengaktifkan kamera...';
      plStatusMessage.className = 'status';

      if (!plQrScanner) {
        plQrScanner = new Html5Qrcode("pl-qr-region");
      }

      const config = {
        fps: 10,
        qrbox: { width: 220, height: 220 }
      };

      await plQrScanner.start(
        { facingMode: "environment" },
        config,
        (decodedText) => {
          plHandleQrResult(decodedText);
        },
        () => {
          // frame error diabaikan
        }
      );

      plCameraRunning = true;
      plStatusMessage.textContent = 'Kamera aktif. Arahkan ke QR karung.';
      plStatusMessage.className = 'status success';
    } catch (err) {
      console.error('Error start camera:', err);
      const msg =
        (err && (err.message || err.name || err.toString())) ||
        'tidak diketahui';
      plStatusMessage.textContent = 'Gagal mengaktifkan kamera: ' + msg;
      plStatusMessage.className = 'status error';
      plQrRegion.style.display = 'none';
    }
  }

  async function plStopCameraScan() {
    try {
      if (plQrScanner && plCameraRunning) {
        await plQrScanner.stop();
        await plQrScanner.clear();
      }
    } catch (err) {
      console.error(err);
    } finally {
      plCameraRunning = false;
      plQrRegion.style.display = 'none';
      plStatusMessage.textContent = 'Kamera dihentikan.';
      plStatusMessage.className = 'status';
    }
  }

  function plHandleQrResult(decodedText) {
    const id = normalizeKarungId(decodedText);
    if (!id) return;

    plScanInput.value = id;
    plStatusMessage.textContent = 'QR terbaca: ' + id + '. Mencari data karung...';
    plStatusMessage.className = 'status success';

    plStopCameraScan();
    plSearchKarung();
  }
// ============== FORM PICKING SLIP LOGIC ==============

  const psUserInfoEl       = document.getElementById('ps-userInfo');
  const psTglPickingInput  = document.getElementById('ps-tgl-picking');
  const psTujuanSelect     = document.getElementById('ps-tujuan');
  const psRowJual          = document.getElementById('ps-row-jual');
  const psNamaCustomerInput= document.getElementById('ps-nama-customer');
  const psNoSoInput        = document.getElementById('ps-no-so');
  const psRowGudangTujuan  = document.getElementById('ps-row-gudang-tujuan');
  const psGudangSelect     = document.getElementById('ps-gudang-tujuan');
  const psCatatanInput     = document.getElementById('ps-catatan');

  const psKarungSearchInput= document.getElementById('ps-karung-search');
  const psBtnSearchKarung  = document.getElementById('ps-btn-search');
  const psSearchStatus     = document.getElementById('ps-search-status');
  const psScanModeToggle   = document.getElementById('ps-scan-mode');
  const psBeepOkToggle     = document.getElementById('ps-beep-success');
  const psBeepErrToggle    = document.getElementById('ps-beep-error');

  const psDetailTable      = document.getElementById('ps-detail-table');
  const psDetailTbody      = document.getElementById('ps-detail-tbody');
  const psSummaryBox       = document.getElementById('ps-summary');

  const psBtnSubmit        = document.getElementById('ps-btn-submit');
  const psBtnClear         = document.getElementById('ps-btn-clear');
  const psStatusMessage    = document.getElementById('ps-status-message');

  let psDetails = [];

  async function initPickingSlipOnce() {
    if (pickingSlipInitialized) return;
    pickingSlipInitialized = true;

    if (psUserInfoEl && operatorDisplayName) {
      const r = currentProfile && currentProfile.role ? currentProfile.role : 'operator';
      psUserInfoEl.textContent = operatorDisplayName + (r ? ` (${r})` : '');
    }

    // default tanggal = hari ini
    if (psTglPickingInput && !psTglPickingInput.value) {
      const now = new Date();
      const offsetMs = now.getTime() - now.getTimezoneOffset() * 60000;
      psTglPickingInput.valueAsNumber = offsetMs;
    }

    // muat master_gudang untuk tujuan pindah_lokasi
    if (psGudangSelect) {
      psGudangSelect.innerHTML = '<option value="">-- Pilih gudang tujuan --</option>';
      const { data: gudangData, error: gudangError } = await sb
        .from('master_gudang')
        .select('gudang_id, nama_gudang, aktif')
        .eq('aktif', true)
        .order('gudang_id', { ascending: true });

      if (gudangError) {
        console.error(gudangError);
        // Tidak langsung blok form, hanya peringatan di console
      } else if (gudangData) {
        gudangData.forEach(g => {
          const opt = document.createElement('option');
          opt.value = g.gudang_id;
          opt.textContent = g.nama_gudang
            ? `${g.gudang_id} â€“ ${g.nama_gudang}`
            : g.gudang_id;
          psGudangSelect.appendChild(opt);
        });
      }
    }

    // perubahaan tujuan: show/hide blok jual / gudang tujuan
    if (psTujuanSelect) {
      psTujuanSelect.addEventListener('change', () => {
        const tujuan = psTujuanSelect.value;
        if (psRowJual) {
          psRowJual.style.display = tujuan === 'jual' ? 'flex' : 'none';
        }
        if (psRowGudangTujuan) {
          psRowGudangTujuan.style.display = tujuan === 'pindah_lokasi' ? 'flex' : 'none';
        }
      });
      psTujuanSelect.dispatchEvent(new Event('change'));
    }


    // restore preferensi scan + beep
    if (psScanModeToggle) {
      const saved = localStorage.getItem('ps_scan_mode');
      if (saved !== null) psScanModeToggle.checked = (saved === '1');
      psScanModeToggle.addEventListener('change', () => {
        localStorage.setItem('ps_scan_mode', psScanModeToggle.checked ? '1' : '0');
        if (psScanModeToggle.checked && psKarungSearchInput) psKarungSearchInput.focus();
      });
    }
    if (psBeepOkToggle) {
      const saved = localStorage.getItem('ps_beep_ok');
      if (saved !== null) psBeepOkToggle.checked = (saved === '1');
      psBeepOkToggle.addEventListener('change', () => {
        localStorage.setItem('ps_beep_ok', psBeepOkToggle.checked ? '1' : '0');
      });
    }
    if (psBeepErrToggle) {
      const saved = localStorage.getItem('ps_beep_err');
      if (saved !== null) psBeepErrToggle.checked = (saved === '1');
      psBeepErrToggle.addEventListener('change', () => {
        localStorage.setItem('ps_beep_err', psBeepErrToggle.checked ? '1' : '0');
      });
    }

    // event handler
    if (psBtnSearchKarung) {
      psBtnSearchKarung.addEventListener('click', psSearchKarung);
    }
    if (psKarungSearchInput) {
      psKarungSearchInput.addEventListener('keyup', e => {
        if (e.key !== 'Enter') return;
        // Jika Mode Scan Massal ON, biarkan auto-add yang bekerja
        if (psScanModeToggle && psScanModeToggle.checked) return;
        psSearchKarung();
      });
}

    // AUTOADD SAAT SCAN (PAKAI BARCODE SCANNER MODEL KEYBOARD)
    if (psKarungSearchInput) {
      let psScanTimer = null;

      psKarungSearchInput.addEventListener('input', (e) => {
        // hanya aktif kalau Mode Scan Massal ON
        if (psScanModeToggle && !psScanModeToggle.checked) return;

        // reset timer setiap ada karakter baru
        if (psScanTimer) clearTimeout(psScanTimer);

        const val = (e.target.value || '').trim();
        if (!val) return;

        // tunggu 300 ms, kalau tidak ada input baru â†’ anggap scan selesai
        psScanTimer = setTimeout(() => {
          psSearchKarung();
        }, 300); // bisa diubah ke 100â€“300 ms sesuai karakter scanner
      });
    }

    if (psBtnSubmit) {
      psBtnSubmit.addEventListener('click', psSubmitPickingSlip);
    }
    if (psBtnClear) {
      psBtnClear.addEventListener('click', () => {
        psDetails = [];
        psRenderDetailTable();
        psStatusMessage.textContent = '';
        psStatusMessag

  // ============== RIWAYAT PICKING SLIP (CARI / PRINT ULANG / DELETE) ==============
  const rpsUserInfoEl  = document.getElementById('rps-userInfo');
  const rpsKeywordEl   = document.getElementById('rps-keyword');
  const rpsDateFromEl  = document.getElementById('rps-date-from');
  const rpsDateToEl    = document.getElementById('rps-date-to');
  const rpsBtnSearch   = document.getElementById('rps-btn-search');
  const rpsStatusEl    = document.getElementById('rps-status');
  const rpsTableEl     = document.getElementById('rps-table');
  const rpsTbodyEl     = document.getElementById('rps-tbody');

  function rpsSetStatus(msg, kind = '') {
    if (!rpsStatusEl) return;
    rpsStatusEl.textContent = msg || '';
    rpsStatusEl.className = 'status' + (kind ? ` ${kind}` : '');
  }

  function rpsFmtDate(d) {
    if (!d) return '-';
    const dt = new Date(d);
    if (isNaN(dt.getTime())) return String(d);
    return dt.toLocaleDateString('id-ID');
  }

  async function rpsFetchTotalsBySlipIds(ids) {
    // return map: id -> {karung, ekor, kg}
    const totals = {};
    ids.forEach(id => { totals[id] = { karung: 0, ekor: 0, kg: 0 }; });

    const { data, error } = await sb
      .from('picking_slip_detail')
      .select('picking_slip_id, qty_ekor_keluar, qty_kg_keluar')
      .in('picking_slip_id', ids);

    if (error) throw error;

    (data || []).forEach(r => {
      const pid = r.picking_slip_id;
      if (!totals[pid]) totals[pid] = { karung: 0, ekor: 0, kg: 0 };
      totals[pid].karung += 1;
      totals[pid].ekor   += Number(r.qty_ekor_keluar || 0);
      totals[pid].kg     += Number(r.qty_kg_keluar || 0);
    });

    return totals;
  }

  async function rpsLoadAndPrint(pickingSlipId) {
    rpsSetStatus('Mengambil data picking slip...', '');
    // 1) header
    const { data: hdr, error: hdrErr } = await sb
      .from('picking_slip')
      .select('id, no_picking_slip, tgl_picking, tujuan, nama_customer, no_so, gudang_tujuan, catatan')
      .eq('id', pickingSlipId)
      .maybeSingle();

    if (hdrErr) {
      console.error(hdrErr);
      rpsSetStatus('Gagal memuat header: ' + (hdrErr.message || ''), 'error');
      return;
    }
    if (!hdr) {
      rpsSetStatus('Picking slip tidak ditemukan.', 'error');
      return;
    }

    // 2) detail
    const { data: det, error: detErr } = await sb
      .from('picking_slip_detail')
      .select('karung_id, item_id, qty_ekor_keluar, qty_kg_keluar')
      .eq('picking_slip_id', pickingSlipId)
      .order('karung_id', { ascending: true });

    if (detErr) {
      console.error(detErr);
      rpsSetStatus('Gagal memuat detail: ' + (detErr.message || ''), 'error');
      return;
    }

    const itemIds = Array.from(new Set((det || []).map(r => r.item_id).filter(Boolean)));
    const itemNameMap = {};
    if (itemIds.length) {
      const { data: it, error: itErr } = await sb
        .from('items')
        .select('item_id, item_name')
        .in('item_id', itemIds);

      if (itErr) {
        console.warn('Gagal mengambil nama item, lanjut tanpa item_name:', itErr);
      } else {
        (it || []).forEach(row => { itemNameMap[row.item_id] = row.item_name || row.item_id; });
      }
    }

    const detail = (det || []).map(r => ({
      karung_id: r.karung_id,
      item_id: r.item_id,
      item_name: itemNameMap[r.item_id] || r.item_id,
      qty_ekor_keluar: Number(r.qty_ekor_keluar || 0),
      qty_kg_keluar: Number(r.qty_kg_keluar || 0)
    }));

    const header = {
      tgl_picking: hdr.tgl_picking || null,
      tujuan: hdr.tujuan || '',
      nama_customer: hdr.nama_customer || null,
      no_so: hdr.no_so || null,
      gudang_tujuan: hdr.gudang_tujuan || null,
      catatan: hdr.catatan || null
    };

    rpsSetStatus('');
    openPickingSlipWindow(hdr.no_picking_slip || '(tanpa nomor)', header, detail);
  }

  function rpsRenderRows(rows, totalsMap) {
    if (!rpsTbodyEl || !rpsTableEl) return;
    rpsTbodyEl.innerHTML = '';

    (rows || []).forEach(r => {
      const t = totalsMap && totalsMap[r.id] ? totalsMap[r.id] : { karung: 0, ekor: 0, kg: 0 };

      const tr = document.createElement('tr');

      const tdTgl = document.createElement('td');
      tdTgl.textContent = rpsFmtDate(r.tgl_picking);
      tr.appendChild(tdTgl);

      const tdNo = document.createElement('td');
      tdNo.textContent = r.no_picking_slip || '';
      tr.appendChild(tdNo);

      const tdTujuan = document.createElement('td');
      tdTujuan.textContent = r.tujuan || '';
      tr.appendChild(tdTujuan);

      const tdCust = document.createElement('td');
      tdCust.textContent = r.nama_customer || '';
      tr.appendChild(tdCust);

      const tdKarung = document.createElement('td');
      tdKarung.textContent = String(t.karung || 0);
      tr.appendChild(tdKarung);

      const tdEkor = document.createElement('td');
      tdEkor.textContent = String(t.ekor || 0);
      tr.appendChild(tdEkor);

      const tdKg = document.createElement('td');
      tdKg.textContent = Number(t.kg || 0).toFixed(2);
      tr.appendChild(tdKg);

      const tdAksi = document.createElement('td');

      const btnPrint = document.createElement('button');
      btnPrint.type = 'button';
      btnPrint.className = 'btn btn-secondary btn-small';
      btnPrint.textContent = 'Print Ulang';
      btnPrint.addEventListener('click', async () => {
        try {
          await rpsLoadAndPrint(r.id);
        } catch (e) {
          console.error(e);
          rpsSetStatus('Gagal print ulang: ' + (e.message || ''), 'error');
        }
      });
      tdAksi.appendChild(btnPrint);

      tr.appendChild(tdAksi);

      rpsTbodyEl.appendChild(tr);
    });

    rpsTableEl.style.display = (rows && rows.length) ? 'table' : 'none';
  }

  async function rpsSearch() {
    if (!rpsKeywordEl || !rpsDateFromEl || !rpsDateToEl) return;

    const kw = (rpsKeywordEl.value || '').trim();
    const dFrom = rpsDateFromEl.value || '';
    const dTo = rpsDateToEl.value || '';

    rpsSetStatus('Mencari picking slip...', '');
    if (rpsTableEl) rpsTableEl.style.display = 'none';
    if (rpsTbodyEl) rpsTbodyEl.innerHTML = '';

    let q = sb
      .from('picking_slip')
      .select('id, no_picking_slip, tgl_picking, tujuan, nama_customer')
      .order('tgl_picking', { ascending: false })
      .limit(50);

    if (kw) {
      // cari di nomor & nama_customer
      const safe = kw.replace(/,/g, ' ');
      q = q.or(`no_picking_slip.ilike.%${safe}%,nama_customer.ilike.%${safe}%`);
    }
    if (dFrom) q = q.gte('tgl_picking', dFrom);
    if (dTo) q = q.lte('tgl_picking', dTo);

    const { data: rows, error } = await q;
    if (error) {
      console.error(error);
      rpsSetStatus('Gagal mencari: ' + (error.message || ''), 'error');
      return;
    }

    if (!rows || rows.length === 0) {
      rpsSetStatus('Tidak ada data.', '');
      rpsRenderRows([], {});
      return;
    }

    const ids = rows.map(r => r.id);
    try {
      const totalsMap = await rpsFetchTotalsBySlipIds(ids);
      rpsSetStatus(`Menampilkan ${rows.length} data (maks 50).`, 'success');
      rpsRenderRows(rows, totalsMap);
    } catch (e) {
      console.error(e);
      rpsSetStatus('Data header ditemukan, tapi gagal hitung total detail: ' + (e.message || ''), 'error');
      rpsRenderRows(rows, {});
    }
  }

  



e.className = 'status';
      });
    }
  }


  
  // ===== Global WebAudio Beep (reusable AudioContext) =====
  let __beepCtx = null;

  function playBeep(type = 'success') {
    // type: 'success' | 'error'
    try {
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      if (!AudioCtx) return;

      if (!__beepCtx) __beepCtx = new AudioCtx();

      // Some browsers start suspended until user interaction
      if (__beepCtx.state === 'suspended') {
        __beepCtx.resume().catch(() => {});
      }

      const now = __beepCtx.currentTime;
      const osc = __beepCtx.createOscillator();
      const gain = __beepCtx.createGain();

      const isOk = (type === 'success' || type === 'ok');

      // OK: higher & shorter. Error: lower & slightly longer.
      const freq = isOk ? 880 : 220;
      const dur  = isOk ? 0.08 : 0.18;

      osc.type = isOk ? 'sine' : 'square';
      osc.frequency.setValueAtTime(freq, now);

      // Simple envelope to avoid clicks
      gain.gain.setValueAtTime(0.0001, now);
      gain.gain.exponentialRampToValueAtTime(isOk ? 0.08 : 0.12, now + 0.01);
      gain.gain.exponentialRampToValueAtTime(0.0001, now + dur);

      osc.connect(gain);
      gain.connect(__beepCtx.destination);

      osc.start(now);
      osc.stop(now + dur + 0.02);
    } catch (e) {
      // Do nothing if audio is blocked/unavailable
      console.warn('Beep blocked:', e);
    }
  }

function psBeep(kind) {
    // kind: 'ok' | 'err'
    const okEnabled  = !psBeepOkToggle  || psBeepOkToggle.checked;
    const errEnabled = !psBeepErrToggle || psBeepErrToggle.checked;

    if (kind === 'ok' && !okEnabled) return;
    if (kind === 'err' && !errEnabled) return;

    // Use global reusable AudioContext
    playBeep(kind === 'ok' ? 'success' : 'error');
  }

  async function psSearchKarung() {
    const now = Date.now();
    if (window.__psLastScanTime && now - window.__psLastScanTime < 350) {
      return;
    }
    window.__psLastScanTime = now;

    if (!psKarungSearchInput) return;

    psSearchStatus.textContent = '';
    psSearchStatus.className = 'status';    const rawInput = (psKarungSearchInput.value || '').trim();
    const raw = normalizeKarungId(rawInput);
    if (psKarungSearchInput) psKarungSearchInput.value = raw;

    if (!raw) {
      psSearchStatus.textContent = 'Masukkan ID karung terlebih dahulu.';
      psSearchStatus.className = 'status error';
      psBeep('err');
      return;
    }

    // Cegah duplikat
    if (psDetails.some(d => d.karung_id === raw)) {
      psSearchStatus.textContent = 'Karung ini sudah ada di daftar.';
      psSearchStatus.className = 'status';
      psBeep('err');
      return;
    }

    psSearchStatus.textContent = 'Mencari karung...';
    psSearchStatus.className = 'status';

    const { data: karung, error } = await sb
      .from('stok_karung')
      .select('karung_id, item_id, status_karung, qty_ekor_sisa, qty_kg_sisa')
      .eq('karung_id', raw)
      .maybeSingle();

    if (error) {
      console.error(error);
      psSearchStatus.textContent = 'Gagal mencari karung: ' + error.message;
      psSearchStatus.className = 'status error';
      psBeep('err');
      return;
    }

    if (!karung) {
      psSearchStatus.textContent = 'Karung tidak ditemukan atau stok sudah habis.';
      psSearchStatus.className = 'status error';
      psBeep('err');
      return;
    }


    // Draft hanya untuk Receipt Slip (tidak boleh dipakai transaksi lain)
    if (karung.status_karung === 'draft') {
      psSearchStatus.textContent = `Karung ${raw} masih draft. Terima dulu lewat Receipt Slip.`;
      psSearchStatus.className = 'status error';
      psBeep('err');
      return;
    }

    if (karung.status_karung === 'habis' || karung.status_karung === 'digabung') {
      psSearchStatus.textContent = `Karung ${raw} status ${karung.status_karung} tidak bisa diproses.`;
      psSearchStatus.className = 'status error';
      psBeep('err');
      return;
    }

    const sisaEkor = karung.qty_ekor_sisa ?? 0;
    const sisaKg   = karung.qty_kg_sisa ?? 0;

    if (sisaEkor <= 0 && sisaKg <= 0) {
      psSearchStatus.textContent = 'Stok karung ini sudah 0.';
      psSearchStatus.className = 'status error';
      psBeep('err');
      return;
    }

    // ambil nama item (opsional)
    let itemName = '';
    if (karung.item_id) {
      const { data: item, error: itemError } = await sb
        .from('items')
        .select('item_name')
        .eq('item_id', karung.item_id)
        .maybeSingle();
      if (!itemError && item) {
        itemName = item.item_name;
      }
    }

    psDetails.push({
      karung_id: karung.karung_id,
      item_id: karung.item_id,
      item_name: itemName,
      qty_ekor_sisa: sisaEkor,
      qty_kg_sisa: sisaKg,
      qty_ekor_keluar: sisaEkor,
      qty_kg_keluar: sisaKg
    });

    psKarungSearchInput.value = '';
    psKarungSearchInput.focus();   // <â€” tambahkan ini
    psBeep('ok');

    psSearchStatus.textContent = 'Karung ditambahkan ke daftar.';
    psSearchStatus.className = 'status success';

    psRenderDetailTable();
  }

  function psRenderDetailTable() {
    psDetailTbody.innerHTML = '';

    if (!psDetails.length) {
      psDetailTable.style.display = 'none';
      psSummaryBox.style.display = 'none';
      return;
    }

    let totalKarung = psDetails.length;
    let totalEkor = 0;
    let totalKg = 0;

    psDetails.forEach((row, index) => {
      const tr = document.createElement('tr');

      const tdKarung = document.createElement('td');
      tdKarung.textContent = row.karung_id;
      tr.appendChild(tdKarung);

      const tdItem = document.createElement('td');
      tdItem.textContent = row.item_name || row.item_id || '-';
      tr.appendChild(tdItem);

      const tdStok = document.createElement('td');
      const stokText = `${row.qty_ekor_sisa} ekor / ${Number(row.qty_kg_sisa).toFixed(2)} kg`;
      tdStok.textContent = stokText;
      tr.appendChild(tdStok);

      const tdEkorKeluar = document.createElement('td');
      const inputEkor = document.createElement('input');
      inputEkor.type = 'number';
      inputEkor.min = '0';
      inputEkor.step = '1';
      inputEkor.value = row.qty_ekor_keluar;
      inputEkor.className = 'input-number';
      inputEkor.addEventListener('change', () => {
        let val = parseInt(inputEkor.value || '0', 10);
        if (isNaN(val) || val < 0) val = 0;
        if (val > row.qty_ekor_sisa) val = row.qty_ekor_sisa;
        row.qty_ekor_keluar = val;
        psRenderDetailTable();
      });
      tdEkorKeluar.appendChild(inputEkor);
      tr.appendChild(tdEkorKeluar);

      const tdKgKeluar = document.createElement('td');
      const inputKg = document.createElement('input');
      inputKg.type = 'number';
      inputKg.min = '0';
      inputKg.step = '0.01';
      inputKg.value = row.qty_kg_keluar;
      inputKg.className = 'input-number';
      inputKg.addEventListener('change', () => {
        let val = parseFloat(inputKg.value || '0');
        if (isNaN(val) || val < 0) val = 0;
        if (val > row.qty_kg_sisa) val = row.qty_kg_sisa;
        row.qty_kg_keluar = val;
        psRenderDetailTable();
      });
      tdKgKeluar.appendChild(inputKg);
      tr.appendChild(tdKgKeluar);

      const sisaEkor = row.qty_ekor_sisa - row.qty_ekor_keluar;
      const sisaKg   = row.qty_kg_sisa - row.qty_kg_keluar;
      const tdSisa = document.createElement('td');
      tdSisa.textContent = `${sisaEkor} ekor / ${Number(sisaKg).toFixed(2)} kg`;
      tr.appendChild(tdSisa);

      const tdAksi = document.createElement('td');
      tr.appendChild(tdAksi);

      psDetailTbody.appendChild(tr);

      totalEkor += row.qty_ekor_keluar;
      totalKg   += row.qty_kg_keluar;
    });

    psDetailTable.style.display = 'table';
    psSummaryBox.innerHTML = `
      Jumlah karung: <strong>${totalKarung}</strong><br/>
      Total diambil: <strong>${totalEkor}</strong> ekor /
      <strong>${totalKg.toFixed(2)}</strong> kg
    `;
    psSummaryBox.style.display = 'block';
  }

  async function psSubmitPickingSlip() {
    psStatusMessage.textContent = '';
    psStatusMessage.className = 'status';

    if (!psDetails.length) {
      psStatusMessage.textContent = 'Tambahkan minimal 1 karung sebelum submit.';
      psStatusMessage.className = 'status error';
      return;
    }

    const tujuan       = psTujuanSelect ? psTujuanSelect.value : '';
    const tglPicking   = psTglPickingInput ? psTglPickingInput.value : null;
    const namaCustomer = psNamaCustomerInput ? psNamaCustomerInput.value.trim() : '';
    const noSo         = psNoSoInput ? psNoSoInput.value.trim() : '';
    const gudangTujuan = psGudangSelect ? psGudangSelect.value : '';
    const catatan      = psCatatanInput ? psCatatanInput.value.trim() : '';

    if (!tujuan) {
      psStatusMessage.textContent = 'Tujuan wajib dipilih.';
      psStatusMessage.className = 'status error';
      return;
    }
    if (tujuan === 'jual' && !namaCustomer) {
      psStatusMessage.textContent = 'Nama customer wajib diisi untuk tujuan JUAL.';
      psStatusMessage.className = 'status error';
      return;
    }
    if (tujuan === 'pindah_lokasi' && !gudangTujuan) {
      psStatusMessage.textContent = 'Gudang tujuan wajib dipilih untuk PINDAH LOKASI.';
      psStatusMessage.className = 'status error';
      return;
    }

    const detailPayload = psDetails.map(row => ({
      karung_id: row.karung_id,
      item_id: row.item_id,
      qty_ekor_keluar: row.qty_ekor_keluar,
      qty_kg_keluar: row.qty_kg_keluar,
      keterangan: null
    }));

    const payload = {
      header: {
        tgl_picking: tglPicking || null,
        tujuan,
        nama_customer: namaCustomer || null,
        no_so: noSo || null,
        gudang_tujuan: gudangTujuan || null,
        catatan: catatan || null
      },
      detail: detailPayload
    };

    psStatusMessage.textContent = 'Menyimpan picking slip...';
    psStatusMessage.className = 'status';

    const { data, error } = await sb
      .rpc('fn_submit_picking_slip', { payload });

    if (error) {
      console.error(error);
      psStatusMessage.textContent = 'Gagal menyimpan picking slip: ' + (error.message || '');
      psStatusMessage.className = 'status error';
      return;
    }

    const noDoc = data && data.no_picking_slip ? data.no_picking_slip : '(tanpa nomor)';
    psStatusMessage.textContent = `Picking slip berhasil disimpan: ${noDoc}`;
    psStatusMessage.className = 'status success';

    openPickingSlipWindow(noDoc, payload.header, psDetails);

    // reset detail, tapi biarkan tanggal & tujuan tetap
    psDetails = [];
    psRenderDetailTable();

    if (psNamaCustomerInput) psNamaCustomerInput.value = '';
    if (psNoSoInput) psNoSoInput.value = '';
    if (psCatatanInput) psCatatanInput.value = '';

  }
  // ============== LAPORAN STOK PER ITEM & PALLET ==============

  const lsUserInfoEl     = document.getElementById('ls-userInfo');
  const lsItemSelect     = document.getElementById('ls-itemSelect');
  const lsBtnTampilkan   = document.getElementById('ls-btn-tampilkan');
  const lsStatusMessage  = document.getElementById('ls-status-message');
  const lsSummaryBox     = document.getElementById('ls-summary');
  const lsTable          = document.getElementById('ls-table');
  const lsTbody          = document.getElementById('ls-tbody');
  const lsDetailContainer = document.getElementById('ls-detail-container');
  const lsDetailPallet    = document.getElementById('ls-detail-pallet');
  const lsDetailTbody     = document.getElementById('ls-detail-tbody');

  async function initLaporanStokOnce() {
    if (laporanStokInitialized) return;
    laporanStokInitialized = true;

    if (lsUserInfoEl && operatorDisplayName) {
      const r = currentProfile && currentProfile.role ? currentProfile.role : 'operator';
      lsUserInfoEl.textContent = operatorDisplayName + (r ? ` (${r})` : '');
    }

    lsStatusMessage.textContent = 'Memuat daftar item...';
    lsStatusMessage.className = 'status';

    const { data: itemData, error: itemError } = await sb
      .from('items')
      .select('item_id, item_name')
      .order('item_name', { ascending: true });

    if (itemError) {
      console.error(itemError);
      lsStatusMessage.textContent = 'Gagal memuat item: ' + itemError.message;
      lsStatusMessage.className = 'status error';
      return;
    }

    lsItemSelect.innerHTML = '<option value="">-- Pilih item --</option>';
    (itemData || []).forEach(it => {
      const opt = document.createElement('option');
      opt.value = it.item_id;
      opt.textContent = it.item_name;
      lsItemSelect.appendChild(opt);
    });

    lsStatusMessage.textContent = 'Silakan pilih item, lalu klik "Tampilkan Laporan".';
    lsStatusMessage.className = 'status';

    if (lsBtnTampilkan) {
      lsBtnTampilkan.addEventListener('click', tampilkanLaporanStok);
    }
  }

  async function tampilkanLaporanStok() {
    lsStatusMessage.textContent = '';
    lsStatusMessage.className = 'status';
    lsSummaryBox.style.display = 'none';
    lsTable.style.display = 'none';
    lsTbody.innerHTML = '';

    if (lsDetailContainer) lsDetailContainer.style.display = 'none';
    if (lsDetailTbody) lsDetailTbody.innerHTML = '';

    const itemId = lsItemSelect.value;
    const itemName = lsItemSelect.selectedOptions[0]
      ? lsItemSelect.selectedOptions[0].textContent
      : '';

    if (!itemId) {
      lsStatusMessage.textContent = 'Silakan pilih item terlebih dahulu.';
      lsStatusMessage.className = 'status error';
      return;
    }

    lsStatusMessage.textContent = 'Mengambil data stok dari server...';
    lsStatusMessage.className = 'status';

    const { data: karungData, error: karungError } = await sb
      .from('stok_karung')
      .select('karung_id, pallet_id, status_karung, qty_ekor_sisa, qty_kg_sisa, tgl_produksi')
      .eq('item_id', itemId)
      .in('status_karung', ['tersedia', 'terbuka']);

    if (karungError) {
      console.error(karungError);
      lsStatusMessage.textContent = 'Gagal memuat stok: ' + karungError.message;
      lsStatusMessage.className = 'status error';
      return;
    }

    const rows = (karungData || []).filter(row => {
      const kg = row.qty_kg_sisa ?? 0;
      const ekor = row.qty_ekor_sisa ?? 0;
      return kg > 0 || ekor > 0;
    });

    if (rows.length === 0) {
      lsStatusMessage.textContent = `Tidak ada stok tersedia untuk item "${itemName}".`;
      lsStatusMessage.className = 'status';
      return;
    }

    const byPallet = {};
let overallOldestDate = null; // tgl produksi tertua semua pallet

rows.forEach(r => {
  const pallet = r.pallet_id || '(Belum ada pallet)';
  if (!byPallet[pallet]) {
    byPallet[pallet] = {
      jumlahKarung: 0,
      totalEkor: 0,
      totalKg: 0,
      oldestDate: null   // tgl produksi tertua per pallet
    };
  }
  byPallet[pallet].jumlahKarung += 1;
  byPallet[pallet].totalEkor += r.qty_ekor_sisa ?? 0;
  byPallet[pallet].totalKg   += r.qty_kg_sisa ?? 0;

  // --- update tgl produksi tertua per pallet & global ---
  if (r.tgl_produksi) {
    const d = new Date(r.tgl_produksi);
    if (!isNaN(d.getTime())) {
      if (!byPallet[pallet].oldestDate || d < byPallet[pallet].oldestDate) {
        byPallet[pallet].oldestDate = d;
      }
      if (!overallOldestDate || d < overallOldestDate) {
        overallOldestDate = d;
      }
    }
  }
});

    let grandKarung = 0;
    let grandEkor = 0;
    let grandKg = 0;

    Object.keys(byPallet).sort().forEach(pallet => {
  const data = byPallet[pallet];
  grandKarung += data.jumlahKarung;
  grandEkor   += data.totalEkor;
  grandKg     += data.totalKg;

  const tr = document.createElement('tr');
  tr.style.cursor = 'pointer'; // biar kelihatan bisa diklik

  const tdPallet = document.createElement('td');
  tdPallet.textContent = pallet;
  tr.appendChild(tdPallet);

  const tdOldest = document.createElement('td');
  let oldestText = '-';
  if (data.oldestDate) {
    oldestText = data.oldestDate.toLocaleDateString('id-ID');
  }
  tdOldest.textContent = oldestText;
  tr.appendChild(tdOldest);

  const tdKarung = document.createElement('td');
  tdKarung.textContent = data.jumlahKarung;
  tr.appendChild(tdKarung);

  const tdEkor = document.createElement('td');
  tdEkor.textContent = data.totalEkor;
  tr.appendChild(tdEkor);

  const tdKg = document.createElement('td');
  tdKg.textContent = data.totalKg.toFixed(2);
  tr.appendChild(tdKg);

  // klik baris pallet â†’ munculkan detail karung
  tr.addEventListener('click', () => {
    showDetailKarungForPallet(pallet, rows);
  });

  lsTbody.appendChild(tr);
});

const oldestGlobalText = overallOldestDate
  ? overallOldestDate.toLocaleDateString('id-ID')
  : '-';

lsSummaryBox.innerHTML = `
  Item: <strong>${itemName}</strong><br/>
  Total: <strong>${grandKarung}</strong> karung /
  <strong>${grandEkor}</strong> ekor /
  <strong>${grandKg.toFixed(2)}</strong> kg<br/>
  Tgl produksi tertua (semua pallet): <strong>${oldestGlobalText}</strong>
`;
    lsSummaryBox.style.display = 'block';

    lsTable.style.display = 'table';
    lsStatusMessage.textContent = 'Laporan stok berhasil ditampilkan.';
    lsStatusMessage.className = 'status success';
  }
function showDetailKarungForPallet(pallet, rows) {
  if (!lsDetailContainer || !lsDetailTbody || !lsDetailPallet) return;

  lsDetailTbody.innerHTML = '';
  lsDetailPallet.textContent = pallet;

  const filtered = rows.filter(r => {
    const p = r.pallet_id || '(Belum ada pallet)';
    return p === pallet;
  });

  // urutkan dari tgl produksi paling tua ke muda
  filtered.sort((a, b) => {
    const da = a.tgl_produksi || '';
    const db = b.tgl_produksi || '';
    if (da < db) return -1;
    if (da > db) return 1;
    return 0;
  });

  filtered.forEach(r => {
    const tr = document.createElement('tr');

    const tdKarung = document.createElement('td');
    tdKarung.textContent = r.karung_id;
    tr.appendChild(tdKarung);

    const tdTgl = document.createElement('td');
    let tglText = '-';
    if (r.tgl_produksi) {
      const d = new Date(r.tgl_produksi);
      tglText = isNaN(d.getTime())
        ? r.tgl_produksi
        : d.toLocaleDateString('id-ID');
    }
    tdTgl.textContent = tglText;
    tr.appendChild(tdTgl);

    const tdEkor = document.createElement('td');
    tdEkor.textContent = r.qty_ekor_sisa ?? 0;
    tr.appendChild(tdEkor);

    const tdKg = document.createElement('td');
    const kgVal = Number(r.qty_kg_sisa ?? 0);
    tdKg.textContent = kgVal.toFixed(2);
    tr.appendChild(tdKg);

    lsDetailTbody.appendChild(tr);
  });

  lsDetailContainer.style.display = 'block';
}

  // ============== LAPORAN STOK SEMUA BARANG (RPC) ==============

  const lssUserInfoEl  = document.getElementById('lss-userInfo');
  const lssKeywordEl   = document.getElementById('lss-keyword');
  const lssBtnRefresh  = document.getElementById('lss-btn-refresh');
  const lssStatusEl    = document.getElementById('lss-status');
  const lssSummaryEl   = document.getElementById('lss-summary');
  const lssTableEl     = document.getElementById('lss-table');
  const lssTbodyEl     = document.getElementById('lss-tbody');

  let lssRowsCache = [];
let lssDetailSelected = null; // row object {item_id,item_name,...}
  let lssDetailPage = 1;
  const LSS_PAGE_SIZE = 20;

  const lssDetailEl       = document.getElementById('lss-detail');
  const lssDetailItemEl   = document.getElementById('lss-detail-item');
  const lssDetailTbodyEl  = document.getElementById('lss-detail-tbody');
  const lssDetailCloseBtn = document.getElementById('lss-detail-close');
  const lssPrevBtn        = document.getElementById('lss-prev');
  const lssNextBtn        = document.getElementById('lss-next');
  const lssPageInfoEl     = document.getElementById('lss-pageinfo');

  if (lssDetailCloseBtn) {
    lssDetailCloseBtn.addEventListener('click', () => {
      if (lssDetailEl) lssDetailEl.style.display = 'none';
      lssDetailSelected = null;
      lssDetailPage = 1;
    });
  }
  if (lssPrevBtn) lssPrevBtn.addEventListener('click', () => lssLoadDetailPage(lssDetailPage - 1));
  if (lssNextBtn) lssNextBtn.addEventListener('click', () => lssLoadDetailPage(lssDetailPage + 1));

  async function lssOpenDetail(row) {
    lssDetailSelected = row || null;
    lssDetailPage = 1;

    if (lssDetailItemEl) {
      const nm = row?.item_name || '-';
      lssDetailItemEl.textContent = nm;
    }

    if (lssDetailEl) lssDetailEl.style.display = 'block';
    await lssLoadDetailPage(1);
  }

  async function lssLoadDetailPage(page) {
    if (!lssDetailSelected?.item_id) return;
    const p = Number(page || 1);
    if (!Number.isFinite(p) || p < 1) return;

    lssDetailPage = p;

    if (lssDetailTbodyEl) {
      lssDetailTbodyEl.innerHTML = '<tr><td colspan="6">Mengambil data...</td></tr>';
    }
    if (lssPageInfoEl) lssPageInfoEl.textContent = '';

    const from = (lssDetailPage - 1) * LSS_PAGE_SIZE;
    const to   = from + LSS_PAGE_SIZE - 1;

    // Query detail: hanya karung status tersedia/terbuka untuk item ini
    const q = sb
      .from('stok_karung')
      .select('karung_id,pallet_id,tgl_produksi,status_karung,qty_ekor_sisa,qty_kg_sisa', { count: 'exact' })
      .eq('item_id', lssDetailSelected.item_id)
      .in('status_karung', ['tersedia', 'terbuka'])
      .order('tgl_produksi', { ascending: true })
      .order('karung_id', { ascending: true })
      .range(from, to);

    const { data, error, count } = await q;

    if (error) {
      console.error(error);
      if (lssDetailTbodyEl) lssDetailTbodyEl.innerHTML = '<tr><td colspan="6">Gagal memuat detail.</td></tr>';
      if (lssPageInfoEl) lssPageInfoEl.textContent = 'Error memuat detail.';
      return;
    }

    const rows = Array.isArray(data) ? data : [];
    const totalRows = Number(count ?? 0) || 0;
    const totalPages = Math.max(1, Math.ceil(totalRows / LSS_PAGE_SIZE));

    // tombol pager
    if (lssPrevBtn) lssPrevBtn.disabled = (lssDetailPage <= 1);
    if (lssNextBtn) lssNextBtn.disabled = (lssDetailPage >= totalPages);

    if (lssPageInfoEl) {
      lssPageInfoEl.textContent = totalRows
        ? `Page ${lssDetailPage} / ${totalPages} â€” ${totalRows} karung`
        : 'Tidak ada karung.';
    }

    if (!lssDetailTbodyEl) return;
    lssDetailTbodyEl.innerHTML = '';

    if (rows.length === 0) {
      lssDetailTbodyEl.innerHTML = '<tr><td colspan="6">Tidak ada data.</td></tr>';
      return;
    }

    rows.forEach(r => {
      const tr = document.createElement('tr');

      const tdK = document.createElement('td');
      tdK.textContent = r.karung_id || '-';
      tr.appendChild(tdK);

      const tdP = document.createElement('td');
      tdP.textContent = r.pallet_id || '-';
      tr.appendChild(tdP);

      const tdT = document.createElement('td');
      tdT.textContent = r.tgl_produksi ? String(r.tgl_produksi) : '-';
      tr.appendChild(tdT);

      const tdS = document.createElement('td');
      tdS.textContent = r.status_karung || '-';
      tr.appendChild(tdS);

      const tdE = document.createElement('td');
      tdE.textContent = String(r.qty_ekor_sisa ?? 0);
      tr.appendChild(tdE);

      const tdG = document.createElement('td');
      tdG.textContent = lssNum2(r.qty_kg_sisa ?? 0);
      tr.appendChild(tdG);

      lssDetailTbodyEl.appendChild(tr);
    });
  }


  function lssSetStatus(msg, type='') {
    if (!lssStatusEl) return;
    lssStatusEl.textContent = msg || '';
    lssStatusEl.className = 'status' + (type ? ' ' + type : '');
  }

  function lssNum2(n) {
    const v = Number(n ?? 0);
    if (!Number.isFinite(v)) return '0.00';
    return v.toFixed(2);
  }

  function lssApplyFilterAndRender() {
    const kw = (lssKeywordEl?.value || '').toLowerCase().trim();

    const filtered = !kw
      ? (lssRowsCache || [])
      : (lssRowsCache || []).filter(r => {
          const code = String(r.item_code || '').toLowerCase();
          const name = String(r.item_name || '').toLowerCase();
          return code.includes(kw) || name.includes(kw);
        });

    lssTbodyEl.innerHTML = '';
    lssTableEl.style.display = 'none';
    lssSummaryEl.style.display = 'none';

    if (!filtered || filtered.length === 0) {
      lssSetStatus(kw ? 'Tidak ada data yang cocok dengan filter.' : 'Tidak ada stok untuk status tersedia/terbuka.', '');
      return;
    }

    let grandKarung = 0;
    let grandEkor = 0;
    let grandKg = 0;

    filtered.forEach(r => {
      const karung = Number(r.jumlah_karung ?? 0) || 0;
      const ekor   = Number(r.total_ekor ?? 0) || 0;
      const kg     = Number(r.total_kg ?? 0) || 0;

      grandKarung += karung;
      grandEkor   += ekor;
      grandKg     += kg;

      const tr = document.createElement('tr');

      // klik baris untuk lihat rincian karung per item
      tr.style.cursor = 'pointer';
      tr.addEventListener('click', () => lssOpenDetail(r));

      const tdName = document.createElement('td');
      tdName.textContent = r.item_name || '-';
      tr.appendChild(tdName);

      const tdKarung = document.createElement('td');
      tdKarung.textContent = String(karung);
      tr.appendChild(tdKarung);

      const tdEkor = document.createElement('td');
      tdEkor.textContent = String(ekor);
      tr.appendChild(tdEkor);

      const tdKg = document.createElement('td');
      tdKg.textContent = lssNum2(kg);
      tr.appendChild(tdKg);

      lssTbodyEl.appendChild(tr);
    });

    lssSummaryEl.innerHTML =
      '<strong>Total</strong> â€” ' +
      `${grandKarung} karung, ${grandEkor} ekor, ${lssNum2(grandKg)} kg`;

    lssSummaryEl.style.display = 'block';
    lssTableEl.style.display = 'table';
    lssSetStatus(`Menampilkan ${filtered.length} item.`, 'success');
  }

  async function lssLoadFromServer() {
    lssSetStatus('Mengambil data dari server...', '');
    lssTableEl.style.display = 'none';
    lssSummaryEl.style.display = 'none';
    lssTbodyEl.innerHTML = '';

    const { data, error } = await sb.rpc('fn_laporan_stok_semua_barang');

    if (error) {
      console.error(error);
      lssRowsCache = [];
      lssSetStatus('Gagal memuat laporan: ' + (error.message || ''), 'error');
      return;
    }

    lssRowsCache = (data || []).map(r => ({
      item_id: r.item_id,
      item_code: r.item_code,
      item_name: r.item_name,
      jumlah_karung: r.jumlah_karung,
      total_ekor: r.total_ekor,
      total_kg: r.total_kg
    }));

    // default sort by item_name (client-side safety, walau sudah di order di SQL)
    lssRowsCache.sort((a,b) => String(a.item_name||'').localeCompare(String(b.item_name||'')));

    lssApplyFilterAndRender();
  }

  async function initLaporanStokSemuaOnce() {
    if (laporanStokSemuaInitialized) return;
    laporanStokSemuaInitialized = true;

    if (lssUserInfoEl && operatorDisplayName) {
      const r = currentProfile && currentProfile.role ? currentProfile.role : 'operator';
      lssUserInfoEl.textContent = operatorDisplayName + (r ? ` (${r})` : '');
    }

    if (lssBtnRefresh) {
      lssBtnRefresh.addEventListener('click', lssLoadFromServer);
    }
    if (lssKeywordEl) {
      lssKeywordEl.addEventListener('input', () => {
        // render cepat dari cache (tanpa hit server)
        lssApplyFilterAndRender();
      });
    }

    await lssLoadFromServer();
  }

  // ============== LAPORAN BATCH PEMBEKUAN (PER RAK & PER ITEM) ==============

  const lbUserInfoEl    = document.getElementById('lb-userInfo');
  const lbTglAbfInput   = document.getElementById('lb-tgl-abf');
  const lbBatchSelect   = document.getElementById('lb-batch-select');
  const lbRakSelect     = document.getElementById('lb-rak-select');
  const lbBtnTampilkan  = document.getElementById('lb-btn-tampilkan');
  const lbStatusMessage = document.getElementById('lb-status-batch');

  const lbSummaryRak  = document.getElementById('lb-summary-rak');
  const lbTableRak    = document.getElementById('lb-table-rak');
  const lbTbodyRak    = document.getElementById('lb-tbody-rak');

  const lbSummaryItem = document.getElementById('lb-summary-item');
  const lbTableItem   = document.getElementById('lb-table-item');
  const lbTbodyItem   = document.getElementById('lb-tbody-item');

  const lbSummaryDetail = document.getElementById('lb-summary-detail');
  const lbTableDetail   = document.getElementById('lb-table-detail');
  const lbTbodyDetail   = document.getElementById('lb-tbody-detail');

  async function initLaporanBatchOnce() {
    if (laporanBatchInitialized) return;
    laporanBatchInitialized = true;

    // Info user di pojok kanan atas
    if (lbUserInfoEl && operatorDisplayName) {
      const r = currentProfile && currentProfile.role ? currentProfile.role : 'operator';
      lbUserInfoEl.textContent = operatorDisplayName + (r ? ` (${r})` : '');
    }

    // Isi pilihan rak: ALL + RAK_OPTIONS
    if (lbRakSelect) {
      lbRakSelect.innerHTML = '';
      const optAll = document.createElement('option');
      optAll.value = 'ALL';
      optAll.textContent = 'Semua Rak';
      lbRakSelect.appendChild(optAll);

      if (Array.isArray(RAK_OPTIONS)) {
        RAK_OPTIONS.forEach(r => {
          const opt = document.createElement('option');
          opt.value = r;
          opt.textContent = r;
          lbRakSelect.appendChild(opt);
        });
      }
    }

    // Default tanggal hari ini
    if (lbTglAbfInput && !lbTglAbfInput.value) {
      lbTglAbfInput.value = new Date().toISOString().slice(0, 10);
    }

    if (lbTglAbfInput) {
      lbTglAbfInput.addEventListener('change', loadBatchListForDate);
      await loadBatchListForDate();
    }

    if (lbBtnTampilkan) {
      lbBtnTampilkan.addEventListener('click', tampilkanLaporanBatch);
    }
  }

  async function loadBatchListForDate() {
    if (!lbTglAbfInput || !lbBatchSelect) return;

    const tgl = lbTglAbfInput.value;
    lbBatchSelect.innerHTML = '<option value="">-- Pilih batch --</option>';
    lbStatusMessage.textContent = '';
    lbStatusMessage.className = 'status';

    if (!tgl) {
      lbStatusMessage.textContent = 'Silakan pilih tanggal ABF.';
      return;
    }

    lbStatusMessage.textContent = 'Memuat batch untuk tanggal ini...';

    const { data: batches, error } = await sb
      .from('master_batch_abf')
      .select('batch_id, shift_abf')
      .eq('tgl_abf', tgl)
      .order('shift_abf', { ascending: true });

    if (error) {
      console.error(error);
      lbStatusMessage.textContent = 'Gagal memuat daftar batch: ' + error.message;
      lbStatusMessage.className = 'status error';
      return;
    }

    if (!batches || batches.length === 0) {
      lbStatusMessage.textContent = 'Tidak ada batch untuk tanggal ini.';
      return;
    }

    batches.forEach(b => {
      const opt = document.createElement('option');
      opt.value = b.batch_id;
      opt.textContent = `${b.batch_id} (Shift ${b.shift_abf ?? '-'})`;
      lbBatchSelect.appendChild(opt);
    });

    lbStatusMessage.textContent = '';
  }

  function resetLaporanBatchTables() {
    if (lbSummaryRak) {
      lbSummaryRak.style.display = 'none';
      lbSummaryRak.textContent = '';
    }
    if (lbTableRak) {
      lbTableRak.style.display = 'none';
    }
    if (lbTbodyRak) {
      lbTbodyRak.innerHTML = '';
    }

    if (lbSummaryItem) {
      lbSummaryItem.style.display = 'none';
      lbSummaryItem.textContent = '';
    }
    if (lbTableItem) {
      lbTableItem.style.display = 'none';
    }
    if (lbTbodyItem) {
      lbTbodyItem.innerHTML = '';
    }

    if (lbSummaryDetail) {
      lbSummaryDetail.style.display = 'none';
      lbSummaryDetail.textContent = '';
    }
    if (lbTableDetail) {
      lbTableDetail.style.display = 'none';
    }
    if (lbTbodyDetail) {
      lbTbodyDetail.innerHTML = '';
    }
  }

  async function tampilkanLaporanBatch() {
    if (!lbTglAbfInput || !lbBatchSelect) return;

    resetLaporanBatchTables();
    lbStatusMessage.textContent = '';
    lbStatusMessage.className = 'status';

    const tgl = lbTglAbfInput.value;
    const batchId = lbBatchSelect.value;
    const rakFilter = (lbRakSelect && lbRakSelect.value) ? lbRakSelect.value : 'ALL';

    if (!tgl) {
      lbStatusMessage.textContent = 'Tanggal ABF wajib diisi.';
      lbStatusMessage.className = 'status error';
      return;
    }
    if (!batchId) {
      lbStatusMessage.textContent = 'Batch pembekuan wajib dipilih.';
      lbStatusMessage.className = 'status error';
      return;
    }

    lbStatusMessage.textContent = 'Mengambil data batch...';

    // 1) Pastikan batch ada
    const { data: batchRow, error: batchError } = await sb
      .from('master_batch_abf')
      .select('batch_id, tgl_abf')
      .eq('batch_id', batchId)
      .maybeSingle();

    if (batchError) {
      console.error(batchError);
      lbStatusMessage.textContent = 'Gagal memeriksa batch: ' + batchError.message;
      lbStatusMessage.className = 'status error';
      return;
    }
    if (!batchRow) {
      lbStatusMessage.textContent = 'Batch tidak ditemukan.';
      lbStatusMessage.className = 'status error';
      return;
    }

    // 2) Ambil daftar karung untuk batch ini
    const { data: karungData, error: karungError } = await sb
      .from('stok_karung')
      .select('karung_id, item_id, tgl_produksi')
      .eq('batch_pembekuan', batchId);

    if (karungError) {
      console.error(karungError);
      lbStatusMessage.textContent = 'Gagal mengambil karung batch ini: ' + karungError.message;
      lbStatusMessage.className = 'status error';
      return;
    }

    if (!karungData || karungData.length === 0) {
      lbStatusMessage.textContent = 'Belum ada karung untuk batch ini.';
      return;
    }

    const karungIds = karungData
      .map(k => k.karung_id)
      .filter(k => !!k);

    if (karungIds.length === 0) {
      lbStatusMessage.textContent = 'Data karung untuk batch ini tidak valid.';
      return;
    }

    // 3) Ambil detail rak
    const { data: rakData, error: rakError } = await sb
      .from('karung_rak_abf')
      .select('karung_id, rak_abf, qty_ekor, qty_kg')
      .in('karung_id', karungIds);

    if (rakError) {
      console.error(rakError);
      lbStatusMessage.textContent = 'Gagal mengambil detail rak: ' + rakError.message;
      lbStatusMessage.className = 'status error';
      return;
    }

    if (!rakData || rakData.length === 0) {
      lbStatusMessage.textContent = 'Tidak ada data rak untuk batch ini.';
      return;
    }

    // 4) Ambil master item
    const itemIds = Array.from(
      new Set(
        karungData
          .map(k => k.item_id)
          .filter(id => !!id)
      )
    );

    const { data: itemRows, error: itemError } = await sb
      .from('items')
      .select('item_id, item_name')
      .in('item_id', itemIds);

    if (itemError) {
      console.error(itemError);
      lbStatusMessage.textContent = 'Gagal mengambil master item: ' + itemError.message;
      lbStatusMessage.className = 'status error';
      return;
    }

    const itemNameMap = {};
    (itemRows || []).forEach(it => {
      if (it.item_id) {
        itemNameMap[it.item_id] = it.item_name || it.item_id;
      }
    });

    // Map karung -> item_id
    const karungToItem = {};
    karungData.forEach(k => {
      if (k.karung_id) {
        karungToItem[k.karung_id] = k.item_id;
      }
    });

    // Map karung -> tgl_produksi
    const karungToTglProduksi = {};
    karungData.forEach(k => {
      if (k.karung_id) {
        karungToTglProduksi[k.karung_id] = k.tgl_produksi || null;
      }
    });

    // Gabungkan rak + item
    const joinedRows = [];
    rakData.forEach(r => {
      const itemId = karungToItem[r.karung_id];
      if (!itemId) return;
      const itemName = itemNameMap[itemId] || itemId;

      joinedRows.push({
        rak_abf: r.rak_abf || '(Tanpa Rak)',
        item_id: itemId,
        item_name: itemName,
        qty_ekor: Number(r.qty_ekor) || 0,
        qty_kg: Number(r.qty_kg) || 0
      });
    });

    if (joinedRows.length === 0) {
      lbStatusMessage.textContent = 'Tidak ada data gabungan rak + item untuk batch ini.';
      return;
    }

    // ========== PER RAK + ITEM ==========
    const perRakMap = {};
    let totalEkorRak = 0;
    let totalKgRak = 0;

    joinedRows.forEach(row => {
      if (rakFilter !== 'ALL' && row.rak_abf !== rakFilter) return;

      const key = row.rak_abf + '||' + row.item_id;
      if (!perRakMap[key]) {
        perRakMap[key] = {
          rak_abf: row.rak_abf,
          item_id: row.item_id,
          item_name: row.item_name,
          total_ekor: 0,
          total_kg: 0
        };
      }
      perRakMap[key].total_ekor += row.qty_ekor;
      perRakMap[key].total_kg += row.qty_kg;

      totalEkorRak += row.qty_ekor;
      totalKgRak += row.qty_kg;
    });

    const perRakList = Object.values(perRakMap).sort((a, b) => {
      if (a.rak_abf === b.rak_abf) {
        return a.item_name.localeCompare(b.item_name);
      }
      return a.rak_abf.localeCompare(b.rak_abf);
    });

    if (perRakList.length > 0) {
      if (lbSummaryRak) {
        lbSummaryRak.style.display = 'block';
        const rakLabel = rakFilter === 'ALL' ? 'Semua Rak' : `Rak ${rakFilter}`;
        lbSummaryRak.textContent =
          `Batch ${batchId} - ${rakLabel}. ` +
          `Total Ekor: ${totalEkorRak.toLocaleString('id-ID')} | ` +
          `Total Kg: ${totalKgRak.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      }

      if (lbTableRak && lbTbodyRak) {
        lbTableRak.style.display = 'table';
        lbTbodyRak.innerHTML = '';

        perRakList.forEach(row => {
          const tr = document.createElement('tr');

          const tdRak = document.createElement('td');
          tdRak.textContent = row.rak_abf;
          tr.appendChild(tdRak);

          const tdItem = document.createElement('td');
          tdItem.textContent = row.item_name;
          tr.appendChild(tdItem);

          const tdEkor = document.createElement('td');
          tdEkor.textContent = row.total_ekor.toLocaleString('id-ID');
          tr.appendChild(tdEkor);

          const tdKg = document.createElement('td');
          tdKg.textContent = row.total_kg.toLocaleString('id-ID', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          });
          tr.appendChild(tdKg);

          lbTbodyRak.appendChild(tr);
        });
      }
    }

    // ========== PER ITEM (SEMUA RAK) ==========
    const perItemMap = {};
    let totalEkorItem = 0;
    let totalKgItem = 0;

    joinedRows.forEach(row => {
      const key = row.item_id;
      if (!perItemMap[key]) {
        perItemMap[key] = {
          item_id: row.item_id,
          item_name: row.item_name,
          total_ekor: 0,
          total_kg: 0
        };
      }
      perItemMap[key].total_ekor += row.qty_ekor;
      perItemMap[key].total_kg += row.qty_kg;

      totalEkorItem += row.qty_ekor;
      totalKgItem += row.qty_kg;
    });

    const perItemList = Object.values(perItemMap).sort((a, b) =>
      a.item_name.localeCompare(b.item_name)
    );

    if (perItemList.length > 0) {
      if (lbSummaryItem) {
        lbSummaryItem.style.display = 'block';
        lbSummaryItem.textContent =
          `Batch ${batchId} - Semua Rak. ` +
          `Total Ekor: ${totalEkorItem.toLocaleString('id-ID')} | ` +
          `Total Kg: ${totalKgItem.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      }

      if (lbTableItem && lbTbodyItem) {
        lbTableItem.style.display = 'table';
        lbTbodyItem.innerHTML = '';

        perItemList.forEach(row => {
          const tr = document.createElement('tr');

          const tdItem = document.createElement('td');
          tdItem.textContent = row.item_name;
          tr.appendChild(tdItem);

          const tdEkor = document.createElement('td');
          tdEkor.textContent = row.total_ekor.toLocaleString('id-ID');
          tr.appendChild(tdEkor);

          const tdKg = document.createElement('td');
          tdKg.textContent = row.total_kg.toLocaleString('id-ID', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          });
          tr.appendChild(tdKg);

          lbTbodyItem.appendChild(tr);
        });
      }
    }


    // ========== RINCIAN PER KARUNG (DETAIL) ==========
    // Konsep: sumber qty dari karung_rak_abf, batch & item & tgl_produksi dari stok_karung via karung_id.
    const detailList = [];
    rakData.forEach(r => {
      const itemId = karungToItem[r.karung_id];
      if (!itemId) return;

      const itemName = itemNameMap[itemId] || itemId;
      const rakAbf = r.rak_abf || '(Tanpa Rak)';

      if (rakFilter !== 'ALL' && rakAbf !== rakFilter) return;

      detailList.push({
        rak_abf: rakAbf,
        karung_id: r.karung_id,
        item_name: itemName,
        qty_ekor: Number(r.qty_ekor) || 0,
        qty_kg: Number(r.qty_kg) || 0,
        tgl_produksi: karungToTglProduksi[r.karung_id] || null
      });
    });

    // sort: item_name, lalu karung_id
    detailList.sort((a, b) => {
      const c = a.item_name.localeCompare(b.item_name);
      if (c !== 0) return c;
      return String(a.karung_id).localeCompare(String(b.karung_id));
    });

    if (detailList.length > 0) {
      const totalEkorDetail = detailList.reduce((s, x) => s + (x.qty_ekor || 0), 0);
      const totalKgDetail = detailList.reduce((s, x) => s + (x.qty_kg || 0), 0);

      if (lbSummaryDetail) {
        lbSummaryDetail.style.display = 'block';
        const rakLabel = rakFilter === 'ALL' ? 'Semua Rak' : `Rak ${rakFilter}`;
        lbSummaryDetail.textContent =
          `Detail Batch ${batchId} - ${rakLabel}. ` +
          `Total Baris: ${detailList.length.toLocaleString('id-ID')} | ` +
          `Total Ekor: ${totalEkorDetail.toLocaleString('id-ID')} | ` +
          `Total Kg: ${totalKgDetail.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      }

      if (lbTableDetail && lbTbodyDetail) {
        lbTableDetail.style.display = 'table';
        lbTbodyDetail.innerHTML = '';

        detailList.forEach(row => {
          const tr = document.createElement('tr');

          const tdRak = document.createElement('td');
          tdRak.textContent = row.rak_abf;
          tr.appendChild(tdRak);

          const tdKarung = document.createElement('td');
          tdKarung.textContent = row.karung_id;
          tr.appendChild(tdKarung);

          const tdItem = document.createElement('td');
          tdItem.textContent = row.item_name;
          tr.appendChild(tdItem);

          const tdEkor = document.createElement('td');
          tdEkor.textContent = (row.qty_ekor || 0).toLocaleString('id-ID');
          tr.appendChild(tdEkor);

          const tdKg = document.createElement('td');
          tdKg.textContent = (row.qty_kg || 0).toLocaleString('id-ID', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          });
          tr.appendChild(tdKg);

          const tdTgl = document.createElement('td');
          tdTgl.textContent = row.tgl_produksi ? String(row.tgl_produksi) : '-';
          tr.appendChild(tdTgl);

          lbTbodyDetail.appendChild(tr);
        });
      }
    }

    lbStatusMessage.textContent = 'Laporan berhasil ditampilkan.';
    lbStatusMessage.className = 'status success';
  }
function openPickingSlipWindow(noDoc, header, detail) {
  // --- 1) REKAP PER ITEM UNTUK LEMBAR 1 ---
  const perItemMap = {};
  detail.forEach(r => {
    const key = r.item_id || r.item_name || "UNKNOWN";
    if (!perItemMap[key]) {
      perItemMap[key] = {
        item_id: r.item_id,
        item_name: r.item_name || r.item_id || "UNKNOWN",
        jumlah_karung: 0,
        total_ekor: 0,
        total_kg: 0
      };
    }
    perItemMap[key].jumlah_karung += 1;
    perItemMap[key].total_ekor += Number(r.qty_ekor_keluar || 0);
    perItemMap[key].total_kg   += Number(r.qty_kg_keluar || 0);
  });

  const perItemList = Object.values(perItemMap).sort((a, b) =>
    a.item_name.localeCompare(b.item_name)
  );

  const grandTotalEkor   = perItemList.reduce((s, x) => s + x.total_ekor, 0);
  const grandTotalKg     = perItemList.reduce((s, x) => s + x.total_kg, 0);
  const grandTotalKarung = perItemList.reduce((s, x) => s + x.jumlah_karung, 0);

  // --- 2) HEADER INFO (SO, KETERANGAN, DLL) ---
  const isJual = header.tujuan === "jual";

  const headerRowsHTML = `
    <div><strong>Tanggal:</strong> ${header.tgl_picking || "-"}</div>
    <div><strong>Tujuan:</strong> ${header.tujuan || "-"}</div>
    ${header.nama_customer ? `<div><strong>Customer:</strong> ${header.nama_customer}</div>` : ""}
    ${header.gudang_tujuan ? `<div><strong>Gudang Tujuan:</strong> ${header.gudang_tujuan}</div>` : ""}
    ${isJual && header.no_so ? `<div><strong>No. SO:</strong> ${header.no_so}</div>` : ""}
    ${
      isJual && header.catatan
        ? `<div><strong>Keterangan:</strong> ${header.catatan}</div>`
        : (!isJual && header.catatan ? `<div><strong>Catatan:</strong> ${header.catatan}</div>` : "")
    }
  `;

  // --- 3) BUILD HTML PENUH ---
  const slipHTML = `
<html>
<head>
  <title>Picking Slip ${noDoc}</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 10px;
      font-size: 11px;
    }
    h2 { margin: 0 0 4px 0; }
    h3 { margin: 10px 0 4px 0; }
    h4 { margin: 8px 0 4px 0; font-size: 10px; }

    .page-title {
      margin-top: 0;
    }

    .header-box {
      margin-bottom: 8px;
      font-size: 11px;
      display: grid;
      grid-template-columns: 1.5fr 1.5fr;
      column-gap: 16px;
      row-gap: 2px;
    }
    .header-box div {
      margin: 1px 0;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 6px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 4px;
      font-size: 10px;
      text-align: left;
    }
    th {
      background: #f2f2f2;
    }

    .rekap-table th, .rekap-table td {
      padding: 4px;
      font-size: 10px;
    }

    .total-box {
      margin-top: 6px;
      font-weight: bold;
      font-size: 10px;
      text-align: right;
    }

    .sign-section {
      margin-top: 18px;
      font-size: 10px;
    }
    .sign-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
    }
    .sign-table td {
      border: none;
      padding: 2px 4px;
      font-size: 10px;
      text-align: center;
    }
    .sign-space {
      height: 28px;
    }

    .page-break {
      page-break-before: always;
      margin-top: 12px;
    }

    /* LEMBAR 2 DETAIL LEBIH KECIL */
    .sub-header {
      font-size: 9px;
      margin-bottom: 4px;
    }
    .detail-table th,
    .detail-table td {
      font-size: 9px;
      padding: 2px 3px;
    }

    @media print {
      button { display: none; }
    }
  </style>
</head>
<body>

  <!-- ====================== LEMBAR 1: REKAP PER ITEM ====================== -->
  <h2 class="page-title">Picking Slip â€” ${noDoc}</h2>

  <div class="header-box">
    ${headerRowsHTML}
  </div>

  <h3>Rekap per Item</h3>
  <table class="rekap-table">
    <thead>
      <tr>
        <th>Item</th>
        <th>Jumlah Karung</th>
        <th>Total Ekor / Bks</th>
        <th>Total Kg</th>
      </tr>
    </thead>
    <tbody>
      ${perItemList.map(it => `
        <tr>
          <td>${it.item_name}</td>
          <td>${it.jumlah_karung}</td>
          <td>${it.total_ekor}</td>
          <td>${it.total_kg.toFixed(2)}</td>
        </tr>
      `).join("")}
      <tr>
        <td><strong>GRAND TOTAL</strong></td>
        <td><strong>${grandTotalKarung}</strong></td>
        <td><strong>${grandTotalEkor}</strong></td>
        <td><strong>${grandTotalKg.toFixed(2)}</strong></td>
      </tr>
    </tbody>
  </table>

  <div class="total-box">
    Total: ${grandTotalKarung} karung /
    ${grandTotalEkor} ekor /
    ${grandTotalKg.toFixed(2)} kg
  </div>

  <!-- TANDA TANGAN OPERATOR & CHECKER -->
  <div class="sign-section">
    <table class="sign-table">
      <tr>
        <td>Operator</td>
        <td>Checker</td>
      </tr>
      <tr class="sign-space">
        <td></td>
        <td></td>
      </tr>
      <tr>
        <td>(________________________)</td>
        <td>(________________________)</td>
      </tr>
    </table>
  </div>

  <!-- ====================== LEMBAR 2: RINCIAN KARUNG (3 KARUNG / BARIS) ====================== -->
  <div class="page-break"></div>

  <h3 class="page-title">Lembar 2 â€” Rincian per Karung (Kelompok per Item)</h3>
  <div class="sub-header">
    Picking Slip: ${noDoc}
    ${header.nama_customer ? `&nbsp;|&nbsp; Customer: ${header.nama_customer}` : ""}
  </div>

  ${(() => {
    const group = {};
    detail.forEach(r => {
      const key = r.item_name || r.item_id || "UNKNOWN";
      if (!group[key]) group[key] = [];
      group[key].push(r);
    });

    return Object.keys(group).sort().map(itemName => {
      const rows = group[itemName];
      let html = `
        <h4 class="item-title">Item: ${itemName}</h4>
        <table class="detail-table">
          <thead>
            <tr>
              <th>Karung ID</th><th>Ekor</th><th>Kg</th>
              <th>Karung ID</th><th>Ekor</th><th>Kg</th>
              <th>Karung ID</th><th>Ekor</th><th>Kg</th>
            </tr>
          </thead>
          <tbody>
      `;

      for (let i = 0; i < rows.length; i += 3) {
        const chunk = rows.slice(i, i + 3);
        html += "<tr>";
        for (let j = 0; j < 3; j++) {
          const r = chunk[j];
          if (r) {
            html += `
              <td>${r.karung_id}</td>
              <td>${r.qty_ekor_keluar}</td>
              <td>${Number(r.qty_kg_keluar || 0).toFixed(2)}</td>
            `;
          } else {
            html += "<td></td><td></td><td></td>";
          }
        }
        html += "</tr>";
      }

      html += `
          </tbody>
        </table>
      `;
      return html;
    }).join("");
  })()}

  <button onclick="window.print()">Print</button>
</body>
</html>
`;

  const win = window.open("", "_blank", "width=800,height=900");
  win.document.write(slipHTML);
  win.document.close();
  win.focus();
}




  // ==============================
  // FORM GABUNG KARUNG (Buat Karung ID Baru)
  // ==============================
  const gbUserInfoEl  = document.getElementById('gb-userInfo');
  const gbScanInput   = document.getElementById('gb-scan-input');
  const gbBtnAdd      = document.getElementById('gb-btn-add');
  const gbTbody       = document.getElementById('gb-tbody');
  const gbStatusEl    = document.getElementById('gb-status');
  const gbTotalEl     = document.getElementById('gb-total');
  const gbBtnSubmit   = document.getElementById('gb-btn-submit');
  const gbResultEl    = document.getElementById('gb-result');

  const gbTglProduksi = document.getElementById('gb-tgl-produksi');
  const gbBatch       = document.getElementById('gb-batch');
  const gbPallet      = document.getElementById('gb-pallet');
  const gbKet         = document.getElementById('gb-keterangan');

  const gbRows = new Map(); // karung_id -> row

  async function initGabungKarungOnce() {
    if (gabungKarungInitialized) return;
    gabungKarungInitialized = true;

    if (gbUserInfoEl && operatorDisplayName) {
      gbUserInfoEl.textContent = operatorDisplayName;
    }

    if (gbBtnAdd) gbBtnAdd.addEventListener('click', gbAddFromInput);

    if (gbScanInput) {
      gbScanInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          gbAddFromInput();
        }
      });
      gbScanInput.focus();
    }

    if (gbBtnSubmit) gbBtnSubmit.addEventListener('click', gbSubmitGabung);

    if (gbStatusEl) {
      gbStatusEl.textContent = 'Siap scan karung asal.';
      gbStatusEl.className = 'status';
    }
  }

  async function gbAddFromInput() {
    const gbResetInput = () => {
      if (!gbScanInput) return;
      gbScanInput.value = '';
      gbScanInput.focus();
    };

    const rawScan = (gbScanInput?.value || '');
    const karungId = normalizeKarungId(rawScan);

    // Clear input segera agar scan berikutnya tidak terganggu, meskipun karung tidak valid
    gbResetInput();

    if (!karungId) return;;

    gbResultEl.textContent = '';

    if (gbRows.has(karungId)) {
      gbStatusEl.textContent = `Karung ${karungId} sudah ada di daftar.`;
      gbStatusEl.className = 'status error';
      gbResetInput();
      return;
    }

    gbStatusEl.textContent = 'Lookup karung...';
    gbStatusEl.className = 'status';

    const { data: sk, error } = await sb
      .from('stok_karung')
      .select('karung_id,item_id,qty_ekor_sisa,qty_kg_sisa,status_karung')
      .eq('karung_id', karungId)
      .maybeSingle();

    if (error) {
      gbStatusEl.textContent = 'Gagal lookup: ' + error.message;
      gbStatusEl.className = 'status error';
      gbResetInput();
      return;
    }
    if (!sk) {
      gbStatusEl.textContent = 'Karung tidak ditemukan.';
      gbStatusEl.className = 'status error';
      gbResetInput();
      return;
    }
    if (sk.status_karung === 'draft' || sk.status_karung === 'habis' || sk.status_karung === 'digabung') {
      gbStatusEl.textContent = `Karung ${karungId} status ${sk.status_karung} tidak bisa digabung.`;
      gbStatusEl.className = 'status error';
      gbResetInput();
      return;
    }

    let itemName = sk.item_id;
    const { data: it } = await sb
      .from('items')
      .select('item_name')
      .eq('item_id', sk.item_id)
      .maybeSingle();
    if (it?.item_name) itemName = it.item_name;

    const sisaE = sk.qty_ekor_sisa ?? 0;
    const sisaK = Number(sk.qty_kg_sisa ?? 0);

    gbRows.set(karungId, {
      karung_id: karungId,
      item_id: sk.item_id,
      item_name: itemName,
      sisa_ekor: sisaE,
      sisa_kg: sisaK,
      pindah_ekor: sisaE, // default full
      pindah_kg: sisaK    // default full
    });

    gbRenderRows();
    gbRecalcTotal();

    gbResetInput();

    gbStatusEl.textContent = `Ditambahkan: ${karungId}`;
    gbStatusEl.className = 'status success';
  }

  function gbRenderRows() {
    gbTbody.innerHTML = '';
    for (const row of gbRows.values()) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${row.karung_id}</td>
        <td>${row.item_name || '-'}</td>
        <td>${row.sisa_ekor} / ${row.sisa_kg.toFixed(2)}</td>
        <td><input type="number" min="0" step="1" style="width:90px" /></td>
        <td><input type="number" min="0" step="0.01" style="width:110px" /></td>
        <td><button class="btn btn-ghost btn-small">Hapus</button></td>
      `;

      const inputs = tr.querySelectorAll('input');
      const inpEkor = inputs[0];
      const inpKg = inputs[1];

      // Set initial values via properties (avoid invalid value parsing in HTML)
      inpEkor.value = String(row.pindah_ekor ?? 0);
      inpKg.value   = String(Number(row.pindah_kg ?? 0));

      const btnDel = tr.querySelector('button');

      inpEkor.addEventListener('input', () => {
        const v = parseInt(inpEkor.value || '0', 10);
        row.pindah_ekor = isNaN(v) ? 0 : v;
        gbRecalcTotal();
      });
      inpKg.addEventListener('input', () => {
        const v = parseFloat(inpKg.value || '0');
        row.pindah_kg = isNaN(v) ? 0 : v;
        gbRecalcTotal();
      });
      btnDel.addEventListener('click', () => {
        gbRows.delete(row.karung_id);
        gbRenderRows();
        gbRecalcTotal();
      });

      gbTbody.appendChild(tr);
    }
  }

  function gbRecalcTotal() {
    let totE = 0;
    let totK = 0;
    for (const r of gbRows.values()) {
      totE += (r.pindah_ekor || 0);
      totK += (r.pindah_kg || 0);
    }
    gbTotalEl.value = `${totE} ekor / ${totK.toFixed(2)} kg`;
  }

  async function gbSubmitGabung() {
    gbResultEl.textContent = '';

    if (gbRows.size < 2) {
      gbStatusEl.textContent = 'Minimal 2 karung asal.';
      gbStatusEl.className = 'status error';
      return;
    }

    // Validasi item harus sama
    let itemIdRef = null;
    const sources = [];

    for (const r of gbRows.values()) {
      if (!itemIdRef) itemIdRef = r.item_id;
      if (r.item_id !== itemIdRef) {
        gbStatusEl.textContent = 'Item berbeda terdeteksi. Gabung hanya boleh item yang sama.';
        gbStatusEl.className = 'status error';
        return;
      }
      if ((r.pindah_ekor || 0) <= 0 && (r.pindah_kg || 0) <= 0) {
        gbStatusEl.textContent = `Qty pindah 0 pada ${r.karung_id}.`;
        gbStatusEl.className = 'status error';
        return;
      }
      sources.push({ karung_id: r.karung_id, qty_ekor: r.pindah_ekor, qty_kg: r.pindah_kg });
    }

    gbStatusEl.textContent = 'Memproses gabung...';
    gbStatusEl.className = 'status';

    const { data, error } = await sb.rpc('fn_gabung_karung_baru', {
      p_sources: sources,
      p_operator: operatorDisplayName,
      p_keterangan: (gbKet.value || null),
      p_tgl_produksi: (gbTglProduksi.value || null),
      p_batch_pembekuan: (gbBatch.value || null),
      p_pallet_id: (gbPallet.value || null),
    });

    if (error) {
      gbStatusEl.textContent = 'Gagal gabung: ' + error.message;
      gbStatusEl.className = 'status error';
      return;
    }

    gbStatusEl.textContent = 'Sukses.';
    gbStatusEl.className = 'status success';

    gbResultEl.textContent =
      `Karung tujuan baru: ${data.karung_tujuan_id} | Total: ${data.total_ekor} ekor / ${Number(data.total_kg).toFixed(2)} kg`;

    // Cetak label karung tujuan baru
    try {
      const firstRow = gbRows.values().next().value;
      const preview = {
        itemName: firstRow?.item_name || firstRow?.item_id || '',
        tglProduksi: (gbTglProduksi.value || ''),
        totalEkor: data.total_ekor,
        totalKg: Number(data.total_kg),
        catatan: (gbKet.value || '')
      };
      if (typeof openLabelWindow === 'function') {
        openLabelWindow(data.karung_tujuan_id, preview);
      }
    } catch (e) {
      console.error('Gagal membuka window label:', e);
    }

    // Reset
    gbRows.clear();
    gbRenderRows();
    gbRecalcTotal();
    gbScanInput.focus();
  }


  // ============== FORM CEK ISI KARUNG ==============
  const ckUserInfoEl      = document.getElementById('ck-userInfo');
  const ckInputEl         = document.getElementById('ck-input');
  const ckBtnSearch       = document.getElementById('ck-btn-search');
  const ckBtnStart        = document.getElementById('ck-btn-start');
  const ckBtnStop         = document.getElementById('ck-btn-stop');
  const ckQrRegion        = document.getElementById('ck-qr-region');
  const ckStatusEl        = document.getElementById('ck-status');

  const ckKarungIdEl      = document.getElementById('ck-karung-id');
  const ckItemEl          = document.getElementById('ck-item');
  const ckTglEl           = document.getElementById('ck-tgl');
  const ckStatusKarungEl  = document.getElementById('ck-status-karung');
  const ckSisaEl          = document.getElementById('ck-sisa');
  const ckPalletEl        = document.getElementById('ck-pallet');
  const ckBatchEl         = document.getElementById('ck-batch');
  const ckBtnPrint        = document.getElementById('ck-btn-print');

  const ckAbfTable        = document.getElementById('ck-abf-table');
  const ckAbfTbody        = document.getElementById('ck-abf-tbody');
  const ckAbfEmpty        = document.getElementById('ck-abf-empty');

  const ckMergeNote       = document.getElementById('ck-merge-note');
  const ckSrcTable        = document.getElementById('ck-src-table');
  const ckSrcTbody        = document.getElementById('ck-src-tbody');
  const ckSrcEmpty        = document.getElementById('ck-src-empty');

  const ckHistTable       = document.getElementById('ck-hist-table');
  const ckHistTbody       = document.getElementById('ck-hist-tbody');
  const ckHistEmpty       = document.getElementById('ck-hist-empty');
  const ckFilterAll       = document.getElementById('ck-filter-all');
  const ckFilterOut       = document.getElementById('ck-filter-out');

  let ckQrScanner = null;
  let ckCameraRunning = false;
  let ckLastTrace = null;
  let ckHistoryMode = 'all'; // all | out

  async function initCekKarungOnce() {
    if (cekKarungInitialized) return;
    cekKarungInitialized = true;

    if (ckUserInfoEl && operatorDisplayName) {
      const r = currentProfile && currentProfile.role ? currentProfile.role : '';
      ckUserInfoEl.textContent = operatorDisplayName + (r ? ` (${r})` : '');
    }

    ckBtnSearch?.addEventListener('click', () => ckLoadTraceFromInput());
    ckInputEl?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); ckLoadTraceFromInput(); }
    });

    ckBtnStart?.addEventListener('click', () => ckStartCameraScan());
    ckBtnStop?.addEventListener('click', () => ckStopCameraScan());

    ckFilterAll?.addEventListener('click', () => { ckHistoryMode = 'all'; ckRenderHistory(); });
    ckFilterOut?.addEventListener('click', () => { ckHistoryMode = 'out'; ckRenderHistory(); });

    ckBtnPrint?.addEventListener('click', () => {
      if (!ckLastTrace?.header?.karung_id) return;
      const h = ckLastTrace.header;
      const st = (h.status_karung || '').toLowerCase();
      if (st === 'habis' || st === 'digabung') {
        ckSetStatus("Tidak bisa print ulang: status karung 'habis' / 'digabung'.", 'error');
        return;
      }
      const preview = {
        itemName: h.item_name || h.item_id || '',
        tglProduksi: h.tgl_produksi || '',
        totalEkor: h.qty_ekor_sisa ?? 0,
        totalKg: Number(h.qty_kg_sisa ?? 0),
        // optional, jika ingin tampil di label:
        // catatan: '',
      };
      try { openLabelWindow(h.karung_id, preview); } catch (e) { console.error(e); }
    });

    ckSetStatus('Siap scan karung.', 'success');
    ckInputEl?.focus();
  }

  function ckSetStatus(msg, type='') {
    if (!ckStatusEl) return;
    ckStatusEl.textContent = msg || '';
    ckStatusEl.className = 'status' + (type ? ` ${type}` : '');
  }

  function ckResetUI() {
    ckLastTrace = null;

    ckKarungIdEl.value = '';
    ckItemEl.value = '';
    ckTglEl.value = '';
    ckStatusKarungEl.value = '';
    ckSisaEl.value = '';
    ckPalletEl.value = '';
    ckBatchEl.value = '';

    ckAbfTbody.innerHTML = '';
    ckAbfTable.style.display = 'none';
    ckAbfEmpty.style.display = 'none';

    ckMergeNote.style.display = 'none';
    ckMergeNote.textContent = '';
    ckSrcTbody.innerHTML = '';
    ckSrcTable.style.display = 'none';
    ckSrcEmpty.style.display = 'none';

    ckHistTbody.innerHTML = '';
    ckHistTable.style.display = 'none';
    ckHistEmpty.style.display = 'none';
  }

  function ckLoadTraceFromInput() {
    const id = normalizeKarungId(ckInputEl.value || '');
    if (!id) { ckSetStatus('Masukkan/scan karung_id terlebih dahulu.', 'error'); return; }
    ckLoadTrace(id);
  }

  async function ckLoadTrace(karungId) {
    ckResetUI();
    ckSetStatus('Memuat data karung...', '');

    const { data, error } = await sb.rpc('fn_get_karung_trace', { p_karung_id: karungId });

    if (error) {
      console.error(error);
      ckSetStatus('Gagal memuat: ' + error.message + ' (Pastikan RPC fn_get_karung_trace sudah dibuat)', 'error');
      return;
    }
    if (!data || data.ok !== true) {
      ckSetStatus(data?.message || 'Karung tidak ditemukan.', 'error');
      return;
    }

    ckLastTrace = data;
    ckRenderHeader();
    ckRenderAbf();
    ckRenderSources();
    ckRenderHistory();

    ckSetStatus('Data berhasil dimuat.', 'success');
    ckInputEl.value = '';
    ckInputEl.focus();
  }

  function ckRenderHeader() {
    const h = ckLastTrace?.header || {};
    ckKarungIdEl.value = h.karung_id || '';
    ckItemEl.value = (h.item_name || h.item_id || '');
    ckTglEl.value = h.tgl_produksi || '';
    ckStatusKarungEl.value = h.status_karung || '';
    ckSisaEl.value = `${h.qty_ekor_sisa ?? 0} ekor / ${Number(h.qty_kg_sisa ?? 0).toFixed(2)} kg`;
    ckPalletEl.value = h.pallet_id || '';
    ckBatchEl.value = h.batch_pembekuan || '';

    // Aturan: karung status 'habis' atau 'digabung' tidak boleh print ulang
    const st = (h.status_karung || '').toLowerCase();
    const isBlocked = (st === 'habis' || st === 'digabung');
    if (ckBtnPrint) {
      ckBtnPrint.disabled = isBlocked;
      ckBtnPrint.title = isBlocked ? "Tidak bisa print ulang untuk karung status 'habis' / 'digabung'." : '';
    }
  }

  function ckRenderAbf() {
    const rows = ckLastTrace?.abf || [];
    ckAbfTbody.innerHTML = '';

    if (!rows || rows.length === 0) {
      ckAbfTable.style.display = 'none';
      ckAbfEmpty.style.display = 'block';
      return;
    }

    rows.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.rak_abf ?? '-'}</td>
        <td>${r.mesin_abf ?? '-'}</td>
        <td>${Number(r.qty_ekor ?? 0)}</td>
        <td>${Number(r.qty_kg ?? 0).toFixed(2)}</td>
      `;
      ckAbfTbody.appendChild(tr);
    });

    ckAbfEmpty.style.display = 'none';
    ckAbfTable.style.display = 'table';
  }

  function ckRenderSources() {
    const src = ckLastTrace?.sources || [];
    const parent = ckLastTrace?.parent || null;

    ckSrcTbody.innerHTML = '';

    if (parent?.karung_tujuan_id) {
      ckMergeNote.textContent = `Karung ini adalah karung asal yang sudah digabung ke: ${parent.karung_tujuan_id}`;
      ckMergeNote.style.display = 'block';
    } else {
      ckMergeNote.style.display = 'none';
      ckMergeNote.textContent = '';
    }

    if (!src || src.length === 0) {
      ckSrcTable.style.display = 'none';
      ckSrcEmpty.style.display = 'block';
      return;
    }

    src.forEach(s => {
      const pindah = `${s.qty_ekor_pindah ?? 0} / ${Number(s.qty_kg_pindah ?? 0).toFixed(2)}`;
      const sisa = `${s.qty_ekor_sisa ?? 0} / ${Number(s.qty_kg_sisa ?? 0).toFixed(2)}`;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${s.karung_id}</td>
        <td>${s.item_name || s.item_id || '-'}</td>
        <td>${s.tgl_produksi || ''}</td>
        <td>${s.status_karung || ''}</td>
        <td>${sisa}</td>
        <td>${pindah}</td>
      `;
      ckSrcTbody.appendChild(tr);
    });

    ckSrcEmpty.style.display = 'none';
    ckSrcTable.style.display = 'table';
  }

  function ckRenderHistory() {
    const hist = ckLastTrace?.history || [];
    ckHistTbody.innerHTML = '';

    const filtered = (ckHistoryMode === 'out')
      ? hist.filter(h => (Number(h.perubahan_ekor ?? 0) < 0) || (Number(h.perubahan_kg ?? 0) < 0))
      : hist;

    if (!filtered || filtered.length === 0) {
      ckHistTable.style.display = 'none';
      ckHistEmpty.style.display = 'block';
      return;
    }

    filtered.forEach(h => {
      const perubahan = `${Number(h.perubahan_ekor ?? 0)} / ${Number(h.perubahan_kg ?? 0).toFixed(2)}`;
      const sisa = `${Number(h.sisa_ekor_setelah ?? 0)} / ${Number(h.sisa_kg_setelah ?? 0).toFixed(2)}`;
      const waktu = h.waktu_log ? new Date(h.waktu_log).toLocaleString('id-ID') : '';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${waktu}</td>
        <td>${h.jenis_perubahan || ''}</td>
        <td>${perubahan}</td>
        <td>${sisa}</td>
        <td>${(h.keterangan || '').toString()}</td>
        <td>${h.operator || ''}</td>
      `;
      ckHistTbody.appendChild(tr);
    });

    ckHistEmpty.style.display = 'none';
    ckHistTable.style.display = 'table';
  }

  async function ckStartCameraScan() {
    try {
      if (ckCameraRunning) return;
      if (!window.Html5Qrcode) {
        ckSetStatus('Library QR scanner belum tersedia.', 'error');
        return;
      }

      ckQrRegion.style.display = 'block';
      ckSetStatus('Mengaktifkan kamera...', '');

      if (!ckQrScanner) ckQrScanner = new Html5Qrcode('ck-qr-region');
      const config = { fps: 10, qrbox: { width: 220, height: 220 } };

      await ckQrScanner.start(
        { facingMode: 'environment' },
        config,
        (decodedText) => {
          const id = normalizeKarungId(decodedText);
          if (!id) return;
          ckInputEl.value = id;
          ckStopCameraScan();
          ckLoadTraceFromInput();
        },
        () => {}
      );

      ckCameraRunning = true;
      ckSetStatus('Kamera aktif. Arahkan QR ke kamera.', 'success');
    } catch (err) {
      console.error(err);
      ckCameraRunning = false;
      ckQrRegion.style.display = 'none';
      ckSetStatus('Gagal mengaktifkan kamera: ' + (err?.message || err), 'error');
    }
  }

  async function ckStopCameraScan() {
    try {
      if (ckQrScanner && ckCameraRunning) {
        await ckQrScanner.stop();
        await ckQrScanner.clear();
      }
    } catch (err) {
      console.error(err);
    } finally {
      ckCameraRunning = false;
      ckQrRegion.style.display = 'none';
    }
  }


  // ============== LAPORAN MUTASI PER ITEM (Saldo Awal + Mutasi + Saldo Akhir) ==============

  const lmUserInfoEl   = document.getElementById('lm-userInfo');
  const lmDateFromEl   = document.getElementById('lm-date-from');
  const lmDateToEl     = document.getElementById('lm-date-to');
  const lmBtnTampilEl  = document.getElementById('lm-btn-tampilkan');
  const lmStatusEl     = document.getElementById('lm-status');
  const lmSummaryEl    = document.getElementById('lm-summary');
  const lmTableEl      = document.getElementById('lm-table');
  const lmTbodyEl      = document.getElementById('lm-tbody');

  function lmSetStatus(msg, type='') {
    if (!lmStatusEl) return;
    lmStatusEl.textContent = msg || '';
    lmStatusEl.className = 'status' + (type ? ' ' + type : '');
  }

  function lmKg2(n) {
    const v = Number(n ?? 0);
    if (!Number.isFinite(v)) return '0.00';
    return v.toFixed(2);
  }

  async function initLaporanMutasiOnce() {
    if (laporanMutasiInitialized) return;
    laporanMutasiInitialized = true;

    // Info user di pojok kanan atas
    if (lmUserInfoEl && operatorDisplayName) {
      const r = currentProfile && currentProfile.role ? currentProfile.role : 'operator';
      lmUserInfoEl.textContent = operatorDisplayName + (r ? ` (${r})` : '');
    }

    // Default tanggal: 7 hari terakhir
    const now = new Date();
    const dTo = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const dFrom = new Date(dTo);
    dFrom.setDate(dFrom.getDate() - 6);

    if (lmDateFromEl && !lmDateFromEl.value) lmDateFromEl.value = dFrom.toISOString().slice(0, 10);
    if (lmDateToEl && !lmDateToEl.value) lmDateToEl.value = dTo.toISOString().slice(0, 10);

    if (lmBtnTampilEl) {
      lmBtnTampilEl.addEventListener('click', tampilkanLaporanMutasi);
    }
  }

  async function tampilkanLaporanMutasi() {
    if (!lmDateFromEl || !lmDateToEl || !lmTbodyEl || !lmTableEl) return;

    lmSetStatus('', '');
    lmTbodyEl.innerHTML = '';
    lmTableEl.style.display = 'none';
    if (lmSummaryEl) {
      lmSummaryEl.style.display = 'none';
      lmSummaryEl.textContent = '';
    }

    const dFrom = lmDateFromEl.value;
    const dTo = lmDateToEl.value;
    if (!dFrom || !dTo) {
      lmSetStatus('Tanggal Dari & Tanggal Sampai wajib diisi.', 'error');
      return;
    }
    if (dFrom > dTo) {
      lmSetStatus('Tanggal Dari tidak boleh lebih besar dari Tanggal Sampai.', 'error');
      return;
    }

    lmSetStatus('Mengambil data laporan mutasi...', '');

    const { data, error } = await sb.rpc('rpc_laporan_mutasi_item', {
      d_from: dFrom,
      d_to: dTo
    });

    if (error) {
      console.error(error);
      lmSetStatus('Gagal mengambil laporan: ' + (error.message || error), 'error');
      return;
    }

    const rows = Array.isArray(data) ? data : [];
    if (rows.length === 0) {
      lmSetStatus('Tidak ada data untuk rentang tanggal ini.', '');
      return;
    }

    // Totals
    const totals = {
      saldo_awal_ekor: 0, saldo_awal_kg: 0,
      awal_ekor: 0, awal_kg: 0,
      abf_ekor: 0, abf_kg: 0,
      dari_lokasi_lain_ekor: 0, dari_lokasi_lain_kg: 0,
      chiller_ekor: 0, chiller_kg: 0,
      retur_ekor: 0, retur_kg: 0,
      jual_ekor: 0, jual_kg: 0,
      pindah_lokasi_ekor: 0, pindah_lokasi_kg: 0,
      reprocess_ekor: 0, reprocess_kg: 0,
      selisih_ekor: 0, selisih_kg: 0,
      rusak_ekor: 0, rusak_kg: 0,
      digabung_ekor: 0, digabung_kg: 0,
      gabungan_ekor: 0, gabungan_kg: 0,
      saldo_akhir_ekor: 0, saldo_akhir_kg: 0
    };

    const addNum = (k, v) => { totals[k] = Number(totals[k] ?? 0) + Number(v ?? 0); };

    rows.forEach(r => {
      addNum('saldo_awal_ekor', r.saldo_awal_ekor);
      addNum('saldo_awal_kg', r.saldo_awal_kg);

      addNum('awal_ekor', r.awal_ekor);
      addNum('awal_kg', r.awal_kg);

      addNum('abf_ekor', r.abf_ekor);
      addNum('abf_kg', r.abf_kg);

      addNum('dari_lokasi_lain_ekor', r.dari_lokasi_lain_ekor);
      addNum('dari_lokasi_lain_kg', r.dari_lokasi_lain_kg);

      addNum('chiller_ekor', r.chiller_ekor);
      addNum('chiller_kg', r.chiller_kg);

      addNum('retur_ekor', r.retur_ekor);
      addNum('retur_kg', r.retur_kg);

      addNum('jual_ekor', r.jual_ekor);
      addNum('jual_kg', r.jual_kg);

      addNum('pindah_lokasi_ekor', r.pindah_lokasi_ekor);
      addNum('pindah_lokasi_kg', r.pindah_lokasi_kg);

      addNum('reprocess_ekor', r.reprocess_ekor);
      addNum('reprocess_kg', r.reprocess_kg);

      addNum('selisih_ekor', r.selisih_ekor);
      addNum('selisih_kg', r.selisih_kg);

      addNum('rusak_ekor', r.rusak_ekor);
      addNum('rusak_kg', r.rusak_kg);

      addNum('digabung_ekor', r.digabung_ekor);
      addNum('digabung_kg', r.digabung_kg);

      addNum('gabungan_ekor', r.gabungan_ekor);
      addNum('gabungan_kg', r.gabungan_kg);

      addNum('saldo_akhir_ekor', r.saldo_akhir_ekor);
      addNum('saldo_akhir_kg', r.saldo_akhir_kg);
    });

    // Render rows
    rows.forEach(r => {
      const tr = document.createElement('tr');

      const tdItem = document.createElement('td');
      tdItem.textContent = r.item_name || r.item_id || '-';
      tr.appendChild(tdItem);

      const cells = [
        ['saldo_awal_ekor', true], ['saldo_awal_kg', false],
        ['awal_ekor', true], ['awal_kg', false],
        ['abf_ekor', true], ['abf_kg', false],
        ['dari_lokasi_lain_ekor', true], ['dari_lokasi_lain_kg', false],
        ['chiller_ekor', true], ['chiller_kg', false],
        ['retur_ekor', true], ['retur_kg', false],
        ['jual_ekor', true], ['jual_kg', false],
        ['pindah_lokasi_ekor', true], ['pindah_lokasi_kg', false],
        ['reprocess_ekor', true], ['reprocess_kg', false],
        ['selisih_ekor', true], ['selisih_kg', false],
        ['rusak_ekor', true], ['rusak_kg', false],
        ['digabung_ekor', true], ['digabung_kg', false],
        ['gabungan_ekor', true], ['gabungan_kg', false],
        ['saldo_akhir_ekor', true], ['saldo_akhir_kg', false]
      ];

      cells.forEach(([key, isInt]) => {
        const td = document.createElement('td');
        const v = r[key];
        td.textContent = isInt
          ? (Number(v ?? 0)).toLocaleString('id-ID')
          : lmKg2(v);
        tr.appendChild(td);
      });

      lmTbodyEl.appendChild(tr);
    });

    // Summary
    if (lmSummaryEl) {
      lmSummaryEl.style.display = 'block';
      lmSummaryEl.textContent =
        `Rentang: ${dFrom} s/d ${dTo}. Total Saldo Awal: ` +
        `${Number(totals.saldo_awal_ekor).toLocaleString('id-ID')} ekor | ${lmKg2(totals.saldo_awal_kg)} kg. ` +
        `Total Saldo Akhir: ${Number(totals.saldo_akhir_ekor).toLocaleString('id-ID')} ekor | ${lmKg2(totals.saldo_akhir_kg)} kg.`;
    }

    lmTableEl.style.display = 'table';
    lmSetStatus(`Sukses: ${rows.length.toLocaleString('id-ID')} item.`, 'success');
  }


// FORM REVISI KARUNG (ABF)
  // ==============================
  const RV_RPC_NAME = 'rpc_revisi_karung_overwrite_abf_log'; // nama RPC revisi overwrite ABF

  let revisiKarungInitialized = false;

  async function initRevisiKarungOnce() {
    if (revisiKarungInitialized) return;
    revisiKarungInitialized = true;

    const rvUserInfo = document.getElementById('rv-userInfo');
    const rvStatus   = document.getElementById('rv-status');

    const rvKarungId = document.getElementById('rv-karung-id');
    const rvBtnLoad  = document.getElementById('rv-btn-load');
    const rvBtnClear = document.getElementById('rv-btn-clear');

    const rvCurrentBox = document.getElementById('rv-current-box');

    const rvItem   = document.getElementById('rv-item');
    const rvTgl    = document.getElementById('rv-tgl-produksi');
    const rvEkor   = document.getElementById('rv-ekor');
    const rvKg     = document.getElementById('rv-kg');
    const rvBatch  = document.getElementById('rv-batch');
    const rvPallet = document.getElementById('rv-pallet');
    const rvKet    = document.getElementById('rv-ket');
    const rvSubmit = document.getElementById('rv-btn-submit');

    // Field legacy (batch/pallet) tidak dipakai untuk RPC overwrite ABF log
    if (rvBatch) {
      const row = rvBatch.closest('.field');
      if (row) row.style.display = 'none';
    }
    if (rvPallet) {
      const row = rvPallet.closest('.field');
      if (row) row.style.display = 'none';
    }


    // NOTE: File basis (index.html) tidak memiliki helper deriveEffectiveRole/hasRole.
    // Gunakan role apa adanya dari profile.
    const role = String((currentProfile && currentProfile.role) ? currentProfile.role : 'operator').toLowerCase();
    if (rvUserInfo && operatorDisplayName) {
      rvUserInfo.textContent = operatorDisplayName + (role ? ` (${role})` : '');
    }

    // hard-guard: hanya supervisor/admin boleh submit
    const canEdit = (role === 'admin' || role === 'supervisor');
    if (!canEdit) {
      rvStatus.textContent = 'Akses ditolak: hanya Supervisor/Admin yang bisa revisi.';
      rvStatus.className = 'status error';
      if (rvSubmit) rvSubmit.disabled = true;
    }

    function setStatus(msg, type) {
      if (!rvStatus) return;
      rvStatus.textContent = msg || '';
      rvStatus.className = 'status' + (type ? (' ' + type) : '');
    }

    function clearForm() {
      if (rvKarungId) rvKarungId.value = '';
      if (rvCurrentBox) { rvCurrentBox.style.display = 'none'; rvCurrentBox.textContent = ''; }
      if (rvItem) rvItem.value = '';
      if (rvTgl) rvTgl.value = '';
      if (rvEkor) rvEkor.value = '';
      if (rvKg) rvKg.value = '';
      if (rvBatch) rvBatch.value = '';
      if (rvPallet) rvPallet.value = '';
      if (rvKet) rvKet.value = '';
      setStatus('', '');
    }

    async function ensureItemsLoaded() {
      if (Array.isArray(items) && items.length > 0) return true;
      const { data: itemData, error: itemError } = await sb
        .from('items')
        .select('item_id, item_name')
        .order('item_name', { ascending: true });

      if (itemError) {
        console.error(itemError);
        setStatus('Gagal memuat items: ' + itemError.message, 'error');
        return false;
      }
      items = itemData || [];
      return true;
    }

    function populateRvItemSelect(selectedId) {
      if (!rvItem) return;
      rvItem.innerHTML = '';
      (items || []).forEach(it => {
        const opt = document.createElement('option');
        opt.value = it.item_id;
        opt.textContent = it.item_name;
        rvItem.appendChild(opt);
      });
      if (selectedId) rvItem.value = selectedId;
      if (!rvItem.value && rvItem.options.length > 0) rvItem.selectedIndex = 0;
    }

    async function loadKarung() {
      const kid = (rvKarungId && rvKarungId.value) ? rvKarungId.value.trim() : '';
      if (!kid) {
        setStatus('Isi karung_id terlebih dahulu.', 'error');
        return;
      }

      setStatus('Memuat data karung...', '');
      if (rvCurrentBox) { rvCurrentBox.style.display = 'none'; rvCurrentBox.textContent = ''; }

      const okItems = await ensureItemsLoaded();
      if (!okItems) return;

      // Ambil data dari stok_karung
      const { data: sk, error } = await sb
        .from('stok_karung')
        .select('karung_id, item_id, qty_ekor, qty_kg, qty_ekor_sisa, qty_kg_sisa, tgl_produksi, batch_pembekuan, status_karung, pallet_id')
        .eq('karung_id', kid)
        .maybeSingle();

      if (error) {
        console.error(error);
        setStatus('Gagal memuat karung: ' + error.message, 'error');
        return;
      }
      if (!sk) {
        setStatus('Karung tidak ditemukan: ' + kid, 'error');
        return;
      }

      // Render box "Data Saat Ini"
      if (rvCurrentBox) {
        const ekorSisa = Number(sk.qty_ekor_sisa ?? 0);
        const kgSisa = Number(sk.qty_kg_sisa ?? 0);
        rvCurrentBox.style.display = 'block';
        rvCurrentBox.textContent =
          `Karung: ${sk.karung_id}\n` +
          `Status: ${sk.status_karung || '-'}\n` +
          `Pallet: ${sk.pallet_id || '-'}\n` +
          `Tgl Produksi: ${sk.tgl_produksi || '-'}\n` +
          `Batch: ${sk.batch_pembekuan || '-'}\n` +
          `Sisa: ${ekorSisa} ekor, ${kgSisa.toFixed(2)} kg`;
      }

      // Prefill form revisi
      populateRvItemSelect(sk.item_id);
      if (rvTgl) rvTgl.value = (sk.tgl_produksi || '');
      if (rvEkor) rvEkor.value = (sk.qty_ekor ?? '');
      if (rvKg) rvKg.value = (sk.qty_kg ?? '');
      if (rvBatch) rvBatch.value = (sk.batch_pembekuan || '');
      if (rvPallet) rvPallet.value = (sk.pallet_id || '');

      setStatus('Data karung berhasil dimuat. Silakan isi perubahan lalu submit.', 'success');
    }

    async function syncKarungRakAbfTotals(karungId, newEkor, newKg) {
      try {
        // Ambil baris detail rak untuk karung ini
        const { data: rows, error } = await sb
          .from('karung_rak_abf')
          .select('rak_abf, qty_ekor, qty_kg')
          .eq('karung_id', karungId);

        if (error) throw error;
        if (!rows || rows.length === 0) return { updated: 0 };

        const totalKgOld = rows.reduce((a, r) => a + (Number(r.qty_kg) || 0), 0);
        const totalEkorOld = rows.reduce((a, r) => a + (Number(r.qty_ekor) || 0), 0);

        // Jika tidak ada basis pembagi, tidak bisa distribusi
        if (!(totalKgOld > 0) && !(totalEkorOld > 0)) return { updated: 0 };

        // Distribusi proporsional berdasarkan KG (lebih stabil). Jika totalKgOld = 0, fallback ke ekor.
        const useKg = (totalKgOld > 0);

        // Hitung alokasi baru per rak
        const alloc = rows.map(r => {
          const base = useKg ? (Number(r.qty_kg) || 0) : (Number(r.qty_ekor) || 0);
          const denom = useKg ? totalKgOld : totalEkorOld;
          const ratio = denom > 0 ? (base / denom) : 0;
          return {
            rak_abf: r.rak_abf,
            ratio
          };
        });

        // KG: numeric(10,2) -> 2 desimal, pastikan jumlah tetap sama (penyesuaian remainder ke baris pertama)
        let remainingKg = Number(newKg) || 0;
        let remainingEkor = (newEkor === null || typeof newEkor === 'undefined') ? null : (Number(newEkor) || 0);

        const updates = alloc.map((a, idx) => {
          let kg = 0;
          if (idx < alloc.length - 1) {
            kg = Math.round((remainingKg * a.ratio) * 100) / 100;
          } else {
            kg = Math.round(remainingKg * 100) / 100;
          }
          remainingKg = Math.round((remainingKg - kg) * 100) / 100;

          let ekor = null;
          if (remainingEkor !== null) {
            if (idx < alloc.length - 1) {
              ekor = Math.floor(remainingEkor * a.ratio);
            } else {
              ekor = remainingEkor;
            }
            remainingEkor = remainingEkor - (ekor || 0);
          }

          return { rak_abf: a.rak_abf, qty_kg: kg, qty_ekor: ekor };
        });

        // Jalankan update per rak_abf
        let updated = 0;
        for (const u of updates) {
          const patch = { qty_kg: u.qty_kg };
          if (u.qty_ekor !== null) patch.qty_ekor = u.qty_ekor;

          const { error: upErr } = await sb
            .from('karung_rak_abf')
            .update(patch)
            .eq('karung_id', karungId)
            .eq('rak_abf', u.rak_abf);

          if (upErr) throw upErr;
          updated += 1;
        }

        return { updated };
      } catch (e) {
        console.warn('Gagal sync karung_rak_abf:', e);
        return { updated: 0, error: e };
      }
    }

    function resetRevisiForm() {
    if (rvKarungId) rvKarungId.value = '';
    if (rvItem) rvItem.value = '';
    if (rvTgl) rvTgl.value = '';
    if (rvEkor) rvEkor.value = '';
    if (rvKg) rvKg.value = '';
    if (rvKet) rvKet.value = '';

    const infoBox = document.getElementById('rv-current-info');
    if (infoBox) infoBox.innerHTML = '';

    if (rvKarungId) rvKarungId.focus();
    }

    async function submitRevisi() {
      if (!canEdit) return;

      const kid = (rvKarungId && rvKarungId.value) ? rvKarungId.value.trim() : '';
      if (!kid) { setStatus('Karung ID wajib diisi.', 'error'); return; }

      const payload = {
        p_karung_id: kid,
        p_item_id_baru: rvItem ? rvItem.value : null,
        p_tgl_produksi_baru: rvTgl ? (rvTgl.value || null) : null,
        p_qty_ekor_baru: (rvEkor && String(rvEkor.value).trim() !== '') ? Number(rvEkor.value) : null,
        p_qty_kg_baru: rvKg ? Number(rvKg.value || 0) : 0,
        p_reason: rvKet ? (rvKet.value || '').trim() : '',
        p_supervisor_username: (currentUser && currentUser.email) ? currentUser.email : (operatorDisplayName || '')
      };


      if (!payload.p_item_id_baru) { setStatus('Item wajib dipilih.', 'error'); return; }
      if (!payload.p_tgl_produksi_baru) { setStatus('Tgl produksi wajib diisi.', 'error'); return; }
      if (!(payload.p_qty_kg_baru > 0)) { setStatus('Kg wajib > 0.', 'error'); return; }
      if (!payload.p_reason) { setStatus('Alasan revisi wajib diisi.', 'error'); return; }

      if (!confirm('Submit revisi untuk karung ini? Pastikan data benar.')) return;

      setStatus('Memproses revisi...', '');
      const { data, error } = await sb.rpc(RV_RPC_NAME, payload);

      if (error) {
        console.error(error);
        setStatus('Gagal revisi: ' + error.message, 'error');
        return;
      }

      setStatus('Data karung selesai direvisi. Harap print label dari Cek Info Karung.',
      'success'
      );

      // Sinkronkan total di karung_rak_abf (proporsional berdasarkan komposisi rak lama)
      const syncRes = await syncKarungRakAbfTotals(kid, payload.p_qty_ekor_baru, payload.p_qty_kg_baru);
      if (syncRes && syncRes.updated > 0) {
        setStatus('Revisi berhasil disimpan. Detail rak juga diperbarui. Harap print label dari Cek Info Karung.', 'success');
      }

      // reload data untuk memastikan yang tampil sudah terbaru
      resetRevisiForm();;
    }

    // attach listeners
    if (rvBtnLoad) rvBtnLoad.addEventListener('click', loadKarung);
    if (rvBtnClear) rvBtnClear.addEventListener('click', clearForm);
    if (rvKarungId) rvKarungId.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') loadKarung();
    });
    if (rvSubmit) rvSubmit.addEventListener('click', submitRevisi);

    // initial state
    await ensureItemsLoaded();
    populateRvItemSelect();
    setStatus('Form Revisi siap. Masukkan karung_id untuk mulai.', '');
  }



</script>
</body>
</html>